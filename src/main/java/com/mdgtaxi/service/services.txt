package com.mdgtaxi.service;

import com.mdgtaxi.entity.Chauffeur;
import com.mdgtaxi.entity.ChauffeurMouvementStatut;
import com.mdgtaxi.util.HibernateUtil;
import com.mdgtaxi.view.VmChauffeurActivite;
import com.mdgtaxi.view.VmChauffeurDetail;



import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

public class ChauffeurService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    // CRUD Operations for Chauffeur

    /**
     * Get chauffeur detail view by ID
     */
    public VmChauffeurDetail getChauffeurDetailById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(VmChauffeurDetail.class, id);
        } finally {
            em.close();
        }
    }

    /**
     * Get all chauffeur details
     */
    public List<VmChauffeurDetail> getAllChauffeurDetails() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<VmChauffeurDetail> query = em.createQuery(
                    "SELECT cd FROM VmChauffeurDetail cd",
                    VmChauffeurDetail.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    /**
     * Get chauffeur activity by ID
     */
    public VmChauffeurActivite getChauffeurActivite(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(VmChauffeurActivite.class, id);
        } finally {
            em.close();
        }
    }

    public Chauffeur createChauffeur(Chauffeur chauffeur) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(chauffeur);
            tx.commit();
            return chauffeur;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public Chauffeur getChauffeurById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(Chauffeur.class, id);
        } finally {
            em.close();
        }
    }

    public List<Chauffeur> getAllChauffeurs() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Chauffeur> query = em.createQuery("SELECT c FROM Chauffeur c", Chauffeur.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public Chauffeur updateChauffeur(Chauffeur chauffeur) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Chauffeur updated = em.merge(chauffeur);
            tx.commit();
            return updated;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public void deleteChauffeur(Long id) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Chauffeur chauffeur = em.find(Chauffeur.class, id);
            if (chauffeur != null) {
                em.remove(chauffeur);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }



    // Operations for Related Entities

    public ChauffeurMouvementStatut changeStatut(ChauffeurMouvementStatut mouvement) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(mouvement);
            tx.commit();
            return mouvement;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public List<ChauffeurMouvementStatut> getMouvementsByChauffeur(Long idChauffeur) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<ChauffeurMouvementStatut> query = em.createQuery(
                    "SELECT cms FROM ChauffeurMouvementStatut cms WHERE cms.chauffeur.id = :idChauffeur ORDER BY cms.dateMouvement DESC",
                    ChauffeurMouvementStatut.class);
            query.setParameter("idChauffeur", idChauffeur);
            return query.getResultList();
        } finally {
            em.close();
        }
    }


    public List<Chauffeur> searchChauffeursWithFilters(Map<String, Object> filters) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<Chauffeur> cq = cb.createQuery(Chauffeur.class);
            Root<Chauffeur> root = cq.from(Chauffeur.class);

            List<Predicate> predicates = new ArrayList<>();

            for (Map.Entry<String, Object> entry : filters.entrySet()) {
                String key = entry.getKey();
                Object value = entry.getValue();

                if (value == null) continue;

                switch (key) {
                    case "nom":
                        predicates.add(cb.equal(root.get("nom"), value));
                        break;
                    case "prenom":
                        predicates.add(cb.equal(root.get("prenom"), value));
                        break;
                    case "dateNaissance":
                        predicates.add(cb.equal(root.get("dateNaissance"), value));
                        break;
                    case "numeroPermis":
                        predicates.add(cb.equal(root.get("numeroPermis"), value));
                        break;
                    // Add more fields as needed
                    default:
                        // Ignore unknown filters
                        break;
                }
            }

            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            TypedQuery<Chauffeur> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }


}
package com.mdgtaxi.service;

import com.mdgtaxi.util.HibernateUtil;
import com.mdgtaxi.view.VmCAComplet;
import com.mdgtaxi.view.VmTrajetCaComplet;
import com.mdgtaxi.view.VmTrajetCaReel;
import com.mdgtaxi.view.VmTrajetPrevisionCaTotal;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.*;
import java.time.LocalDate;
import java.time.LocalTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

public class ChiffreAffaireService {
    
    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    // ===== VmTrajetPrevisionCaTotal =====
    
    public List<VmTrajetPrevisionCaTotal> getAllPrevisions() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<VmTrajetPrevisionCaTotal> query = em.createQuery(
                "SELECT v FROM VmTrajetPrevisionCaTotal v ORDER BY v.dateDepart DESC, v.heureDepart DESC",
                VmTrajetPrevisionCaTotal.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public VmTrajetPrevisionCaTotal getPrevisionByTrajetId(Long idTrajet) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(VmTrajetPrevisionCaTotal.class, idTrajet);
        } finally {
            em.close();
        }
    }

    public List<VmTrajetPrevisionCaTotal> searchPrevisions(Map<String, Object> filters) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<VmTrajetPrevisionCaTotal> cq = cb.createQuery(VmTrajetPrevisionCaTotal.class);
            Root<VmTrajetPrevisionCaTotal> root = cq.from(VmTrajetPrevisionCaTotal.class);

            List<Predicate> predicates = buildPredicates(cb, root, filters);

            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            cq.orderBy(cb.desc(root.get("dateDepart")), cb.desc(root.get("heureDepart")));

            TypedQuery<VmTrajetPrevisionCaTotal> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // ===== VmTrajetCaReel =====
    
    public List<VmTrajetCaReel> getAllCaReels() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<VmTrajetCaReel> query = em.createQuery(
                "SELECT v FROM VmTrajetCaReel v ORDER BY v.dateDepart DESC, v.heureDepart DESC",
                VmTrajetCaReel.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public VmTrajetCaReel getCaReelByTrajetId(Long idTrajet) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(VmTrajetCaReel.class, idTrajet);
        } finally {
            em.close();
        }
    }

    public List<VmTrajetCaReel> searchCaReels(Map<String, Object> filters) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<VmTrajetCaReel> cq = cb.createQuery(VmTrajetCaReel.class);
            Root<VmTrajetCaReel> root = cq.from(VmTrajetCaReel.class);

            List<Predicate> predicates = buildPredicates(cb, root, filters);

            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            cq.orderBy(cb.desc(root.get("dateDepart")), cb.desc(root.get("heureDepart")));

            TypedQuery<VmTrajetCaReel> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // ===== VmTrajetCaComplet =====
    
    public List<VmTrajetCaComplet> getAllCaComplets() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<VmTrajetCaComplet> query = em.createQuery(
                "SELECT v FROM VmTrajetCaComplet v ORDER BY v.dateDepart DESC, v.heureDepart DESC",
                VmTrajetCaComplet.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public VmTrajetCaComplet getCaCompletByTrajetId(Long idTrajet) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(VmTrajetCaComplet.class, idTrajet);
        } finally {
            em.close();
        }
    }

    public List<VmTrajetCaComplet> searchCaComplets(Map<String, Object> filters) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<VmTrajetCaComplet> cq = cb.createQuery(VmTrajetCaComplet.class);
            Root<VmTrajetCaComplet> root = cq.from(VmTrajetCaComplet.class);

            List<Predicate> predicates = buildPredicates(cb, root, filters);

            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            cq.orderBy(cb.desc(root.get("dateDepart")), cb.desc(root.get("heureDepart")));

            TypedQuery<VmTrajetCaComplet> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // ===== MÃ©thodes utilitaires =====
    
    private <T> List<Predicate> buildPredicates(CriteriaBuilder cb, Root<T> root, Map<String, Object> filters) {
        List<Predicate> predicates = new ArrayList<>();

        for (Map.Entry<String, Object> entry : filters.entrySet()) {
            String key = entry.getKey();
            Object value = entry.getValue();

            if (value == null) continue;

            switch (key) {
                case "idTrajet":
                    predicates.add(cb.equal(root.get("idTrajet"), value));
                    break;
                case "nomVilleDepart":
                    predicates.add(cb.like(cb.lower(root.get("nomVilleDepart")), "%" + value.toString().toLowerCase() + "%"));
                    break;
                case "nomVilleArrive":
                    predicates.add(cb.like(cb.lower(root.get("nomVilleArrive")), "%" + value.toString().toLowerCase() + "%"));
                    break;
                case "immatriculationVehicule":
                    predicates.add(cb.like(cb.lower(root.get("immatriculationVehicule")), "%" + value.toString().toLowerCase() + "%"));
                    break;
                case "dateDepart":
                    predicates.add(cb.equal(root.get("dateDepart"), value));
                    break;
                case "dateDepart>=":
                    predicates.add(cb.greaterThanOrEqualTo(root.get("dateDepart"), (LocalDate) value));
                    break;
                case "dateDepart<=":
                    predicates.add(cb.lessThanOrEqualTo(root.get("dateDepart"), (LocalDate) value));
                    break;
                case "heureDepart":
                    predicates.add(cb.equal(root.get("heureDepart"), value));
                    break;
                case "heureDepart>=":
                    predicates.add(cb.greaterThanOrEqualTo(root.get("heureDepart"), (LocalTime) value));
                    break;
                case "heureDepart<=":
                    predicates.add(cb.lessThanOrEqualTo(root.get("heureDepart"), (LocalTime) value));
                    break;
                default:
                    // Ignorer les filtres inconnus
                    break;
            }
        }

        return predicates;
    }

    public List<VmCAComplet> getCAPrevisionTotal(Integer mois, Integer annee) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<VmCAComplet> cq = cb.createQuery(VmCAComplet.class);
            Root<VmCAComplet> root = cq.from(VmCAComplet.class);

            List<Predicate> predicates = new ArrayList<>();

            if (mois != null) {
                predicates.add(cb.equal(root.get("mois"), mois));
            }
            if (annee != null) {
                predicates.add(cb.equal(root.get("annee"), annee));
            }

            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            TypedQuery<VmCAComplet> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.Client;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.TypedQuery;
import java.util.List;

public class ClientService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    public List<Client> getAllClients() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Client> query = em.createQuery("SELECT c FROM Client c", Client.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public Client createClient(Client client) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(client);
            tx.commit();
            return client;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.Configuration;
import com.mdgtaxi.entity.Unite;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.NoResultException;
import javax.persistence.TypedQuery;
import java.util.List;

public class ConfigurationService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    // CREATE
    public Configuration createConfiguration(Configuration configuration) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(configuration);
            tx.commit();
            return configuration;
        } catch (Exception e) {
            if (tx.isActive()) {
                tx.rollback();
            }
            throw e;
        } finally {
            em.close();
        }
    }

    // READ - by ID
    public Configuration getConfigurationById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(Configuration.class, id);
        } finally {
            em.close();
        }
    }

    // READ - by Code (la mÃ©thode demandÃ©e)
    public Configuration getByCode(String code) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Configuration> query = em.createQuery(
                "SELECT c FROM Configuration c WHERE c.code = :code",
                Configuration.class
            );
            query.setParameter("code", code);
            // On attend normalement 0 ou 1 rÃ©sultat
            return query.getSingleResult();
        } catch (NoResultException e) {
            return null;  // ou throw new EntityNotFoundException() selon votre convention
        } catch (Exception e) {
            throw e;
        } finally {
            em.close();
        }
    }

    // READ - all
    public List<Configuration> getAllConfigurations() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Configuration> query = em.createQuery(
                "SELECT c FROM Configuration c ORDER BY c.libelle ASC",
                Configuration.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // READ - by Unite (optionnel mais souvent utile)
    public List<Configuration> getConfigurationsByUnite(Long uniteId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Configuration> query = em.createQuery(
                "SELECT c FROM Configuration c WHERE c.unite.id = :uniteId ORDER BY c.libelle ASC",
                Configuration.class
            );
            query.setParameter("uniteId", uniteId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // UPDATE
    public Configuration updateConfiguration(Configuration configuration) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Configuration updated = em.merge(configuration);
            tx.commit();
            return updated;
        } catch (Exception e) {
            if (tx.isActive()) {
                tx.rollback();
            }
            throw e;
        } finally {
            em.close();
        }
    }

    // DELETE
    public void deleteConfiguration(Long id) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Configuration configuration = em.find(Configuration.class, id);
            if (configuration != null) {
                em.remove(configuration);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive()) {
                tx.rollback();
            }
            throw e;
        } finally {
            em.close();
        }
    }

    // MÃ©thode bonus : getValeurByCode (trÃ¨s pratique pour les paramÃ¨tres applicatifs)
    public String getValeurByCode(String code) {
        Configuration config = getByCode(code);
        return (config != null) ? config.getValeur() : null;
    }

    // Variante avec valeur par dÃ©faut
    public String getValeurByCode(String code, String defaultValue) {
        Configuration config = getByCode(code);
        return (config != null && config.getValeur() != null) 
            ? config.getValeur() 
            : defaultValue;
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.DiffusionDetail;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.*;
import java.util.List;

public class DiffusionDetailService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    // READ - by Diffusion ID
    public List<DiffusionDetail> getDetailsByDiffusionId(Long diffusionId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<DiffusionDetail> query = em.createQuery(
                    "SELECT dd FROM DiffusionDetail dd WHERE dd.diffusion.id = :diffusionId",
                    DiffusionDetail.class
            );
            query.setParameter("diffusionId", diffusionId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // READ - by ID
    public DiffusionDetail getDetailById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(DiffusionDetail.class, id);
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.*;
import com.mdgtaxi.util.HibernateUtil;
import com.mdgtaxi.view.VmDiffusionPaiement;

import javax.persistence.*;
import javax.persistence.criteria.*;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

public class DiffusionPaiementService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    /**
     * CrÃ©e un paiement et gÃ©nÃ¨re automatiquement la rÃ©partition proportionnelle
     * sur tous les dÃ©tails de diffusion associÃ©s
     */
    public DiffusionPaiement createPaiementAvecRepartition(DiffusionPaiement paiement) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();

            // Persister le paiement
            em.persist(paiement);
            em.flush(); // Pour obtenir l'ID gÃ©nÃ©rÃ©

            // RÃ©cupÃ©rer tous les dÃ©tails de diffusion pour cette diffusion
            TypedQuery<DiffusionDetail> query = em.createQuery(
                    "SELECT dd FROM DiffusionDetail dd WHERE dd.diffusion.id = :diffusionId",
                    DiffusionDetail.class
            );
            query.setParameter("diffusionId", paiement.getDiffusion().getId());
            List<DiffusionDetail> details = query.getResultList();

            if (details.isEmpty()) {
                throw new IllegalStateException("Aucun dÃ©tail de diffusion trouvÃ© pour la diffusion #"
                        + paiement.getDiffusion().getId());
            }

            // Calculer le montant total Ã  payer de la diffusion
            BigDecimal montantTotalDiffusion = BigDecimal.ZERO;
            for (DiffusionDetail detail : details) {
                BigDecimal montantDetail = detail.getMontantUnitaire()
                        .multiply(new BigDecimal(detail.getNombreRepetition()));
                montantTotalDiffusion = montantTotalDiffusion.add(montantDetail);
            }

            // Calculer le pourcentage payÃ©
            BigDecimal pourcentagePaye = paiement.getMontantPaye()
                    .divide(montantTotalDiffusion, 6, RoundingMode.HALF_UP)
                    .multiply(new BigDecimal(100));

            // CrÃ©er les rÃ©partitions pour chaque dÃ©tail
            BigDecimal totalReparti = BigDecimal.ZERO;
            int lastIndex = details.size() - 1;

            for (int i = 0; i < details.size(); i++) {
                DiffusionDetail detail = details.get(i);
                DiffusionPaiementRepartition repartition = new DiffusionPaiementRepartition();

                repartition.setDiffusiondDetail(detail);
                repartition.setDiffusionPaiement(paiement);
                repartition.setPourcentage(pourcentagePaye.doubleValue());

                // Calculer le montant pour ce dÃ©tail
                BigDecimal montantDetail = detail.getMontantUnitaire()
                        .multiply(new BigDecimal(detail.getNombreRepetition()));
                BigDecimal montantRepartition = montantDetail
                        .multiply(pourcentagePaye)
                        .divide(new BigDecimal(100), 2, RoundingMode.HALF_UP);

                // Ajustement pour le dernier Ã©lÃ©ment pour Ã©viter les erreurs d'arrondi
                if (i == lastIndex) {
                    montantRepartition = paiement.getMontantPaye().subtract(totalReparti);
                } else {
                    totalReparti = totalReparti.add(montantRepartition);
                }

                repartition.setMontantPaye(montantRepartition);
                em.persist(repartition);
            }

            tx.commit();
            return paiement;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // CREATE (ancienne mÃ©thode conservÃ©e pour compatibilitÃ©)
    public DiffusionPaiement createPaiement(DiffusionPaiement paiement) {
        return createPaiementAvecRepartition(paiement);
    }

    // READ - by ID
    public DiffusionPaiement getPaiementById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(DiffusionPaiement.class, id);
        } finally {
            em.close();
        }
    }

    // READ - all
    public List<DiffusionPaiement> getAllPaiements() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<DiffusionPaiement> query = em.createQuery(
                    "SELECT p FROM DiffusionPaiement p ORDER BY p.datePaiement DESC",
                    DiffusionPaiement.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // READ - by Diffusion ID
    public List<DiffusionPaiement> getPaiementsByDiffusionId(Long diffusionId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<DiffusionPaiement> query = em.createQuery(
                    "SELECT p FROM DiffusionPaiement p WHERE p.diffusion.id = :diffusionId ORDER BY p.datePaiement DESC",
                    DiffusionPaiement.class
            );
            query.setParameter("diffusionId", diffusionId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // READ - RÃ©partitions by Paiement ID
    public List<DiffusionPaiementRepartition> getRepartitionsByPaiementId(Long paiementId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<DiffusionPaiementRepartition> query = em.createQuery(
                    "SELECT r FROM DiffusionPaiementRepartition r " +
                            "WHERE r.diffusionPaiement.id = :paiementId",
                    DiffusionPaiementRepartition.class
            );
            query.setParameter("paiementId", paiementId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // READ - by Societe ID
    public List<DiffusionPaiement> getPaiementsBySocieteId(Long societeId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<DiffusionPaiement> query = em.createQuery(
                    "SELECT p FROM DiffusionPaiement p WHERE p.societe.id = :societeId ORDER BY p.datePaiement DESC",
                    DiffusionPaiement.class
            );
            query.setParameter("societeId", societeId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // UPDATE
    public DiffusionPaiement updatePaiement(DiffusionPaiement paiement) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            DiffusionPaiement updated = em.merge(paiement);
            tx.commit();
            return updated;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // DELETE
    public void deletePaiement(Long id) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            DiffusionPaiement paiement = em.find(DiffusionPaiement.class, id);
            if (paiement != null) {
                // Supprimer d'abord les rÃ©partitions
                Query deleteRepartitions = em.createQuery(
                        "DELETE FROM DiffusionPaiementRepartition r WHERE r.diffusionPaiement.id = :paiementId"
                );
                deleteRepartitions.setParameter("paiementId", id);
                deleteRepartitions.executeUpdate();

                // Puis supprimer le paiement
                em.remove(paiement);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // Get VmDiffusionPaiement with filters
    public List<VmDiffusionPaiement> getVmPaiements(Long idPublicite, List<Long> idSocietes, Long idTrajet,
                                                    Integer mois, Integer annee,
                                                    Integer nombreRepetitionMin, Integer nombreRepetitionMax) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<VmDiffusionPaiement> cq = cb.createQuery(VmDiffusionPaiement.class);
            Root<VmDiffusionPaiement> root = cq.from(VmDiffusionPaiement.class);

            List<Predicate> predicates = new ArrayList<>();

            if (idPublicite != null) {
                predicates.add(cb.equal(root.get("idPublicite"), idPublicite));
            }

            if (idSocietes != null && !idSocietes.isEmpty()) {
                predicates.add(root.get("idSociete").in(idSocietes));
            }

            if (idTrajet != null) {
                predicates.add(cb.equal(root.get("idTrajet"), idTrajet));
            }

            if (mois != null) {
                predicates.add(cb.equal(root.get("mois"), mois));
            }

            if (annee != null) {
                predicates.add(cb.equal(root.get("annee"), annee));
            }

            if (nombreRepetitionMin != null) {
                predicates.add(cb.greaterThanOrEqualTo(root.get("nombre"), nombreRepetitionMin));
            }

            if (nombreRepetitionMax != null) {
                predicates.add(cb.lessThanOrEqualTo(root.get("nombre"), nombreRepetitionMax));
            }

            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            cq.orderBy(cb.desc(root.get("idDiffusion")));

            TypedQuery<VmDiffusionPaiement> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // Get all VmDiffusionPaiement
    public List<VmDiffusionPaiement> getAllVmPaiements() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<VmDiffusionPaiement> query = em.createQuery(
                    "SELECT v FROM VmDiffusionPaiement v ORDER BY v.idDiffusion DESC",
                    VmDiffusionPaiement.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.Diffusion;
import com.mdgtaxi.util.HibernateUtil;
import com.mdgtaxi.view.VmDiffusionMensuelGlobal;
import com.mdgtaxi.view.VmDiffusionPaiement;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import java.util.ArrayList;
import java.util.List;

public class DiffusionService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    // CREATE
    public Diffusion createDiffusion(Diffusion diffusion) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(diffusion);
            tx.commit();
            return diffusion;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // READ - Get by ID
    public Diffusion getDiffusionById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(Diffusion.class, id);
        } finally {
            em.close();
        }
    }

    // READ - Get all
    public List<Diffusion> getAllDiffusions() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Diffusion> query = em.createQuery(
                    "SELECT d FROM Diffusion d ORDER BY d.id DESC",
                    Diffusion.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // READ - Get by Publicite ID
    public List<Diffusion> getDiffusionsByPubliciteId(Long publiciteId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Diffusion> query = em.createQuery(
                    "SELECT d FROM Diffusion d WHERE d.publicite.id = :publiciteId ORDER BY d.id DESC",
                    Diffusion.class
            );
            query.setParameter("publiciteId", publiciteId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // READ - Get by Trajet ID
    public List<Diffusion> getDiffusionsByTrajetId(Long trajetId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Diffusion> query = em.createQuery(
                    "SELECT d FROM Diffusion d WHERE d.trajet.id = :trajetId ORDER BY d.id DESC",
                    Diffusion.class
            );
            query.setParameter("trajetId", trajetId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // UPDATE
    public Diffusion updateDiffusion(Diffusion diffusion) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Diffusion updated = em.merge(diffusion);
            tx.commit();
            return updated;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // DELETE
    public void deleteDiffusion(Long id) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Diffusion diffusion = em.find(Diffusion.class, id);
            if (diffusion != null) {
                em.remove(diffusion);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // Fonction spÃ©cifique : getDiffusionMensuel avec filtrage
    public List<VmDiffusionMensuelGlobal> getDiffusionMensuel(Integer mois, Integer annee, 
                                                               Double montantMin, Double montantMax) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<VmDiffusionMensuelGlobal> cq = cb.createQuery(VmDiffusionMensuelGlobal.class);
            Root<VmDiffusionMensuelGlobal> root = cq.from(VmDiffusionMensuelGlobal.class);

            List<Predicate> predicates = new ArrayList<>();

            // Filtre sur le mois
            if (mois != null) {
                predicates.add(cb.equal(root.get("mois"), mois));
            }

            // Filtre sur l'annÃ©e
            if (annee != null) {
                predicates.add(cb.equal(root.get("annee"), annee));
            }

            // Filtre sur le montant minimum
            if (montantMin != null) {
                predicates.add(cb.greaterThanOrEqualTo(root.get("montantTotal"), montantMin));
            }

            // Filtre sur le montant maximum
            if (montantMax != null) {
                predicates.add(cb.lessThanOrEqualTo(root.get("montantTotal"), montantMax));
            }

            // Appliquer les prÃ©dicats
            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            // Tri par annÃ©e et mois dÃ©croissants
            cq.orderBy(cb.desc(root.get("annee")), cb.desc(root.get("mois")));

            TypedQuery<VmDiffusionMensuelGlobal> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // Fonction supplÃ©mentaire : obtenir toutes les statistiques mensuelles
    public List<VmDiffusionMensuelGlobal> getAllDiffusionMensuel() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<VmDiffusionMensuelGlobal> query = em.createQuery(
                    "SELECT v FROM VmDiffusionMensuelGlobal v ORDER BY v.annee DESC, v.mois DESC",
                    VmDiffusionMensuelGlobal.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // Fonction de filtrage avancÃ© des diffusions
    public List<Diffusion> getDiffusion(Long idPublicite, Long idSociete, Long idTrajet,
                                        Integer mois, Integer annee,
                                        Integer nombreRepetitionMin, Integer nombreRepetitionMax) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<Diffusion> cq = cb.createQuery(Diffusion.class);
            Root<Diffusion> root = cq.from(Diffusion.class);

            List<Predicate> predicates = new ArrayList<>();

            // Filtre sur la publicitÃ©
            if (idPublicite != null) {
                predicates.add(cb.equal(root.get("publicite").get("id"), idPublicite));
            }

            // Filtre sur la sociÃ©tÃ© (via publicitÃ©)
            if (idSociete != null) {
                predicates.add(cb.equal(root.get("publicite").get("societe").get("id"), idSociete));
            }

            // Filtre sur le trajet
            if (idTrajet != null) {
                predicates.add(cb.equal(root.get("trajet").get("id"), idTrajet));
            }

            // Filtre sur le mois (via trajet.datetimeDepart)
            if (mois != null) {
                predicates.add(cb.equal(
                    cb.function("MONTH", Integer.class, root.get("trajet").get("datetimeDepart")),
                    mois
                ));
            }

            // Filtre sur l'annÃ©e (via trajet.datetimeDepart)
            if (annee != null) {
                predicates.add(cb.equal(
                    cb.function("YEAR", Integer.class, root.get("trajet").get("datetimeDepart")),
                    annee
                ));
            }

            // Filtre sur le nombre minimum
            if (nombreRepetitionMin != null) {
                predicates.add(cb.greaterThanOrEqualTo(
                    cb.function("CAST", Integer.class, root.get("nombre")),
                    nombreRepetitionMin
                ));
            }

            // Filtre sur le nombre maximum
            if (nombreRepetitionMax != null) {
                predicates.add(cb.lessThanOrEqualTo(
                    cb.function("CAST", Integer.class, root.get("nombre")),
                    nombreRepetitionMax
                ));
            }

            // Appliquer les prÃ©dicats
            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            // Tri par ID dÃ©croissant
            cq.orderBy(cb.desc(root.get("id")));

            TypedQuery<Diffusion> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public List<VmDiffusionPaiement> getDiffusionPaiements(Long idPublicite, List<Long> idSocietes, Long idTrajet,
                                                           Integer mois, Integer annee,
                                                           Integer nombreRepetitionMin, Integer nombreRepetitionMax) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<VmDiffusionPaiement> cq = cb.createQuery(VmDiffusionPaiement.class);
            Root<VmDiffusionPaiement> root = cq.from(VmDiffusionPaiement.class);

            List<Predicate> predicates = new ArrayList<>();

            // Filtre sur la publicitÃ©
            if (idPublicite != null) {
                predicates.add(cb.equal(root.get("idPublicite"), idPublicite));
            }

            // Filtre sur les sociÃ©tÃ©s (multiple)
            if (idSocietes != null && !idSocietes.isEmpty()) {
                predicates.add(root.get("idSociete").in(idSocietes));
            }

            // Filtre sur le trajet
            if (idTrajet != null) {
                predicates.add(cb.equal(root.get("idTrajet"), idTrajet));
            }

            // Filtre sur le mois
            if (mois != null) {
                predicates.add(cb.equal(root.get("mois"), mois));
            }

            // Filtre sur l'annÃ©e
            if (annee != null) {
                predicates.add(cb.equal(root.get("annee"), annee));
            }

            // Filtre sur le nombre minimum
            if (nombreRepetitionMin != null) {
                predicates.add(cb.greaterThanOrEqualTo(root.get("nombre"), nombreRepetitionMin));
            }

            // Filtre sur le nombre maximum
            if (nombreRepetitionMax != null) {
                predicates.add(cb.lessThanOrEqualTo(root.get("nombre"), nombreRepetitionMax));
            }

            // Appliquer les prÃ©dicats
            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            // Tri par ID diffusion dÃ©croissant
            cq.orderBy(cb.desc(root.get("idDiffusion")));

            TypedQuery<VmDiffusionPaiement> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.dto.EntityDetailWithStatusDto;
import com.mdgtaxi.dto.EntityListWithStatusDto;
import com.mdgtaxi.dto.EntityStatusCriteria;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.TypedQuery;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

/**
 * Service pour rÃ©cupÃ©rer des entitÃ©s avec leurs statuts selon diffÃ©rents critÃ¨res
 * Supporte: Chauffeur, Vehicule, Trajet, Trajet_Reservation
 */
public class EntityStatusService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    /**
     * RÃ©cupÃ¨re toutes les entitÃ©s avec leur statut Ã  une date donnÃ©e
     * @param tableName Nom de la table (Chauffeur, Vehicule, Trajet, Trajet_Reservation)
     * @param date Date (null = maintenant)
     * @return EntityListWithStatusDto contenant toutes les entitÃ©s avec leurs statuts
     */
    public EntityListWithStatusDto getAllEntitiesWithStatusAtDate(String tableName, LocalDateTime date) {
        if (date == null) {
            date = LocalDateTime.now();
        }

        String entityName = getEntityName(tableName);
        String mouvementEntity = getMouvementEntityName(tableName);
        String statusEntity = getStatusEntityName(tableName);
        String idField = getIdFieldName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            // RequÃªte pour rÃ©cupÃ©rer les entitÃ©s avec leur statut actuel
            String jpql = "SELECT e, s.id, s.libelle, s.score, s.spanHtml " +
                    "FROM " + entityName + " e " +
                    "LEFT JOIN " + mouvementEntity + " m ON e.id = m." + idField + " " +
                    "LEFT JOIN " + statusEntity + " s ON m.nouveauStatut.id = s.id " +
                    "WHERE m.dateMouvement = (" +
                    "  SELECT MAX(m2.dateMouvement) " +
                    "  FROM " + mouvementEntity + " m2 " +
                    "  WHERE m2." + idField + " = e.id " +
                    "  AND m2.dateMouvement <= :date" +
                    ") " +
                    "OR NOT EXISTS (" +
                    "  SELECT 1 FROM " + mouvementEntity + " m3 " +
                    "  WHERE m3." + idField + " = e.id" +
                    ")";

            TypedQuery<Object[]> query = em.createQuery(jpql, Object[].class);
            query.setParameter("date", date);
            List<Object[]> results = query.getResultList();

            List<EntityDetailWithStatusDto> entities = new ArrayList<>();
            for (Object[] row : results) {
                entities.add(new EntityDetailWithStatusDto(
                        row[0],  // entity
                        (Long) row[1],  // idStatut
                        (String) row[2],  // libelleStatut
                        (Integer) row[3],  // scoreStatut
                        (String) row[4]  // spanHtmlStatut
                ));
            }

            return new EntityListWithStatusDto(entities, date, (long) entities.size());
        } finally {
            em.close();
        }
    }

    /**
     * RÃ©cupÃ¨re les entitÃ©s selon des critÃ¨res de statut multiples
     * @param tableName Nom de la table
     * @param criteria CritÃ¨res de recherche (libellÃ©, score min/max, date)
     * @return EntityListWithStatusDto contenant les entitÃ©s filtrÃ©es
     */
    public EntityListWithStatusDto getEntitiesByCriteria(String tableName, EntityStatusCriteria criteria) {
        LocalDateTime effectiveDate = criteria.getEffectiveDate();

        String entityName = getEntityName(tableName);
        String mouvementEntity = getMouvementEntityName(tableName);
        String statusEntity = getStatusEntityName(tableName);
        String idField = getIdFieldName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            // Construction dynamique de la requÃªte avec les critÃ¨res
            StringBuilder jpql = new StringBuilder();
            jpql.append("SELECT e, s.id, s.libelle, s.score, s.spanHtml ")
                    .append("FROM ").append(entityName).append(" e ")
                    .append("INNER JOIN ").append(mouvementEntity).append(" m ON e.id = m.").append(idField).append(" ")
                    .append("INNER JOIN ").append(statusEntity).append(" s ON m.nouveauStatut.id = s.id ")
                    .append("WHERE m.dateMouvement <= :date ")
                    .append("AND m.dateMouvement = (")
                    .append("  SELECT MAX(m2.dateMouvement) ")
                    .append("  FROM ").append(mouvementEntity).append(" m2 ")
                    .append("  WHERE m2.").append(idField).append(" = e.id ")
                    .append("  AND m2.dateMouvement <= :date")
                    .append(") ");

            // Ajout des critÃ¨res de filtre
            boolean hasStatusCriteria = false;

            if (criteria.getLibelleStatut() != null && !criteria.getLibelleStatut().isEmpty()) {
                jpql.append("AND s.libelle = :libelle ");
                hasStatusCriteria = true;
            }

            if (criteria.getExactScore() != null) {
                jpql.append("AND s.score = :exactScore ");
                hasStatusCriteria = true;
            } else {
                if (criteria.getMinScore() != null) {
                    jpql.append("AND s.score >= :minScore ");
                    hasStatusCriteria = true;
                }
                if (criteria.getMaxScore() != null) {
                    jpql.append("AND s.score <= :maxScore ");
                    hasStatusCriteria = true;
                }
            }

            TypedQuery<Object[]> query = em.createQuery(jpql.toString(), Object[].class);
            query.setParameter("date", effectiveDate);

            if (criteria.getLibelleStatut() != null && !criteria.getLibelleStatut().isEmpty()) {
                query.setParameter("libelle", criteria.getLibelleStatut());
            }
            if (criteria.getExactScore() != null) {
                query.setParameter("exactScore", criteria.getExactScore());
            } else {
                if (criteria.getMinScore() != null) {
                    query.setParameter("minScore", criteria.getMinScore());
                }
                if (criteria.getMaxScore() != null) {
                    query.setParameter("maxScore", criteria.getMaxScore());
                }
            }

            List<Object[]> results = query.getResultList();
            List<EntityDetailWithStatusDto> entities = new ArrayList<>();

            for (Object[] row : results) {
                entities.add(new EntityDetailWithStatusDto(
                        row[0],  // entity
                        (Long) row[1],  // idStatut
                        (String) row[2],  // libelleStatut
                        (Integer) row[3],  // scoreStatut
                        (String) row[4]  // spanHtmlStatut
                ));
            }

            return new EntityListWithStatusDto(entities, effectiveDate, (long) entities.size());
        } finally {
            em.close();
        }
    }

    /**
     * RÃ©cupÃ¨re les entitÃ©s par libellÃ© de statut Ã  une date donnÃ©e
     * @param tableName Nom de la table
     * @param libelleStatut LibellÃ© du statut
     * @param date Date (null = maintenant)
     * @return EntityListWithStatusDto
     */
    public EntityListWithStatusDto getEntitiesByLibelleStatut(String tableName, String libelleStatut, LocalDateTime date) {
        EntityStatusCriteria criteria = EntityStatusCriteria.builder()
                .libelleStatut(libelleStatut)
                .atDate(date)
                .build();
        return getEntitiesByCriteria(tableName, criteria);
    }

    /**
     * RÃ©cupÃ¨re les entitÃ©s par score exact Ã  une date donnÃ©e
     * @param tableName Nom de la table
     * @param score Score exact
     * @param date Date (null = maintenant)
     * @return EntityListWithStatusDto
     */
    public EntityListWithStatusDto getEntitiesByExactScore(String tableName, int score, LocalDateTime date) {
        EntityStatusCriteria criteria = EntityStatusCriteria.builder()
                .exactScore(score)
                .atDate(date)
                .build();
        return getEntitiesByCriteria(tableName, criteria);
    }

    /**
     * RÃ©cupÃ¨re les entitÃ©s par plage de scores Ã  une date donnÃ©e
     * @param tableName Nom de la table
     * @param minScore Score minimum (null = pas de minimum)
     * @param maxScore Score maximum (null = pas de maximum)
     * @param date Date (null = maintenant)
     * @return EntityListWithStatusDto
     */
    public EntityListWithStatusDto getEntitiesByScoreRange(String tableName, Integer minScore, Integer maxScore, LocalDateTime date) {
        EntityStatusCriteria criteria = EntityStatusCriteria.builder()
                .minScore(minScore)
                .maxScore(maxScore)
                .atDate(date)
                .build();
        return getEntitiesByCriteria(tableName, criteria);
    }

    /**
     * Compte le nombre d'entitÃ©s par statut Ã  une date donnÃ©e
     * @param tableName Nom de la table
     * @param date Date (null = maintenant)
     * @return Liste de tableaux [libelle_statut, count]
     */
    public List<Object[]> countEntitiesByStatusAtDate(String tableName, LocalDateTime date) {
        if (date == null) {
            date = LocalDateTime.now();
        }

        String mouvementEntity = getMouvementEntityName(tableName);
        String statusEntity = getStatusEntityName(tableName);
        String idField = getIdFieldName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT s.libelle, COUNT(DISTINCT m." + idField + ") " +
                    "FROM " + mouvementEntity + " m " +
                    "INNER JOIN " + statusEntity + " s ON m.nouveauStatut.id = s.id " +
                    "WHERE m.dateMouvement <= :date " +
                    "AND m.dateMouvement = (" +
                    "  SELECT MAX(m2.dateMouvement) " +
                    "  FROM " + mouvementEntity + " m2 " +
                    "  WHERE m2." + idField + " = m." + idField + " " +
                    "  AND m2.dateMouvement <= :date" +
                    ") " +
                    "GROUP BY s.libelle, s.score " +
                    "ORDER BY s.score";

            TypedQuery<Object[]> query = em.createQuery(jpql, Object[].class);
            query.setParameter("date", date);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // MÃ©thodes de mapping

    private String getEntityName(String tableName) {
        return switch (tableName) {
            case "Chauffeur" -> "Chauffeur";
            case "Vehicule" -> "Vehicule";
            case "Trajet" -> "Trajet";
            case "Trajet_Reservation" -> "TrajetReservation";
            default -> throw new IllegalArgumentException("Table non supportÃ©e: " + tableName);
        };
    }

    private String getMouvementEntityName(String tableName) {
        return switch (tableName) {
            case "Chauffeur" -> "ChauffeurMouvementStatut";
            case "Vehicule" -> "VehiculeMouvementStatut";
            case "Trajet" -> "TrajetMouvementStatut";
            case "Trajet_Reservation" -> "TrajetReservationMouvementStatut";
            default -> throw new IllegalArgumentException("Table non supportÃ©e: " + tableName);
        };
    }

    private String getStatusEntityName(String tableName) {
        return switch (tableName) {
            case "Chauffeur" -> "ChauffeurStatut";
            case "Vehicule" -> "VehiculeStatut";
            case "Trajet" -> "TrajetStatut";
            case "Trajet_Reservation" -> "ReservationStatut";
            default -> throw new IllegalArgumentException("Table non supportÃ©e: " + tableName);
        };
    }

    private String getIdFieldName(String tableName) {
        return switch (tableName) {
            case "Chauffeur" -> "chauffeur.id";
            case "Vehicule" -> "vehicule.id";
            case "Trajet" -> "trajet.id";
            case "Trajet_Reservation" -> "trajetReservation.id";
            default -> throw new IllegalArgumentException("Table non supportÃ©e: " + tableName);
        };
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.Ligne;
import com.mdgtaxi.entity.LigneDetail;
import com.mdgtaxi.entity.Trajet;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import java.math.BigDecimal;
import java.util.List;
import java.util.Map;
import java.util.ArrayList;

public class LigneService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    public List<LigneDetail> getLigneDetailList (Long idLigne) {

        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<LigneDetail> query = em.createQuery(
                    "SELECT l FROM LigneDetail l WHERE l.ligne.id = :ligneId",
                    LigneDetail.class
            );
            query.setParameter("ligneId", idLigne);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public List<Ligne> searchLignesWithFilters(Map<String, Object> filters) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<Ligne> cq = cb.createQuery(Ligne.class);
            Root<Ligne> root = cq.from(Ligne.class);

            List<Predicate> predicates = new ArrayList<>();

            for (Map.Entry<String, Object> entry : filters.entrySet()) {
                String key = entry.getKey();
                Object value = entry.getValue();

                if (value == null) continue;

                switch (key) {
                    case "distanceKm":
                        predicates.add(cb.equal(root.get("distanceKm"), value));
                        break;
                    case "distanceKm>=":
                        predicates.add(cb.greaterThanOrEqualTo(root.get("distanceKm"), (BigDecimal) value));
                        break;
                    case "distanceKm<=":
                        predicates.add(cb.lessThanOrEqualTo(root.get("distanceKm"), (BigDecimal) value));
                        break;
                    case "villeDepart.id":
                        predicates.add(cb.equal(root.get("villeDepart").get("id"), value));
                        break;
                    case "villeArrivee.id":
                        predicates.add(cb.equal(root.get("villeArrivee").get("id"), value));
                        break;
                    default:
                        // Ignore unknown filters
                        break;
                }
            }

            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            TypedQuery<Ligne> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public Ligne createLigne(Ligne ligne) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(ligne);
            tx.commit();
            return ligne;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public Ligne getLigneById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(Ligne.class, id);
        } finally {
            em.close();
        }
    }

    public List<Ligne> getAllLignes() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Ligne> query = em.createQuery("SELECT l FROM Ligne l", Ligne.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public Ligne updateLigne(Ligne ligne) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Ligne updated = em.merge(ligne);
            tx.commit();
            return updated;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public void deleteLigne(Long id) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Ligne ligne = em.find(Ligne.class, id);
            if (ligne != null) {
                em.remove(ligne);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.*;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.time.LocalDateTime;

public class MouvementStatusCreateService {
    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    /**
     * Creates a new mouvement statut for the given entity.
     * Updates the entity's current statut field if applicable.
     *
     * @param tableName      Name of the table (e.g., "Chauffeur", "Vehicule",
     *                       "Trajet", "Trajet_Reservation")
     * @param idEntity       ID of the entity
     * @param idNewStatut    ID of the new statut
     * @param dateChangement Date of the changement
     * @param observation    Optional observation
     * @return The created mouvement statut object
     */
    public Object createMouvementStatut(String tableName, Long idEntity, Long idNewStatut, LocalDateTime dateChangement,
            String observation) {
        Class<?> entityClass = null;
        Class<?> mouvementClass = null;
        Class<?> statutClass = null;
        String entityField = null;
        boolean hasStatutField = false;
        String statutFieldName = null;

        if ("Chauffeur".equals(tableName)) {
            entityClass = Chauffeur.class;
            mouvementClass = ChauffeurMouvementStatut.class;
            statutClass = ChauffeurStatut.class;
            entityField = "chauffeur";
            hasStatutField = false;
        } else if ("Vehicule".equals(tableName)) {
            entityClass = Vehicule.class;
            mouvementClass = VehiculeMouvementStatut.class;
            statutClass = VehiculeStatut.class;
            entityField = "vehicule";
            hasStatutField = false;
        } else if ("Trajet".equals(tableName)) {
            entityClass = Trajet.class;
            mouvementClass = TrajetMouvementStatut.class;
            statutClass = TrajetStatut.class;
            entityField = "trajet";
            hasStatutField = true;
            statutFieldName = "trajetStatut";
        } else if ("Trajet_Reservation".equals(tableName)) {
            entityClass = TrajetReservation.class;
            mouvementClass = TrajetReservationMouvementStatut.class;
            statutClass = ReservationStatut.class;
            entityField = "trajetReservation";
            hasStatutField = true;
            statutFieldName = "reservationStatut";
        } else {
            throw new IllegalArgumentException("Unsupported tableName: " + tableName);
        }

        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();

            // Find the entity
            Object entity = em.find(entityClass, idEntity);
            if (entity == null) {
                throw new IllegalArgumentException("Entity not found with id: " + idEntity);
            }

            // Find the new statut
            Object newStatut = em.find(statutClass, idNewStatut);
            if (newStatut == null) {
                throw new IllegalArgumentException("Statut not found with id: " + idNewStatut);
            }

            // Create new mouvement instance
            Object mouvement = mouvementClass.getConstructor().newInstance();

            // Set entity
            Method setEntity = mouvementClass.getMethod("set" + capitalize(entityField), entityClass);
            setEntity.invoke(mouvement, entity);

            // Set nouveauStatut
            Method setNouveauStatut = mouvementClass.getMethod("setNouveauStatut", statutClass);
            setNouveauStatut.invoke(mouvement, newStatut);

            // Set dateMouvement
            Method setDateMouvement = mouvementClass.getMethod("setDateMouvement", LocalDateTime.class);
            setDateMouvement.invoke(mouvement, dateChangement);

            // Set observation
            Method setObservation = mouvementClass.getMethod("setObservation", String.class);
            setObservation.invoke(mouvement, observation);

            // Persist the mouvement
            em.persist(mouvement);

            // If the entity has a direct statut field, update it
            if (hasStatutField) {
                Method setStatut = entityClass.getMethod("set" + capitalize(statutFieldName), statutClass);
                setStatut.invoke(entity, newStatut);
            }

            tx.commit();
            return mouvement;
        } catch (InvocationTargetException | IllegalAccessException | NoSuchMethodException
                | InstantiationException e) {
            if (tx.isActive())
                tx.rollback();
            throw new RuntimeException("Reflection error: " + e.getMessage(), e);
        } finally {
            em.close();
        }
    }

    private String capitalize(String str) {
        if (str == null || str.isEmpty()) {
            return str;
        }
        return str.substring(0, 1).toUpperCase() + str.substring(1);
    }

}
package com.mdgtaxi.service;

import com.mdgtaxi.dto.MouvementStatusCriteria;
import com.mdgtaxi.dto.MouvementStatusDto;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.TypedQuery;
import java.time.LocalDateTime;
import java.util.List;

/**
 * Service pour gÃ©rer les mouvements de statut individuels
 * Supporte: Chauffeur, Vehicule, Trajet, Trajet_Reservation
 */
public class MouvementStatusService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    /**
     * RÃ©cupÃ¨re le statut actuel d'une entitÃ©
     * 
     * @param tableName Nom de la table (Chauffeur, Vehicule, Trajet,
     *                  Trajet_Reservation)
     * @param idEntite  ID de l'entitÃ©
     * @return Le statut actuel ou null
     */
    public MouvementStatusDto getCurrentStatus(String tableName, Long idEntite) {
        return getStatusAtDate(tableName, idEntite, LocalDateTime.now());
    }

    /**
     * RÃ©cupÃ¨re le statut d'une entitÃ© Ã  une date donnÃ©e
     * 
     * @param tableName Nom de la table
     * @param idEntite  ID de l'entitÃ©
     * @param date      Date Ã  laquelle on veut connaÃ®tre le statut
     * @return Le statut Ã  cette date ou null
     */
    public MouvementStatusDto getStatusAtDate(String tableName, Long idEntite, LocalDateTime date) {
        String mouvementEntity = getMouvementEntityName(tableName);
        String statusEntity = getStatusEntityName(tableName);
        String idField = getIdFieldName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT new com.mdgtaxi.dto.MouvementStatusDto(" +
                    "m.id, " +
                    "m." + idField + ", " +
                    "'" + tableName + "', " +
                    "s.id, " +
                    "s.libelle, " +
                    "s.score, " +
                    "s.spanHtml, " +
                    "m.dateMouvement, " +
                    "m.observation) " +
                    "FROM " + mouvementEntity + " m " +
                    "INNER JOIN " + statusEntity + " s ON m.nouveauStatut.id = s.id " +
                    "WHERE m." + idField + " = :idEntite " +
                    "AND m.dateMouvement <= :date " +
                    "ORDER BY m.dateMouvement DESC";

            TypedQuery<MouvementStatusDto> query = em.createQuery(jpql, MouvementStatusDto.class);
            query.setParameter("idEntite", idEntite);
            query.setParameter("date", date);
            query.setMaxResults(1);

            List<MouvementStatusDto> results = query.getResultList();
            return results.isEmpty() ? null : results.get(0);
        } finally {
            em.close();
        }
    }

    /**
     * RÃ©cupÃ¨re l'historique complet des mouvements de statut
     * 
     * @param tableName Nom de la table
     * @param idEntite  ID de l'entitÃ©
     * @return Liste des mouvements ordonnÃ©s par date dÃ©croissante
     */
    public List<MouvementStatusDto> getStatusHistory(String tableName, Long idEntite) {
        String mouvementEntity = getMouvementEntityName(tableName);
        String statusEntity = getStatusEntityName(tableName);
        String idField = getIdFieldName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT new com.mdgtaxi.dto.MouvementStatusDto(" +
                    "m.id, " +
                    "m." + idField + ", " +
                    "'" + tableName + "', " +
                    "s.id, " +
                    "s.libelle, " +
                    "s.score, " +
                    "s.spanHtml, " +
                    "m.dateMouvement, " +
                    "m.observation) " +
                    "FROM " + mouvementEntity + " m " +
                    "INNER JOIN " + statusEntity + " s ON m.nouveauStatut.id = s.id " +
                    "WHERE m." + idField + " = :idEntite " +
                    "ORDER BY m.dateMouvement DESC";

            TypedQuery<MouvementStatusDto> query = em.createQuery(jpql, MouvementStatusDto.class);
            query.setParameter("idEntite", idEntite);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    /**
     * RÃ©cupÃ¨re les mouvements de statut selon des critÃ¨res multiples
     * 
     * @param tableName Nom de la table
     * @param criteria  CritÃ¨res de recherche
     * @return Liste des mouvements filtrÃ©s ordonnÃ©s par date dÃ©croissante
     */
    public List<MouvementStatusDto> getMouvementsByCriteria(String tableName, MouvementStatusCriteria criteria) {
        String mouvementEntity = getMouvementEntityName(tableName);
        String statusEntity = getStatusEntityName(tableName);
        String idField = getIdFieldName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            StringBuilder jpql = new StringBuilder();
            jpql.append("SELECT new com.mdgtaxi.dto.MouvementStatusDto(")
                    .append("m.id, ")
                    .append("m.").append(idField).append(", ")
                    .append("'").append(tableName).append("', ")
                    .append("s.id, ")
                    .append("s.libelle, ")
                    .append("s.score, ")
                    .append("s.spanHtml, ")
                    .append("m.dateMouvement, ")
                    .append("m.observation) ")
                    .append("FROM ").append(mouvementEntity).append(" m ")
                    .append("INNER JOIN ").append(statusEntity).append(" s ON m.nouveauStatut.id = s.id ")
                    .append("WHERE 1=1 ");

            // Filtre par ID d'entitÃ©
            if (criteria.getIdEntite() != null) {
                jpql.append("AND m.").append(idField).append(" = :idEntite ");
            }

            // Filtre par libellÃ© nouveau statut
            if (criteria.getLibelleNouveauStatut() != null && !criteria.getLibelleNouveauStatut().isEmpty()) {
                jpql.append("AND s.libelle = :libelleNouveau ");
            }

            // Filtres par score nouveau statut
            if (criteria.getExactScoreNouveau() != null) {
                jpql.append("AND s.score = :exactScoreNouveau ");
            } else {
                if (criteria.getMinScoreNouveau() != null) {
                    jpql.append("AND s.score >= :minScoreNouveau ");
                }
                if (criteria.getMaxScoreNouveau() != null) {
                    jpql.append("AND s.score <= :maxScoreNouveau ");
                }
            }

            // Filtre par plage de dates
            if (criteria.getDateDebut() != null) {
                jpql.append("AND m.dateMouvement >= :dateDebut ");
            }
            if (criteria.getDateFin() != null) {
                jpql.append("AND m.dateMouvement <= :dateFin ");
            }

            // Filtre par observation
            if (criteria.getObservationContains() != null && !criteria.getObservationContains().isEmpty()) {
                jpql.append("AND LOWER(m.observation) LIKE LOWER(:observation) ");
            }

            jpql.append("ORDER BY m.dateMouvement DESC");

            TypedQuery<MouvementStatusDto> query = em.createQuery(jpql.toString(), MouvementStatusDto.class);

            // ParamÃ©trage de la requÃªte
            if (criteria.getIdEntite() != null) {
                query.setParameter("idEntite", criteria.getIdEntite());
            }
            if (criteria.getLibelleNouveauStatut() != null && !criteria.getLibelleNouveauStatut().isEmpty()) {
                query.setParameter("libelleNouveau", criteria.getLibelleNouveauStatut());
            }
            if (criteria.getExactScoreNouveau() != null) {
                query.setParameter("exactScoreNouveau", criteria.getExactScoreNouveau());
            } else {
                if (criteria.getMinScoreNouveau() != null) {
                    query.setParameter("minScoreNouveau", criteria.getMinScoreNouveau());
                }
                if (criteria.getMaxScoreNouveau() != null) {
                    query.setParameter("maxScoreNouveau", criteria.getMaxScoreNouveau());
                }
            }
            if (criteria.getDateDebut() != null) {
                query.setParameter("dateDebut", criteria.getDateDebut());
            }
            if (criteria.getDateFin() != null) {
                query.setParameter("dateFin", criteria.getDateFin());
            }
            if (criteria.getObservationContains() != null && !criteria.getObservationContains().isEmpty()) {
                query.setParameter("observation", "%" + criteria.getObservationContains() + "%");
            }

            return query.getResultList();
        } finally {
            em.close();
        }
    }

    /**
     * RÃ©cupÃ¨re tous les mouvements pour une table (sans filtre d'entitÃ© spÃ©cifique)
     * 
     * @param tableName Nom de la table
     * @return Liste de tous les mouvements
     */
    public List<MouvementStatusDto> getAllMouvements(String tableName) {
        MouvementStatusCriteria criteria = MouvementStatusCriteria.builder().build();
        return getMouvementsByCriteria(tableName, criteria);
    }

    /**
     * RÃ©cupÃ¨re les mouvements dans une pÃ©riode donnÃ©e
     * 
     * @param tableName Nom de la table
     * @param dateDebut Date de dÃ©but
     * @param dateFin   Date de fin
     * @return Liste des mouvements dans la pÃ©riode
     */
    public List<MouvementStatusDto> getMouvementsByPeriod(String tableName, LocalDateTime dateDebut,
            LocalDateTime dateFin) {
        MouvementStatusCriteria criteria = MouvementStatusCriteria.builder()
                .dateDebut(dateDebut)
                .dateFin(dateFin)
                .build();
        return getMouvementsByCriteria(tableName, criteria);
    }

    /**
     * RÃ©cupÃ¨re les mouvements vers un statut spÃ©cifique
     * 
     * @param tableName            Nom de la table
     * @param libelleNouveauStatut LibellÃ© du nouveau statut
     * @return Liste des mouvements vers ce statut
     */
    public List<MouvementStatusDto> getMouvementsToStatus(String tableName, String libelleNouveauStatut) {
        MouvementStatusCriteria criteria = MouvementStatusCriteria.builder()
                .libelleNouveauStatut(libelleNouveauStatut)
                .build();
        return getMouvementsByCriteria(tableName, criteria);
    }

    // MÃ©thodes de mapping

    private String getMouvementEntityName(String tableName) {
        return switch (tableName) {
            case "Chauffeur" -> "ChauffeurMouvementStatut";
            case "Vehicule" -> "VehiculeMouvementStatut";
            case "Trajet" -> "TrajetMouvementStatut";
            case "Trajet_Reservation" -> "TrajetReservationMouvementStatut";
            default -> throw new IllegalArgumentException("Table non supportÃ©e: " + tableName);
        };
    }

    private String getStatusEntityName(String tableName) {
        return switch (tableName) {
            case "Chauffeur" -> "ChauffeurStatut";
            case "Vehicule" -> "VehiculeStatut";
            case "Trajet" -> "TrajetStatut";
            case "Trajet_Reservation" -> "ReservationStatut";
            default -> throw new IllegalArgumentException("Table non supportÃ©e: " + tableName);
        };
    }

    private String getIdFieldName(String tableName) {
        return switch (tableName) {
            case "Chauffeur" -> "chauffeur.id";
            case "Vehicule" -> "vehicule.id";
            case "Trajet" -> "trajet.id";
            case "Trajet_Reservation" -> "trajetReservation.id";
            default -> throw new IllegalArgumentException("Table non supportÃ©e: " + tableName);
        };
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.Client;
import com.mdgtaxi.entity.ProduitCategorie;
import com.mdgtaxi.entity.ProduitExtra;
import com.mdgtaxi.entity.ProduitExtraVente;
import com.mdgtaxi.entity.ProduitExtraVentePayement;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.*;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

public class ProduitExtraVenteService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    // ===== ProduitCategorie =====
    
    public List<ProduitCategorie> getAllCategories() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<ProduitCategorie> query = em.createQuery(
                "SELECT c FROM ProduitCategorie c ORDER BY c.libelle", ProduitCategorie.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public ProduitCategorie getCategorieById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(ProduitCategorie.class, id);
        } finally {
            em.close();
        }
    }

    // ===== ProduitExtra =====
    
    public List<ProduitExtra> getAllProduits() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<ProduitExtra> query = em.createQuery(
                "SELECT p FROM ProduitExtra p ORDER BY p.nom", ProduitExtra.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public List<ProduitExtra> getProduitsByCategorie(Long categorieId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<ProduitExtra> query = em.createQuery(
                "SELECT p FROM ProduitExtra p WHERE p.produitCategorie.id = :categorieId ORDER BY p.nom", 
                ProduitExtra.class);
            query.setParameter("categorieId", categorieId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public ProduitExtra getProduitById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(ProduitExtra.class, id);
        } finally {
            em.close();
        }
    }

    // ===== ProduitExtraVente =====
    
    public List<ProduitExtraVente> getAllVentes() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<ProduitExtraVente> query = em.createQuery(
                "SELECT v FROM ProduitExtraVente v ORDER BY v.date DESC", ProduitExtraVente.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public ProduitExtraVente getVenteById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(ProduitExtraVente.class, id);
        } finally {
            em.close();
        }
    }

    public List<ProduitExtraVente> searchVentes(Map<String, Object> filters) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<ProduitExtraVente> cq = cb.createQuery(ProduitExtraVente.class);
            Root<ProduitExtraVente> root = cq.from(ProduitExtraVente.class);

            List<Predicate> predicates = new ArrayList<>();

            for (Map.Entry<String, Object> entry : filters.entrySet()) {
                String key = entry.getKey();
                Object value = entry.getValue();

                if (value == null) continue;

                switch (key) {
                    case "produitId":
                        predicates.add(cb.equal(root.get("produitExtra").get("id"), value));
                        break;
                    case "categorieId":
                        predicates.add(cb.equal(root.get("produitExtra").get("produitCategorie").get("id"), value));
                        break;
                    case "clientId":
                        predicates.add(cb.equal(root.get("client").get("id"), value));
                        break;
                    case "dateDebut":
                        predicates.add(cb.greaterThanOrEqualTo(root.get("date"), (LocalDateTime) value));
                        break;
                    case "dateFin":
                        predicates.add(cb.lessThanOrEqualTo(root.get("date"), (LocalDateTime) value));
                        break;
                    default:
                        break;
                }
            }

            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            cq.orderBy(cb.desc(root.get("date")));

            TypedQuery<ProduitExtraVente> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public ProduitExtraVente saveVente(ProduitExtraVente vente) {
        EntityManager em = emf.createEntityManager();
        try {
            em.getTransaction().begin();
            if (vente.getId() == null) {
                em.persist(vente);
            } else {
                vente = em.merge(vente);
            }
            em.getTransaction().commit();
            return vente;
        } catch (Exception e) {
            if (em.getTransaction().isActive()) {
                em.getTransaction().rollback();
            }
            throw e;
        } finally {
            em.close();
        }
    }

    public void deleteVente(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            em.getTransaction().begin();
            ProduitExtraVente vente = em.find(ProduitExtraVente.class, id);
            if (vente != null) {
                em.remove(vente);
            }
            em.getTransaction().commit();
        } catch (Exception e) {
            if (em.getTransaction().isActive()) {
                em.getTransaction().rollback();
            }
            throw e;
        } finally {
            em.close();
        }
    }

    // ===== ProduitExtraVentePayement =====
    
    public List<ProduitExtraVentePayement> getPayementsByVente(Long venteId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<ProduitExtraVentePayement> query = em.createQuery(
                "SELECT p FROM ProduitExtraVentePayement p WHERE p.produitExtraVente.id = :venteId ORDER BY p.datePayement DESC", 
                ProduitExtraVentePayement.class);
            query.setParameter("venteId", venteId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public ProduitExtraVentePayement savePayement(ProduitExtraVentePayement payement) {
        EntityManager em = emf.createEntityManager();
        try {
            em.getTransaction().begin();
            if (payement.getId() == null) {
                em.persist(payement);
            } else {
                payement = em.merge(payement);
            }
            em.getTransaction().commit();
            return payement;
        } catch (Exception e) {
            if (em.getTransaction().isActive()) {
                em.getTransaction().rollback();
            }
            throw e;
        } finally {
            em.close();
        }
    }

    public void deletePayement(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            em.getTransaction().begin();
            ProduitExtraVentePayement payement = em.find(ProduitExtraVentePayement.class, id);
            if (payement != null) {
                em.remove(payement);
            }
            em.getTransaction().commit();
        } catch (Exception e) {
            if (em.getTransaction().isActive()) {
                em.getTransaction().rollback();
            }
            throw e;
        } finally {
            em.close();
        }
    }

    // ===== Calculs =====
    
    public BigDecimal getMontantTotalVente(ProduitExtraVente vente) {
        BigDecimal prixUnitaire = vente.getPrixUnitaire() != null ? vente.getPrixUnitaire() : BigDecimal.ZERO;
        int quantite = vente.getQuantite() != null ? vente.getQuantite() : 0;
        double remise = vente.getRemise() != null ? vente.getRemise() : 0.0;
        
        BigDecimal montantBrut = prixUnitaire.multiply(BigDecimal.valueOf(quantite));
        BigDecimal montantRemise = montantBrut.multiply(BigDecimal.valueOf(remise / 100.0));
        return montantBrut.subtract(montantRemise);
    }

    public BigDecimal getMontantPayeVente(Long venteId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<BigDecimal> query = em.createQuery(
                "SELECT COALESCE(SUM(p.montant), 0) FROM ProduitExtraVentePayement p WHERE p.produitExtraVente.id = :venteId", 
                BigDecimal.class);
            query.setParameter("venteId", venteId);
            return query.getSingleResult();
        } finally {
            em.close();
        }
    }

    public BigDecimal getMontantResteVente(Long venteId) {
        ProduitExtraVente vente = getVenteById(venteId);
        if (vente == null) return BigDecimal.ZERO;
        
        BigDecimal montantTotal = getMontantTotalVente(vente);
        BigDecimal montantPaye = getMontantPayeVente(venteId);
        return montantTotal.subtract(montantPaye);
    }

    // ===== Clients =====
    
    public List<Client> getAllClients() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Client> query = em.createQuery(
                "SELECT c FROM Client c ORDER BY c.nom", Client.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public Client getClientById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(Client.class, id);
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.Publicite;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.TypedQuery;
import java.util.List;

public class PubliciteService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    // CREATE
    public Publicite createPublicite(Publicite publicite) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(publicite);
            tx.commit();
            return publicite;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // READ - by ID
    public Publicite getPubliciteById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(Publicite.class, id);
        } finally {
            em.close();
        }
    }

    // READ - all
    public List<Publicite> getAllPublicites() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Publicite> query = em.createQuery(
                    "SELECT p FROM Publicite p ORDER BY p.id DESC",
                    Publicite.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // READ - by Societe
    public List<Publicite> getPublicitesBySocieteId(Long societeId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Publicite> query = em.createQuery(
                    "SELECT p FROM Publicite p WHERE p.societe.id = :societeId ORDER BY p.id DESC",
                    Publicite.class
            );
            query.setParameter("societeId", societeId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // UPDATE
    public Publicite updatePublicite(Publicite publicite) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Publicite updated = em.merge(publicite);
            tx.commit();
            return updated;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // DELETE
    public void deletePublicite(Long id) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Publicite publicite = em.find(Publicite.class, id);
            if (publicite != null) {
                em.remove(publicite);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.*;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class ReservationService {

    private final VehiculeService vehiculeService = new VehiculeService();
    private final TrajetService trajetService = new TrajetService();


    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();


    public double getCAprevisionnel(Long idTrajet) {
        double val = 0;

        List<TrajetReservation> reservations = getReservationsByTrajetId(idTrajet);

        for (TrajetReservation t : reservations) {
            List<TrajetReservationDetails> trajetReservationDetails = getReservationDetailsByReservationId(t.getId());
            for (TrajetReservationDetails d : trajetReservationDetails) {
                val += d.getTarifUnitaire() * d.getNombrePlaces();
            }

        }
        return val;
    }

    public List<TrajetReservation> searchReservationsWithFilters(Map<String, Object> filters) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<TrajetReservation> cq = cb.createQuery(TrajetReservation.class);
            Root<TrajetReservation> root = cq.from(TrajetReservation.class);

            List<Predicate> predicates = new ArrayList<>();

            for (Map.Entry<String, Object> entry : filters.entrySet()) {
                String key = entry.getKey();
                Object value = entry.getValue();

                if (value == null) continue;

                switch (key) {
                    case "nomPassager":
                        predicates.add(cb.equal(root.get("nomPassager"), value));
                        break;
                    case "dateReservation":
                        predicates.add(cb.equal(root.get("dateReservation"), value));
                        break;
                    case "client.id":
                        predicates.add(cb.equal(root.get("client").get("id"), value));
                        break;
                    case "trajet.id":
                        predicates.add(cb.equal(root.get("trajet").get("id"), value));
                        break;
                    case "reservationStatut.id":
                        predicates.add(cb.equal(root.get("reservationStatut").get("id"), value));
                        break;
                    default:
                        break;
                }
            }

            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            TypedQuery<TrajetReservation> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public TrajetReservation createReservation(TrajetReservation reservation) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(reservation);
            tx.commit();
            return reservation;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public TrajetReservationDetails createReservationDetail(TrajetReservationDetails detail) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(detail);
            tx.commit();
            return detail;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public TrajetReservation getReservationById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(TrajetReservation.class, id);
        } finally {
            em.close();
        }
    }

    public List<TrajetReservation> getAllReservations() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetReservation> query = em.createQuery("SELECT r FROM TrajetReservation r ORDER BY r.dateReservation DESC",
                    TrajetReservation.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public List<TrajetReservation> getReservationsByTrajetId(Long trajetId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetReservation> query = em.createQuery(
                    "SELECT r FROM TrajetReservation r WHERE r.trajet.id = :trajetId ORDER BY r.dateReservation DESC",
                    TrajetReservation.class);
            query.setParameter("trajetId", trajetId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public List<TrajetReservationDetails> getReservationDetailsByReservationId(Long reservationId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetReservationDetails> query = em.createQuery(
                    "SELECT rd FROM TrajetReservationDetails rd WHERE rd.trajetReservation.id = :reservationId",
                    TrajetReservationDetails.class);
            query.setParameter("reservationId", reservationId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public TrajetReservation updateReservation(TrajetReservation reservation) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            TrajetReservation updated = em.merge(reservation);
            tx.commit();
            return updated;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public void deleteReservation(Long id) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            TrajetReservation reservation = em.find(TrajetReservation.class, id);
            if (reservation != null) {
                em.remove(reservation);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    /**
     * Obtient les statistiques de rÃ©servations par statut
     */
    public Map<String, Long> getReservationStatsByStatus() {
        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT r.reservationStatut.libelle, COUNT(r) FROM TrajetReservation r GROUP BY r.reservationStatut.libelle";
            TypedQuery<Object[]> query = em.createQuery(jpql, Object[].class);
            List<Object[]> results = query.getResultList();

            Map<String, Long> stats = new HashMap<>();
            for (Object[] result : results) {
                stats.put((String) result[0], (Long) result[1]);
            }
            return stats;
        } finally {
            em.close();
        }
    }

    public TrajetTarifTypePlaceCategorieRemise getTarifRemise(Long idTrajet, Long idTypePlace, Long idCategoriePersonne) {

        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetTarifTypePlaceCategorieRemise> query = em.createQuery(
                    "SELECT p FROM TrajetTarifTypePlaceCategorieRemise p WHERE p.typePlace.id = :idTypePlace " +
                            "AND  p.categoriePersonne.id = :idCategoriePersonne AND p.trajet.id =: idTrajet",
                    TrajetTarifTypePlaceCategorieRemise.class);

            query.setParameter("idTypePlace", idTypePlace);
            query.setParameter("idCategoriePersonne", idCategoriePersonne);
            query.setParameter("idTrajet", idTrajet);


            List<TrajetTarifTypePlaceCategorieRemise> remise = query.getResultList();
            if (!remise.isEmpty()) {
                return remise.get(0);
            }
            return null;
        } finally {
            em.close();
        }
    }

    /**
     * Get all tarif pourcentages remises
     */
    public List<TrajetRemisePourcentage> getAllTarifPourcentagesRemises() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetRemisePourcentage> query = em.createQuery(
                    "SELECT t FROM TrajetRemisePourcentage t ORDER BY t.id DESC",
                    TrajetRemisePourcentage.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public TrajetRemisePourcentage getRemisePourcentageByCategorieApplication(Long idCategorieApplication) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetRemisePourcentage> query = em.createQuery(
                    "SELECT t FROM TrajetRemisePourcentage t WHERE t.categorieApplication = :idCategorieApplication ORDER BY t.id DESC",
                    TrajetRemisePourcentage.class
            );

            List<TrajetRemisePourcentage> trajetRemisePourcentages = query.getResultList();

            if (!trajetRemisePourcentages.isEmpty()) {
                return trajetRemisePourcentages.get(0);
            }

            return null;
        } finally {
            em.close();
        }
    }

    public double getTarifAvecRemise(Long idTrajet, Long idTypePlace, Long idCategoriePersonne) throws Exception {
        TrajetTarifTypePlaceCategorieRemise remise = getTarifRemise(idTrajet, idTypePlace, idCategoriePersonne);

        if (remise != null) {
            return remise.getTarifUnitaireAvecRemise();
        }

        Trajet t = trajetService.getTrajetById(idTrajet);

        VehiculeTarifTypePlace vehiculeTarifTypePlace = vehiculeService.getTarifTypePlaceByVehiculeAndType(t.getVehicule().getId(), idTypePlace);

        TrajetRemisePourcentage trajetRemisePourcentageApplication = getRemisePourcentageByCategorieApplication(idCategoriePersonne);


        if (vehiculeTarifTypePlace == null) {
            throw new Exception("La voiture avec l'id : " + t.getVehicule().getId() + " Ne contient pas la place : " + idTypePlace);
        }

        double val = vehiculeTarifTypePlace.getTarifUnitaire();

        if (trajetRemisePourcentageApplication != null) {
            TrajetTarifTypePlaceCategorieRemise remiseFrom = getTarifRemise(idTrajet, idTypePlace, trajetRemisePourcentageApplication.getCategorieParRapport().getId());
            if (remiseFrom != null) {
                val = remiseFrom.getTarifUnitaireAvecRemise() * (1 + trajetRemisePourcentageApplication.getRemisePourcent() / 100);
            }
        }

        return val;

    }

    /**
     * Calcule le nombre total de places rÃ©servÃ©es pour un trajet (toutes types confondus)
     */
    public double getPlacesPrisesForTrajet(Long trajetId) {
        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT COALESCE(SUM(rd.nombrePlaces), 0) FROM TrajetReservation r " +
                    "JOIN r.trajetReservationDetails rd " +
                    "WHERE r.trajet.id = :trajetId AND r.reservationStatut.libelle != 'AnnulÃ©e'";
            TypedQuery<Double> query = em.createQuery(jpql, Double.class);
            query.setParameter("trajetId", trajetId);
            Double result = query.getSingleResult();
            return result != null ? result : 0.0;
        } finally {
            em.close();
        }
    }

    /**
     * Calcule le nombre de places rÃ©servÃ©es pour un trajet par type de place
     */
    public double getPlacesPrisesForTrajet(Long trajetId, Long idTypePlace) {
        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT COALESCE(SUM(rd.nombrePlaces), 0) FROM TrajetReservation r " +
                    "JOIN r.trajetReservationDetails rd " +
                    "WHERE r.trajet.id = :trajetId AND rd.typePlace.id = :idTypePlace " +
                    "AND r.reservationStatut.libelle != 'AnnulÃ©e'";
            TypedQuery<Double> query = em.createQuery(jpql, Double.class);
            query.setParameter("trajetId", trajetId);
            query.setParameter("idTypePlace", idTypePlace);
            Double result = query.getSingleResult();
            return result != null ? result : 0.0;
        } finally {
            em.close();
        }
    }

    /**
     * Calcule le nombre de places restantes pour un trajet
     */
    public double getPlacesRestantesForTrajet(Long trajetId) {
        EntityManager em = emf.createEntityManager();
        try {
            Trajet trajet = em.find(Trajet.class, trajetId);
            if (trajet == null) {
                return 0.0;
            }

            // Total des places disponibles sur le vÃ©hicule
            String jpql = "SELECT COALESCE(SUM(vttp.nombrePlace), 0) FROM VehiculeTarifTypePlace vttp " +
                    "WHERE vttp.vehicule.id = :idVehicule";
            TypedQuery<Double> query = em.createQuery(jpql, Double.class);
            query.setParameter("idVehicule", trajet.getVehicule().getId());
            Double capaciteMax = query.getSingleResult();

            double placesPrises = getPlacesPrisesForTrajet(trajetId);
            return (capaciteMax != null ? capaciteMax : 0.0) - placesPrises;
        } finally {
            em.close();
        }
    }

    /**
     * Calcule le nombre de places restantes pour un type de place spÃ©cifique
     */
    public double getPlacesRestantesForTrajet(Long trajetId, Long idTypePlace) {
        EntityManager em = emf.createEntityManager();
        try {
            Trajet trajet = em.find(Trajet.class, trajetId);
            if (trajet == null) {
                return 0.0;
            }

            // Places disponibles pour ce type
            String jpql = "SELECT vttp.nombrePlace FROM VehiculeTarifTypePlace vttp " +
                    "WHERE vttp.vehicule.id = :idVehicule AND vttp.typePlace.id = :idTypePlace";
            TypedQuery<Double> query = em.createQuery(jpql, Double.class);
            query.setParameter("idVehicule", trajet.getVehicule().getId());
            query.setParameter("idTypePlace", idTypePlace);
            Double capacite = query.getSingleResult();

            double placesPrises = getPlacesPrisesForTrajet(trajetId, idTypePlace);
            return (capacite != null ? capacite : 0.0) - placesPrises;
        } finally {
            em.close();
        }
    }

    /**
     * Calcule le montant total rÃ©el de la rÃ©servation basÃ© sur les dÃ©tails avec leurs tarifs
     */
    public BigDecimal getMontantTotalReservation(Long reservationId) {
        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT COALESCE(SUM(rd.nombrePlaces * rd.tarifUnitaire), 0) " +
                    "FROM TrajetReservationDetails rd " +
                    "WHERE rd.trajetReservation.id = :reservationId";
            TypedQuery<Double> query = em.createQuery(jpql, Double.class);
            query.setParameter("reservationId", reservationId);
            Double result = query.getSingleResult();
            return BigDecimal.valueOf(result != null ? result : 0.0);
        } finally {
            em.close();
        }
    }

    /**
     * Calcule le total des paiements reÃ§us pour une rÃ©servation
     */
    public BigDecimal getTotalPaiementRecu(Long idReservation) {
        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT COALESCE(SUM(p.montant), 0) FROM TrajetReservationPaiement p " +
                    "WHERE p.trajetReservation.id = :idReservation";
            TypedQuery<BigDecimal> query = em.createQuery(jpql, BigDecimal.class);
            query.setParameter("idReservation", idReservation);
            BigDecimal result = query.getSingleResult();
            return result != null ? result : BigDecimal.ZERO;
        } finally {
            em.close();
        }
    }

    /**
     * Calcule le solde restant Ã  payer
     */
    public BigDecimal getSoldeRestant(Long reservationId) {
        BigDecimal total = getMontantTotalReservation(reservationId);
        BigDecimal paye = getTotalPaiementRecu(reservationId);
        return total.subtract(paye);
    }

    public List<TrajetReservationPaiement> getPaymentsByReservation(Long reservationId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetReservationPaiement> query = em.createQuery(
                    "SELECT p FROM TrajetReservationPaiement p WHERE p.trajetReservation.id = :id ORDER BY p.datePaiement DESC",
                    TrajetReservationPaiement.class);
            query.setParameter("id", reservationId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public TrajetReservationPaiement createPayment(TrajetReservationPaiement paiement) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(paiement);
            tx.commit();
            return paiement;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public List<TrajetReservationMouvementStatut> getStatusHistoryByReservation(Long reservationId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetReservationMouvementStatut> query = em.createQuery(
                    "SELECT rms FROM TrajetReservationMouvementStatut rms WHERE rms.trajetReservation.id = :id ORDER BY rms.dateMouvement DESC",
                    TrajetReservationMouvementStatut.class);
            query.setParameter("id", reservationId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public TrajetReservationMouvementStatut changeStatus(TrajetReservationMouvementStatut mouvement) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(mouvement);
            tx.commit();
            return mouvement;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    /**
     * Calcule le total de toutes les places prises (tous trajets, toutes rÃ©servations)
     */
    public double getTotalPlacesPrises() {
        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT COALESCE(SUM(rd.nombrePlaces), 0) FROM TrajetReservation r " +
                    "JOIN r.trajetReservationDetails rd " +
                    "WHERE r.reservationStatut.libelle != 'AnnulÃ©e'";
            TypedQuery<Double> query = em.createQuery(jpql, Double.class);
            Double result = query.getSingleResult();
            return result != null ? result : 0.0;
        } finally {
            em.close();
        }
    }

    /**
     * Calcule le total de toutes les places restantes (estimation globale)
     */
    public double getTotalPlacesRestantes() {
        EntityManager em = emf.createEntityManager();
        try {
            // Total capacitÃ© de tous les trajets
            String jpqlCapacite = "SELECT t FROM Trajet t";
            TypedQuery<Trajet> queryTrajets = em.createQuery(jpqlCapacite, Trajet.class);
            List<Trajet> trajets = queryTrajets.getResultList();

            double totalCapacite = 0.0;
            for (Trajet trajet : trajets) {
                String jpql = "SELECT COALESCE(SUM(vttp.nombrePlace), 0) FROM VehiculeTarifTypePlace vttp " +
                        "WHERE vttp.vehicule.id = :idVehicule";
                TypedQuery<Double> query = em.createQuery(jpql, Double.class);
                query.setParameter("idVehicule", trajet.getVehicule().getId());
                Double cap = query.getSingleResult();
                totalCapacite += (cap != null ? cap : 0.0);
            }

            double totalPlacesPrises = getTotalPlacesPrises();
            return totalCapacite - totalPlacesPrises;
        } finally {
            em.close();
        }
    }
    // Add these methods to your existing ReservationService class

    public TrajetReservationDetails getReservationDetailById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(TrajetReservationDetails.class, id);
        } finally {
            em.close();
        }
    }

    public TrajetReservationDetails updateReservationDetail(TrajetReservationDetails detail) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            TrajetReservationDetails updated = em.merge(detail);
            tx.commit();
            return updated;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public void deleteReservationDetail(Long id) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            TrajetReservationDetails detail = em.find(TrajetReservationDetails.class, id);
            if (detail != null) {
                em.remove(detail);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.Societe;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.TypedQuery;
import java.util.List;

public class SocieteService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    // CREATE
    public Societe createSociete(Societe societe) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(societe);
            tx.commit();
            return societe;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // READ - by ID
    public Societe getSocieteById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(Societe.class, id);
        } finally {
            em.close();
        }
    }

    // READ - all
    public List<Societe> getAllSocietes() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Societe> query = em.createQuery(
                    "SELECT s FROM Societe s ORDER BY s.nom ASC",
                    Societe.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // UPDATE
    public Societe updateSociete(Societe societe) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Societe updated = em.merge(societe);
            tx.commit();
            return updated;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // DELETE
    public void deleteSociete(Long id) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Societe societe = em.find(Societe.class, id);
            if (societe != null) {
                em.remove(societe);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // Optionnel : recherche par nom (partiel)
    public List<Societe> findByNomContaining(String nom) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Societe> query = em.createQuery(
                    "SELECT s FROM Societe s WHERE LOWER(s.nom) LIKE LOWER(:nom) ORDER BY s.nom ASC",
                    Societe.class
            );
            query.setParameter("nom", "%" + nom + "%");
            return query.getResultList();
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.dto.StatusObjectDto;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.TypedQuery;
import java.util.List;

/**
 * Service gÃ©nÃ©rique pour gÃ©rer les statuts (Chauffeur, Vehicule, Trajet, Reservation)
 */
public class StatusService {
    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    /**
     * RÃ©cupÃ¨re tous les statuts pour une table donnÃ©e
     * @param tableName Nom de la table (Chauffeur_Statut, Vehicule_Statut, Trajet_Statut, Reservation_Statut)
     * @return Liste des statuts
     */
    public List<StatusObjectDto> findAllStatuses(String tableName) {
        String entityName = getStatusEntityName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT new com.mdgtaxi.dto.StatusObjectDto(s.id, s.libelle, s.score, s.spanHtml) " +
                    "FROM " + entityName + " s ORDER BY s.score";
            TypedQuery<StatusObjectDto> query = em.createQuery(jpql, StatusObjectDto.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    /**
     * Trouve un statut par son libellÃ©
     * @param tableName Nom de la table
     * @param libelle LibellÃ© du statut
     * @return Le statut ou null
     */
    public StatusObjectDto findStatusByLibelle(String tableName, String libelle) {
        String entityName = getStatusEntityName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT new com.mdgtaxi.dto.StatusObjectDto(s.id, s.libelle, s.score, s.spanHtml) " +
                    "FROM " + entityName + " s WHERE s.libelle = :libelle";
            TypedQuery<StatusObjectDto> query = em.createQuery(jpql, StatusObjectDto.class);
            query.setParameter("libelle", libelle);
            List<StatusObjectDto> results = query.getResultList();
            return results.isEmpty() ? null : results.get(0);
        } finally {
            em.close();
        }
    }

    /**
     * Trouve un statut par son score
     * @param tableName Nom de la table
     * @param score Score du statut
     * @return Le statut ou null
     */
    public StatusObjectDto findStatusByScore(String tableName, int score) {
        String entityName = getStatusEntityName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT new com.mdgtaxi.dto.StatusObjectDto(s.id, s.libelle, s.score, s.spanHtml) " +
                    "FROM " + entityName + " s WHERE s.score = :score";
            TypedQuery<StatusObjectDto> query = em.createQuery(jpql, StatusObjectDto.class);
            query.setParameter("score", score);
            List<StatusObjectDto> results = query.getResultList();
            return results.isEmpty() ? null : results.get(0);
        } finally {
            em.close();
        }
    }

    /**
     * Trouve un statut par son ID
     * @param tableName Nom de la table
     * @param id ID du statut
     * @return Le statut ou null
     */
    public StatusObjectDto findStatusById(String tableName, Long id) {
        String entityName = getStatusEntityName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT new com.mdgtaxi.dto.StatusObjectDto(s.id, s.libelle, s.score, s.spanHtml) " +
                    "FROM " + entityName + " s WHERE s.id = :id";
            TypedQuery<StatusObjectDto> query = em.createQuery(jpql, StatusObjectDto.class);
            query.setParameter("id", id);
            List<StatusObjectDto> results = query.getResultList();
            return results.isEmpty() ? null : results.get(0);
        } finally {
            em.close();
        }
    }

    /**
     * RÃ©cupÃ¨re les statuts avec un score minimum
     * @param tableName Nom de la table
     * @param minScore Score minimum
     * @return Liste des statuts
     */
    public List<StatusObjectDto> findStatusesByMinScore(String tableName, int minScore) {
        String entityName = getStatusEntityName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT new com.mdgtaxi.dto.StatusObjectDto(s.id, s.libelle, s.score, s.spanHtml) " +
                    "FROM " + entityName + " s WHERE s.score >= :minScore ORDER BY s.score";
            TypedQuery<StatusObjectDto> query = em.createQuery(jpql, StatusObjectDto.class);
            query.setParameter("minScore", minScore);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    /**
     * RÃ©cupÃ¨re les statuts avec un score maximum
     * @param tableName Nom de la table
     * @param maxScore Score maximum
     * @return Liste des statuts
     */
    public List<StatusObjectDto> findStatusesByMaxScore(String tableName, int maxScore) {
        String entityName = getStatusEntityName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT new com.mdgtaxi.dto.StatusObjectDto(s.id, s.libelle, s.score, s.spanHtml) " +
                    "FROM " + entityName + " s WHERE s.score <= :maxScore ORDER BY s.score";
            TypedQuery<StatusObjectDto> query = em.createQuery(jpql, StatusObjectDto.class);
            query.setParameter("maxScore", maxScore);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    /**
     * RÃ©cupÃ¨re les statuts dans une plage de scores
     * @param tableName Nom de la table
     * @param minScore Score minimum
     * @param maxScore Score maximum
     * @return Liste des statuts
     */
    public List<StatusObjectDto> findStatusesByScoreRange(String tableName, int minScore, int maxScore) {
        String entityName = getStatusEntityName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT new com.mdgtaxi.dto.StatusObjectDto(s.id, s.libelle, s.score, s.spanHtml) " +
                    "FROM " + entityName + " s WHERE s.score BETWEEN :minScore AND :maxScore ORDER BY s.score";
            TypedQuery<StatusObjectDto> query = em.createQuery(jpql, StatusObjectDto.class);
            query.setParameter("minScore", minScore);
            query.setParameter("maxScore", maxScore);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    /**
     * Mapping des noms de tables vers les noms d'entitÃ©s de statut
     */
    private String getStatusEntityName(String tableName) {
        return switch (tableName) {
            case "Chauffeur" -> "ChauffeurStatut";
            case "Vehicule" -> "VehiculeStatut";
            case "Trajet" -> "TrajetStatut";
            case "Trajet_Reservation" -> "ReservationStatut";
            default -> throw new IllegalArgumentException("Table non supportÃ©e: " + tableName);
        };
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.TrajetRemisePourcentage;
import com.mdgtaxi.entity.TrajetTarifTypePlaceCategorieRemise;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

public class TarifRemiseService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    /**
     * Create a new tarif remise
     */
    public TrajetTarifTypePlaceCategorieRemise createTarifRemise(TrajetTarifTypePlaceCategorieRemise tarifRemise) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(tarifRemise);
            tx.commit();
            return tarifRemise;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    /**
     * Get tarif remise by ID
     */
    public TrajetTarifTypePlaceCategorieRemise getTarifRemiseById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(TrajetTarifTypePlaceCategorieRemise.class, id);
        } finally {
            em.close();
        }
    }

    /**
     * Get all tarif remises
     */
    public List<TrajetTarifTypePlaceCategorieRemise> getAllTarifRemises() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetTarifTypePlaceCategorieRemise> query = em.createQuery(
                    "SELECT t FROM TrajetTarifTypePlaceCategorieRemise t ORDER BY t.id DESC",
                    TrajetTarifTypePlaceCategorieRemise.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public List<TrajetTarifTypePlaceCategorieRemise> getTarifRemisesByTrajet(Long trajetId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetTarifTypePlaceCategorieRemise> query = em.createQuery(
                    "SELECT t FROM TrajetTarifTypePlaceCategorieRemise t WHERE t.trajet.id = :trajetId ORDER BY t.id DESC",
                    TrajetTarifTypePlaceCategorieRemise.class
            );
            query.setParameter("trajetId", trajetId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    /**
     * Get all remise pourcentages for a specific trajet
     */
    public List<TrajetRemisePourcentage> getRemisePourcentagesByTrajet(Long trajetId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetRemisePourcentage> query = em.createQuery(
                    "SELECT t FROM TrajetRemisePourcentage t WHERE t.trajet.id = :trajetId ORDER BY t.id DESC",
                    TrajetRemisePourcentage.class
            );
            query.setParameter("trajetId", trajetId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    /**
     * Apply remise pourcentage for a specific trajet
     */
    public void appliquerRemisePourcentTrajet(Long idRemise, Long trajetId) throws Exception {
        TrajetRemisePourcentage val = getRemisePourcentById(idRemise);

        if (!val.getTrajet().getId().equals(trajetId)) {
            throw new Exception("Cette remise n'appartient pas Ã  ce trajet");
        }

        List<TrajetTarifTypePlaceCategorieRemise> tarifRemises = getTarifRemisesByTrajetAndCategorie(
                trajetId,
                val.getCategorieParRapport().getId()
        );

        for (TrajetTarifTypePlaceCategorieRemise t : tarifRemises) {
            TrajetTarifTypePlaceCategorieRemise newRemise = new TrajetTarifTypePlaceCategorieRemise();

            newRemise.setTrajet(t.getTrajet());
            newRemise.setTypePlace(t.getTypePlace());
            newRemise.setCategoriePersonne(val.getCategorieApplication());

            double nouveauTarif = t.getTarifUnitaireAvecRemise() * (1 + (val.getRemisePourcent()) / 100);
            newRemise.setTarifUnitaireAvecRemise(nouveauTarif);

            createTarifRemise(newRemise);
        }
    }

    /**
     * Get tarif remises by trajet and categorie
     */
    private List<TrajetTarifTypePlaceCategorieRemise> getTarifRemisesByTrajetAndCategorie(Long trajetId, Long categorieId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetTarifTypePlaceCategorieRemise> query = em.createQuery(
                    "SELECT t FROM TrajetTarifTypePlaceCategorieRemise t " +
                            "WHERE t.trajet.id = :trajetId AND t.categoriePersonne.id = :categorieId",
                    TrajetTarifTypePlaceCategorieRemise.class
            );
            query.setParameter("trajetId", trajetId);
            query.setParameter("categorieId", categorieId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }



    public List<TrajetTarifTypePlaceCategorieRemise> getAllTarifRemises(Long idCategorie) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetTarifTypePlaceCategorieRemise> query = em.createQuery(
                    "SELECT t FROM TrajetTarifTypePlaceCategorieRemise t WHERE t.categoriePersonne.id = :idCategorie ORDER BY t.id DESC",
                    TrajetTarifTypePlaceCategorieRemise.class
            );
            query.setParameter("idCategorie", idCategorie);
            return query.getResultList();
        } finally {
            em.close();
        }
    }


    public TrajetRemisePourcentage getRemisePourcentById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(TrajetRemisePourcentage.class, id);
        } finally {
            em.close();
        }
    }

    public boolean hastTarif (Long idCategorie, Long idTypePlace) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetTarifTypePlaceCategorieRemise> query = em.createQuery(
                    "SELECT t FROM TrajetTarifTypePlaceCategorieRemise t WHERE t.categoriePersonne.id = :idCategorie ORDER BY t.id DESC",
                    TrajetTarifTypePlaceCategorieRemise.class
            );
            query.setParameter("idCategorie", idCategorie);
            if( query.getResultList().isEmpty()) {

            };
        } finally {
            em.close();
        }
        return false;
    }

    public void appliquerRemisePourcent(Long idRemise) throws Exception {
        TrajetRemisePourcentage val = getRemisePourcentById(idRemise);

        List<TrajetTarifTypePlaceCategorieRemise> trajetTarifTypePlaceCategorieRemises = getAllTarifRemises(val.getCategorieParRapport().getId());

        for (TrajetTarifTypePlaceCategorieRemise t : trajetTarifTypePlaceCategorieRemises) {
            t.setId(null);

            t.setCategoriePersonne(val.getCategorieApplication());
            double nouveautarif = t.getTarifUnitaireAvecRemise() * (1 + (val.getRemisePourcent()) / 100);
            t.setTarifUnitaireAvecRemise(nouveautarif);

            createTarifRemise(t);
        }
    }

    /**
     * Get all tarif pourcentages remises
     */
    public List<TrajetRemisePourcentage> getAllTarifPourcentagesRemises() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetRemisePourcentage> query = em.createQuery(
                    "SELECT t FROM TrajetRemisePourcentage t ORDER BY t.id DESC",
                    TrajetRemisePourcentage.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }


    /**
     * Update tarif remise
     */
    public TrajetTarifTypePlaceCategorieRemise updateTarifRemise(TrajetTarifTypePlaceCategorieRemise tarifRemise) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            TrajetTarifTypePlaceCategorieRemise updated = em.merge(tarifRemise);
            tx.commit();
            return updated;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    /**
     * Delete tarif remise
     */
    public void deleteTarifRemise(Long id) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            TrajetTarifTypePlaceCategorieRemise tarifRemise = em.find(TrajetTarifTypePlaceCategorieRemise.class, id);
            if (tarifRemise != null) {
                em.remove(tarifRemise);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    /**
     * Search tarif remises with filters
     */
    public List<TrajetTarifTypePlaceCategorieRemise> searchTarifRemisesWithFilters(Map<String, Object> filters) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<TrajetTarifTypePlaceCategorieRemise> cq = cb.createQuery(TrajetTarifTypePlaceCategorieRemise.class);
            Root<TrajetTarifTypePlaceCategorieRemise> root = cq.from(TrajetTarifTypePlaceCategorieRemise.class);

            List<Predicate> predicates = new ArrayList<>();

            for (Map.Entry<String, Object> entry : filters.entrySet()) {
                String key = entry.getKey();
                Object value = entry.getValue();

                if (value == null) continue;

                switch (key) {
                    case "typePlace.id":
                        predicates.add(cb.equal(root.get("typePlace").get("id"), value));
                        break;
                    case "categoriePersonne.id":
                        predicates.add(cb.equal(root.get("categoriePersonne").get("id"), value));
                        break;
                    case "tarifUnitaireAvecRemise":
                        predicates.add(cb.equal(root.get("tarifUnitaireAvecRemise"), value));
                        break;
                    case "tarifUnitaireAvecRemise>=":
                        predicates.add(cb.greaterThanOrEqualTo(root.get("tarifUnitaireAvecRemise"), (Double) value));
                        break;
                    case "tarifUnitaireAvecRemise<=":
                        predicates.add(cb.lessThanOrEqualTo(root.get("tarifUnitaireAvecRemise"), (Double) value));
                        break;
                    default:
                        break;
                }
            }

            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            cq.orderBy(cb.desc(root.get("id")));

            TypedQuery<TrajetTarifTypePlaceCategorieRemise> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    /**
     * Get tarif remise by type place and categorie personne
     */
    public TrajetTarifTypePlaceCategorieRemise getTarifRemiseByTypePlaceAndCategorie(Long idTypePlace, Long idCategoriePersonne) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetTarifTypePlaceCategorieRemise> query = em.createQuery(
                    "SELECT t FROM TrajetTarifTypePlaceCategorieRemise t WHERE t.typePlace.id = :idTypePlace AND t.categoriePersonne.id = :idCategoriePersonne",
                    TrajetTarifTypePlaceCategorieRemise.class
            );
            query.setParameter("idTypePlace", idTypePlace);
            query.setParameter("idCategoriePersonne", idCategoriePersonne);
            List<TrajetTarifTypePlaceCategorieRemise> results = query.getResultList();
            return results.isEmpty() ? null : results.get(0);
        } finally {
            em.close();
        }
    }

    /**
     * Get all tarif remises by type place
     */
    public List<TrajetTarifTypePlaceCategorieRemise> getTarifRemisesByTypePlace(Long idTypePlace) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetTarifTypePlaceCategorieRemise> query = em.createQuery(
                    "SELECT t FROM TrajetTarifTypePlaceCategorieRemise t WHERE t.typePlace.id = :idTypePlace",
                    TrajetTarifTypePlaceCategorieRemise.class
            );
            query.setParameter("idTypePlace", idTypePlace);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    /**
     * Get all tarif remises by categorie personne
     */
    public List<TrajetTarifTypePlaceCategorieRemise> getTarifRemisesByCategorie(Long idCategoriePersonne) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetTarifTypePlaceCategorieRemise> query = em.createQuery(
                    "SELECT t FROM TrajetTarifTypePlaceCategorieRemise t WHERE t.categoriePersonne.id = :idCategoriePersonne",
                    TrajetTarifTypePlaceCategorieRemise.class
            );
            query.setParameter("idCategoriePersonne", idCategoriePersonne);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    /**
     * Check if tarif remise already exists for this combination
     */
    public boolean existsTarifRemise(Long idTrajet, Long idTypePlace, Long idCategoriePersonne, Long excludeId) {
        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT COUNT(t) FROM TrajetTarifTypePlaceCategorieRemise t " +
                    "WHERE t.typePlace.id = :idTypePlace AND t.categoriePersonne.id = :idCategoriePersonne AND t.trajet.id = :idTrajet";

            if (excludeId != null) {
                jpql += " AND t.id != :excludeId";
            }

            TypedQuery<Long> query = em.createQuery(jpql, Long.class);
            query.setParameter("idTypePlace", idTypePlace);
            query.setParameter("idCategoriePersonne", idCategoriePersonne);
            query.setParameter("idTrajet", idTrajet);


            if (excludeId != null) {
                query.setParameter("excludeId", excludeId);
            }

            return query.getSingleResult() > 0;
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.*;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

public class TrajetService {
    

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    public Trajet createTrajet(Trajet trajet) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(trajet);
            tx.commit();
            return trajet;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public Trajet getTrajetById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(Trajet.class, id);
        } finally {
            em.close();
        }
    }

    public List<Trajet> getAllTrajets() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Trajet> query = em.createQuery("SELECT t FROM Trajet t ORDER BY t.datetimeDepart DESC", Trajet.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public List<Trajet> getTrajetsByLigneId(Long ligneId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Trajet> query = em.createQuery(
                    "SELECT t FROM Trajet t WHERE t.ligne.id = :ligneId ORDER BY t.datetimeDepart DESC",
                    Trajet.class);
            query.setParameter("ligneId", ligneId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public double getPlaceRestante(Long idTrajet) {
        EntityManager em = emf.createEntityManager();
        try {
            Trajet trajet = em.find(Trajet.class, idTrajet);
            if (trajet == null) {
                return 0.0;
            }
            double totalPlaces = trajet.getVehicule().getMaximumPassager();
            String jpql = "SELECT SUM(trd.nombrePlaces) FROM TrajetReservation tr JOIN tr.trajetReservationDetails trd WHERE tr.trajet.id = :idTrajet";
            TypedQuery<Double> query = em.createQuery(jpql, Double.class);
            query.setParameter("idTrajet", idTrajet);
            Double taken = query.getSingleResult();
            double takenPlaces = taken != null ? taken : 0.0;
            return totalPlaces - takenPlaces;
        } finally {
            em.close();
        }
    }

    public double getPlaceRestante(Long idTrajet, Long idTypePlace) {
        EntityManager em = emf.createEntityManager();
        try {
            Trajet trajet = em.find(Trajet.class, idTrajet);
            if (trajet == null) {
                return 0.0;
            }
            String totalJpql = "SELECT vttp.nombrePlace FROM VehiculeTarifTypePlace vttp WHERE vttp.vehicule.id = :idVehicule AND vttp.typePlace.id = :idTypePlace";
            TypedQuery<Double> totalQuery = em.createQuery(totalJpql, Double.class);
            totalQuery.setParameter("idVehicule", trajet.getVehicule().getId());
            totalQuery.setParameter("idTypePlace", idTypePlace);
            Double total = totalQuery.getSingleResult();
            double totalForType = total != null ? total : 0.0;

            String takenJpql = "SELECT SUM(trd.nombrePlaces) FROM TrajetReservation tr JOIN tr.trajetReservationDetails trd WHERE tr.trajet.id = :idTrajet AND trd.typePlace.id = :idTypePlace";
            TypedQuery<Double> takenQuery = em.createQuery(takenJpql, Double.class);
            takenQuery.setParameter("idTrajet", idTrajet);
            takenQuery.setParameter("idTypePlace", idTypePlace);
            Double taken = takenQuery.getSingleResult();
            double takenForType = taken != null ? taken : 0.0;

            return totalForType - takenForType;
        } finally {
            em.close();
        }
    }

    public double getPlacePrise(Long idTrajet, Long idTypePlace) {
        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT SUM(trd.nombrePlaces) FROM TrajetReservation tr JOIN tr.trajetReservationDetails trd WHERE tr.trajet.id = :idTrajet AND trd.typePlace.id = :idTypePlace";
            TypedQuery<Double> query = em.createQuery(jpql, Double.class);
            query.setParameter("idTrajet", idTrajet);
            query.setParameter("idTypePlace", idTypePlace);
            Double taken = query.getSingleResult();
            return taken != null ? taken : 0.0;
        } finally {
            em.close();
        }
    }

    public double getPrevisionChiffreAffaire(Long idTrajet) {
        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT SUM(trd.nombrePlaces * vttp.tarifUnitaire) " +
                    "FROM TrajetReservation tr " +
                    "JOIN tr.trajetReservationDetails trd " +
                    "JOIN VehiculeTarifTypePlace vttp ON vttp.vehicule.id = tr.trajet.vehicule.id AND vttp.typePlace.id = trd.typePlace.id " +
                    "WHERE tr.trajet.id = :idTrajet";
            TypedQuery<Double> query = em.createQuery(jpql, Double.class);
            query.setParameter("idTrajet", idTrajet);
            Double prevision = query.getSingleResult();
            return prevision != null ? prevision : 0.0;
        } finally {
            em.close();
        }
    }

    public double getTotalPaiementRecu(Long idTrajet) {
        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT SUM(p.montant) FROM TrajetReservationPaiement p WHERE p.trajetReservation.trajet.id = :idTrajet";
            TypedQuery<Double> query = em.createQuery(jpql, Double.class);
            query.setParameter("idTrajet", idTrajet);
            Double total = query.getSingleResult();
            return total != null ? total : 0.0;
        } finally {
            em.close();
        }
    }

    public List<Trajet> searchTrajetsWithFilters(Map<String, Object> filters) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<Trajet> cq = cb.createQuery(Trajet.class);
            Root<Trajet> root = cq.from(Trajet.class);

            List<Predicate> predicates = new ArrayList<>();

            for (Map.Entry<String, Object> entry : filters.entrySet()) {
                String key = entry.getKey();
                Object value = entry.getValue();

                if (value == null) continue;

                switch (key) {
                    case "nombrePassager":
                        predicates.add(cb.equal(root.get("nombrePassager"), value));
                        break;
                    case "datetimeDepart":
                        predicates.add(cb.equal(root.get("datetimeDepart"), value));
                        break;
                    case "datetimeDepart>=":
                        predicates.add(cb.greaterThanOrEqualTo(root.get("datetimeDepart"), (LocalDateTime) value));
                        break;
                    case "datetimeDepart<=":
                        predicates.add(cb.lessThanOrEqualTo(root.get("datetimeDepart"), (LocalDateTime) value));
                        break;
                    case "datetimeArrivee":
                        predicates.add(cb.equal(root.get("datetimeArrivee"), value));
                        break;
                    case "datetimeArrivee>=":
                        predicates.add(cb.greaterThanOrEqualTo(root.get("datetimeArrivee"), (LocalDateTime) value));
                        break;
                    case "datetimeArrivee<=":
                        predicates.add(cb.lessThanOrEqualTo(root.get("datetimeArrivee"), (LocalDateTime) value));
                        break;
                    case "fraisUnitaire":
                        predicates.add(cb.equal(root.get("fraisUnitaire"), value));
                        break;
                    case "ligne.id":
                        predicates.add(cb.equal(root.get("ligne").get("id"), value));
                        break;
                    case "chauffeur.id":
                        predicates.add(cb.equal(root.get("chauffeur").get("id"), value));
                        break;
                    case "vehicule.id":
                        predicates.add(cb.equal(root.get("vehicule").get("id"), value));
                        break;
                    case "trajetStatut.id":
                        predicates.add(cb.equal(root.get("trajetStatut").get("id"), value));
                        break;
                    default:
                        // Ignore unknown filters
                        break;
                }
            }

            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            cq.orderBy(cb.desc(root.get("datetimeDepart")));

            TypedQuery<Trajet> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public List<TrajetTarifTypePlaceCategorieRemise> getTarifTypePlaceCategorieRemisesByTrajetId (Long idTrajet) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetTarifTypePlaceCategorieRemise> query = em.createQuery(
                    "SELECT p FROM TrajetTarifTypePlaceCategorieRemise p WHERE  p.trajet.id =: idTrajet",
                    TrajetTarifTypePlaceCategorieRemise.class);

            query.setParameter("idTrajet", idTrajet);

            List<TrajetTarifTypePlaceCategorieRemise> remise = query.getResultList();
            return remise;
        } finally {
            em.close();
        }
    }


    public Map<Long, Double> getSoldPlacesPerType(Long trajetId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Object[]> query = em.createQuery(
                    "SELECT tp.id, SUM(trd.nombrePlaces) " +
                            "FROM TrajetReservationDetails trd " +
                            "JOIN trd.typePlace tp " +
                            "JOIN trd.trajetReservation tr " +
                            "WHERE tr.trajet.id = :trajetId " +
                            "GROUP BY tp.id", Object[].class);
            query.setParameter("trajetId", trajetId);
            List<Object[]> results = query.getResultList();
            Map<Long, Double> map = new HashMap<>();
            for (Object[] row : results) {
                map.put((Long) row[0], ((Number) row[1]).doubleValue());
            }
            return map;
        } finally {
            em.close();
        }
    }

    public List<TrajetReservation> getReservationsByTrajet(Long trajetId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TrajetReservation> query = em.createQuery(
                    "SELECT r FROM TrajetReservation r WHERE r.trajet.id = :id", TrajetReservation.class);
            query.setParameter("id", trajetId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public Trajet updateTrajet(Trajet trajet) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Trajet updated = em.merge(trajet);
            tx.commit();
            return updated;
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public void deleteTrajet(Long id) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Trajet trajet = em.find(Trajet.class, id);
            if (trajet != null) {
                em.remove(trajet);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive())
                tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public List<Trajet> getAllUpcomingTrajets(LocalDateTime now) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Trajet> query = em.createQuery(
                    "SELECT t FROM Trajet t WHERE t.datetimeDepart >= :now ORDER BY t.datetimeDepart ASC",
                    Trajet.class
            );
            query.setParameter("now", now);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public List<Trajet> getUpcomingTrajetsByLigne(LocalDateTime now, Long ligneId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Trajet> query = em.createQuery(
                    "SELECT t FROM Trajet t WHERE t.datetimeDepart >= :now AND t.ligne.id = :ligneId ORDER BY t.datetimeDepart ASC",
                    Trajet.class
            );
            query.setParameter("now", now);
            query.setParameter("ligneId", ligneId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public List<Trajet> getUpcomingTrajetsByLigneAndDate(LocalDateTime now, Long ligneId, LocalDate date) {
        LocalDateTime start = now.isAfter(date.atStartOfDay()) ? now : date.atStartOfDay();
        LocalDateTime end = date.plusDays(1).atStartOfDay();
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Trajet> query = em.createQuery(
                    "SELECT t FROM Trajet t WHERE t.datetimeDepart >= :start AND t.datetimeDepart < :end AND t.ligne.id = :ligneId ORDER BY t.datetimeDepart ASC",
                    Trajet.class
            );
            query.setParameter("start", start);
            query.setParameter("end", end);
            query.setParameter("ligneId", ligneId);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public List<LocalDate> getDistinctUpcomingDatesByLigne(LocalDateTime now, Long ligneId) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<LocalDateTime> query = em.createQuery(
                    "SELECT t.datetimeDepart FROM Trajet t WHERE t.datetimeDepart >= :now AND t.ligne.id = :ligneId ORDER BY t.datetimeDepart ASC",
                    LocalDateTime.class
            );
            query.setParameter("now", now);
            query.setParameter("ligneId", ligneId);
            List<LocalDateTime> dateTimes = query.getResultList();
            return dateTimes.stream()
                    .map(LocalDateTime::toLocalDate)
                    .distinct()
                    .sorted()
                    .collect(Collectors.toList());
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.dto.TypeObjectDTO;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.TypedQuery;
import java.util.List;

public class TypeObjectService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    public List<TypeObjectDTO> findAllTypeObject(String tableName) {
        // Mapping des noms de tables vers les noms d'entitÃ©s JPA
        String entityName = getEntityName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT new com.mdgtaxi.dto.TypeObjectDTO(e.id, e.libelle) FROM " + entityName + " e";
            TypedQuery<TypeObjectDTO> query = em.createQuery(jpql, TypeObjectDTO.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public TypeObjectDTO findTypeObjectByLibelle(String tableName, String libelle) {
        String entityName = getEntityName(tableName);

        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT new com.mdgtaxi.dto.TypeObjectDTO(e.id, e.libelle) FROM " + entityName
                    + " e WHERE e.libelle = :libelle";
            TypedQuery<TypeObjectDTO> query = em.createQuery(jpql, TypeObjectDTO.class);
            query.setParameter("libelle", libelle);
            List<TypeObjectDTO> results = query.getResultList();
            return results.isEmpty() ? null : results.get(0);
        } finally {
            em.close();
        }
    }

    private String getEntityName(String tableName) {
        return tableName.replace("_", "");
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.Unite;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.TypedQuery;
import java.util.List;

public class UniteService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    // CREATE
    public Unite createUnite(Unite unite) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(unite);
            tx.commit();
            return unite;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // READ - by ID
    public Unite getUniteById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(Unite.class, id);
        } finally {
            em.close();
        }
    }

    // READ - all
    public List<Unite> getAllUnites() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Unite> query = em.createQuery(
                    "SELECT u FROM Unite u ORDER BY u.libelle ASC",
                    Unite.class
            );
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // UPDATE
    public Unite updateUnite(Unite unite) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Unite updated = em.merge(unite);
            tx.commit();
            return updated;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // DELETE
    public void deleteUnite(Long id) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Unite unite = em.find(Unite.class, id);
            if (unite != null) {
                em.remove(unite);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // Optionnel : recherche par libellÃ©
    public List<Unite> findByLibelleContaining(String libelle) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Unite> query = em.createQuery(
                    "SELECT u FROM Unite u WHERE LOWER(u.libelle) LIKE LOWER(:libelle) ORDER BY u.libelle ASC",
                    Unite.class
            );
            query.setParameter("libelle", "%" + libelle + "%");
            return query.getResultList();
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.*;
import com.mdgtaxi.util.HibernateUtil;
import com.mdgtaxi.util.TableUtil;
import com.mdgtaxi.view.VmVehiculeCoutEntretien;
import com.mdgtaxi.view.VmVehiculeDetail;
import com.mdgtaxi.view.VmVehiculeHistoriqueStatut;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

public class VehiculeService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    // CRUD Operations for Vehicule

    public Vehicule createVehicule(Vehicule vehicule) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(vehicule);
            tx.commit();
            return vehicule;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public void deleteTarifTypePlace(Long id) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            VehiculeTarifTypePlace vttp = em.find(VehiculeTarifTypePlace.class, id);
            if (vttp != null) {
                em.remove(vttp);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public VehiculeTarifTypePlace getTarifTypePlaceById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(VehiculeTarifTypePlace.class, id);
        } finally {
            em.close();
        }
    }

    public Vehicule getVehiculeById(Long id) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(Vehicule.class, id);
        } finally {
            em.close();
        }
    }


    public List<Vehicule> getAllVehicules() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Vehicule> query = em.createQuery("SELECT v FROM Vehicule v", Vehicule.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public List<TypePlace> getAllTypePlaces() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<TypePlace> query = em.createQuery("SELECT v FROM TypePlace v", TypePlace.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public Vehicule updateVehicule(Vehicule vehicule) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Vehicule updated = em.merge(vehicule);
            tx.commit();
            return updated;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public void deleteVehicule(Long id) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            Vehicule vehicule = em.find(Vehicule.class, id);
            if (vehicule != null) {
                em.remove(vehicule);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // Operations using Views

    public VmVehiculeDetail getVehiculeDetail(Long idVehicule) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(VmVehiculeDetail.class, idVehicule);
        } finally {
            em.close();
        }
    }

    public List<VmVehiculeDetail> getAllVehiculeDetails() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<VmVehiculeDetail> query = em.createQuery("SELECT vd FROM VmVehiculeDetail vd", VmVehiculeDetail.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }



    public List<VmVehiculeHistoriqueStatut> getHistoriqueStatut(Long idVehicule) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<VmVehiculeHistoriqueStatut> query = em.createQuery(
                    "SELECT hs FROM VmVehiculeHistoriqueStatut hs WHERE hs.idVehicule = :idVehicule ORDER BY hs.dateMouvement DESC",
                    VmVehiculeHistoriqueStatut.class);
            query.setParameter("idVehicule", idVehicule);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public VmVehiculeCoutEntretien getCoutEntretien(Long idVehicule) {
        EntityManager em = emf.createEntityManager();
        try {
            return em.find(VmVehiculeCoutEntretien.class, idVehicule);
        } finally {
            em.close();
        }
    }

    // Operations for Related Entities

    public VehiculeEntretien addEntretien(VehiculeEntretien entretien) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(entretien);
            tx.commit();
            return entretien;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    public List<VehiculeEntretien> getEntretiensByVehicule(Long idVehicule) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<VehiculeEntretien> query = em.createQuery(
                    "SELECT ve FROM VehiculeEntretien ve WHERE ve.vehicule.id = :idVehicule ORDER BY ve.dateDebutEntretien DESC",
                    VehiculeEntretien.class);
            query.setParameter("idVehicule", idVehicule);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public double getTotalMaxChiffreAffairePossible(Long idVoiture) {
        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT SUM(vttp.nombrePlace * vttp.tarifUnitaire) FROM VehiculeTarifTypePlace vttp WHERE vttp.vehicule.id = :idVoiture";
            TypedQuery<Double> query = em.createQuery(jpql, Double.class);
            query.setParameter("idVoiture", idVoiture);
            Double total = query.getSingleResult();
            return total != null ? total : 0.0;
        } finally {
            em.close();
        }
    }

    public double getTotalMaxChiffreAffairePossible(Long idVoiture, Long idTypePlace) {
        EntityManager em = emf.createEntityManager();
        try {
            String jpql = "SELECT vttp.nombrePlace * vttp.tarifUnitaire FROM VehiculeTarifTypePlace vttp WHERE vttp.vehicule.id = :idVoiture AND vttp.typePlace.id = :idTypePlace";
            TypedQuery<Double> query = em.createQuery(jpql, Double.class);
            query.setParameter("idVoiture", idVoiture);
            query.setParameter("idTypePlace", idTypePlace);
            Double total = query.getSingleResult();
            return total != null ? total : 0.0;
        } finally {
            em.close();
        }
    }

    public VehiculeMouvementStatut changeStatut(VehiculeMouvementStatut mouvement) {
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(mouvement);
            tx.commit();
            return mouvement;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    // Multi-filter criteria function for Vehicule (using Criteria API)
    // Filters are provided as a Map<String, Object> where keys are field names like "marque", "modele", "immatriculation", etc.
    // For relationships, use "vehiculeType.libelle", "carburantType.libelle"
    // Supports exact match for strings, equality for numbers, etc.

    public List<Vehicule> searchVehiculesWithFilters(Map<String, Object> filters) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<Vehicule> cq = cb.createQuery(Vehicule.class);
            Root<Vehicule> root = cq.from(Vehicule.class);

            List<Predicate> predicates = new ArrayList<>();

            for (Map.Entry<String, Object> entry : filters.entrySet()) {
                String key = entry.getKey();
                Object value = entry.getValue();

                if (value == null) continue;

                switch (key) {
                    case "marque":
                        predicates.add(cb.equal(root.get("marque"), value));
                        break;
                    case "modele":
                        predicates.add(cb.equal(root.get("modele"), value));
                        break;
                    case "immatriculation":
                        predicates.add(cb.equal(root.get("immatriculation"), value));
                        break;
                    case "maximumPassager":
                        predicates.add(cb.equal(root.get("maximumPassager"), value));
                        break;
                    case "capaciteCarburant":
                        predicates.add(cb.equal(root.get("capaciteCarburant"), value));
                        break;
                    case "depenseCarburant100km":
                        predicates.add(cb.equal(root.get("depenseCarburant100km"), value));
                        break;
                    case "vehiculeType.libelle":
                        predicates.add(cb.equal(root.get("vehiculeType").get("libelle"), value));
                        break;
                    case "carburantType.libelle":
                        predicates.add(cb.equal(root.get("carburantType").get("libelle"), value));
                        break;
                    // Add more fields as needed
                    default:
                        // Ignore unknown filters
                        break;
                }
            }

            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            TypedQuery<Vehicule> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    // New methods for VehiculeTarifTypePlace

    public List<VehiculeTarifTypePlace> getTarifTypePlacesByVehicule(Long idVehicule) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<VehiculeTarifTypePlace> query = em.createQuery(
                    "SELECT vttp FROM VehiculeTarifTypePlace vttp WHERE vttp.vehicule.id = :idVehicule",
                    VehiculeTarifTypePlace.class);
            query.setParameter("idVehicule", idVehicule);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public VehiculeTarifTypePlace getTarifTypePlaceByVehiculeAndType(Long idVehicule, Long idTypePlace) {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<VehiculeTarifTypePlace> query = em.createQuery(
                    "SELECT vttp FROM VehiculeTarifTypePlace vttp WHERE vttp.vehicule.id = :idVehicule AND vttp.typePlace.id = :idTypePlace",
                    VehiculeTarifTypePlace.class);
            query.setParameter("idVehicule", idVehicule);
            query.setParameter("idTypePlace", idTypePlace);
            List<VehiculeTarifTypePlace> results = query.getResultList();
            return results.isEmpty() ? null : results.get(0);
        } finally {
            em.close();
        }
    }

    public double getTotalTypePlaceSet (Long idVoiture) {
        List<VehiculeTarifTypePlace> typePlaces = getTarifTypePlacesByVehicule(idVoiture);

        return TableUtil.sum(typePlaces, "nombrePlace");
    }

    public VehiculeTarifTypePlace createOrUpdateTarifTypePlace(VehiculeTarifTypePlace vttp) throws Exception {

        Vehicule v = getVehiculeById(vttp.getVehicule().getId());

        double plcPrise = getTotalTypePlaceSet(v.getId());
        if(vttp.getId() != null){
            VehiculeTarifTypePlace vttOld = getTarifTypePlaceById(vttp.getId());

            plcPrise -= vttOld.getNombrePlace();
        }

        if (plcPrise + vttp.getNombrePlace() > v.getMaximumPassager()) {
            throw new Exception("Nombre de place erreur : total prise " + plcPrise + " Ajoute : " + vttp.getNombrePlace() + " Capacite : " + v.getMaximumPassager() );
        }

        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            if (vttp.getId() != null) {
                vttp = em.merge(vttp);
            } else {
                em.persist(vttp);
            }
            tx.commit();
            return vttp;
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.service;

import com.mdgtaxi.entity.Ville;
import com.mdgtaxi.util.HibernateUtil;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

public class VilleService {

    private final EntityManagerFactory emf = HibernateUtil.getEntityManagerFactory();

    public List<Ville> getAllVilles() {
        EntityManager em = emf.createEntityManager();
        try {
            TypedQuery<Ville> query = em.createQuery("SELECT v FROM Ville v", Ville.class);
            return query.getResultList();
        } finally {
            em.close();
        }
    }

    public List<Ville> searchVillesWithFilters(Map<String, Object> filters) {
        EntityManager em = emf.createEntityManager();
        try {
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<Ville> cq = cb.createQuery(Ville.class);
            Root<Ville> root = cq.from(Ville.class);

            List<Predicate> predicates = new ArrayList<>();

            for (Map.Entry<String, Object> entry : filters.entrySet()) {
                String key = entry.getKey();
                Object value = entry.getValue();

                if (value == null) continue;

                switch (key) {
                    case "nom":
                        predicates.add(cb.equal(root.get("nom"), value));
                        break;
                    case "region.id":
                        predicates.add(cb.equal(root.get("region").get("id"), value));
                        break;
                    // Add more fields as needed
                    default:
                        // Ignore unknown filters
                        break;
                }
            }

            if (!predicates.isEmpty()) {
                cq.where(cb.and(predicates.toArray(new Predicate[0])));
            }

            TypedQuery<Ville> query = em.createQuery(cq);
            return query.getResultList();
        } finally {
            em.close();
        }
    }
}
