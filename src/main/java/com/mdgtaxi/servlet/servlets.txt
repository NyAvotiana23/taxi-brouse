package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.MouvementStatusDto;
import com.mdgtaxi.dto.StatusObjectDto;
import com.mdgtaxi.entity.ChauffeurMouvementStatut;
import com.mdgtaxi.service.ChauffeurService;
import com.mdgtaxi.service.MouvementStatusCreateService;
import com.mdgtaxi.service.MouvementStatusService;
import com.mdgtaxi.service.StatusService;
import com.mdgtaxi.view.VmChauffeurActivite;
import com.mdgtaxi.view.VmChauffeurDetail;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.List;

@WebServlet("/chauffeures/detail")
public class ChauffeurDetailServlet extends HttpServlet {

    private final ChauffeurService chauffeurService = new ChauffeurService();
    private final MouvementStatusService mouvementStatusService = new MouvementStatusService();
    private final MouvementStatusCreateService mouvementStatusCreateService = new MouvementStatusCreateService();
    private final StatusService statusService = new StatusService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String idParam = req.getParameter("id");

        if (idParam == null || idParam.isEmpty()) {
            resp.sendRedirect(req.getContextPath() + "/chauffeures");
            return;
        }

        Long id = Long.parseLong(idParam);
        loadChauffeurDetails(req, id);

        req.getRequestDispatcher("/chauffeur-detail.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");
        String idParam = req.getParameter("id");

        if (idParam == null || idParam.isEmpty()) {
            resp.sendRedirect(req.getContextPath() + "/chauffeures");
            return;
        }

        Long id = Long.parseLong(idParam);

        try {
            if ("changeStatut".equals(action)) {
                handleChangeStatut(req, id);
            }

            resp.sendRedirect(req.getContextPath() + "/chauffeures/detail?id=" + id);
        } catch (Exception e) {
            req.setAttribute("error", "Erreur: " + e.getMessage());
            loadChauffeurDetails(req, id);
            req.getRequestDispatcher("/chauffeur-detail.jsp").forward(req, resp);
        }
    }

    private void loadChauffeurDetails(HttpServletRequest req, Long id) {
        // Load chauffeur detail view
        VmChauffeurDetail detail = chauffeurService.getChauffeurDetailById(id);
        req.setAttribute("detail", detail);

        // Load chauffeur activity
        VmChauffeurActivite activite = chauffeurService.getChauffeurActivite(id);
        req.setAttribute("activite", activite);

        // Load current status
        MouvementStatusDto currentStatus = mouvementStatusService.getCurrentStatus("Chauffeur", id);
        req.setAttribute("currentStatus", currentStatus);

        // Load status history
        List<MouvementStatusDto> statusHistory = mouvementStatusService.getStatusHistory("Chauffeur", id);
        req.setAttribute("statusHistory", statusHistory);

        // Load available statuses
        List<StatusObjectDto> availableStatuts = statusService.findAllStatuses("Chauffeur");
        req.setAttribute("availableStatuts", availableStatuts);
    }

    private void handleChangeStatut(HttpServletRequest req, Long chauffeurId) {
        Long idStatut = Long.valueOf(req.getParameter("idStatut"));
        String observation = req.getParameter("observation");
        String dateChangementStr = req.getParameter("dateChangement");

        LocalDateTime dateChangement;
        if (dateChangementStr != null && !dateChangementStr.isEmpty()) {
            dateChangement = LocalDateTime.parse(dateChangementStr);
        } else {
            dateChangement = LocalDateTime.now();
        }

        mouvementStatusCreateService.createMouvementStatut(
                "Chauffeur",
                chauffeurId,
                idStatut,
                dateChangement,
                observation
        );
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.StatusObjectDto;
import com.mdgtaxi.entity.Chauffeur;
import com.mdgtaxi.service.ChauffeurService;
import com.mdgtaxi.service.StatusService;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.time.LocalDate;
import java.util.List;

@WebServlet("/chauffeures")
public class ChauffeurServlet extends HttpServlet {

    private final ChauffeurService chauffeurService = new ChauffeurService();
    private final StatusService statusService = new StatusService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");

        // Load reference data
        loadReferenceData(req);

        if ("edit".equals(action)) {
            handleEdit(req);
        } else if ("view".equals(action)) {
            handleView(req, resp);
            return;
        }

        // Load all chauffeurs
        List<Chauffeur> chauffeurs = chauffeurService.getAllChauffeurs();
        req.setAttribute("chauffeurs", chauffeurs);

        req.getRequestDispatcher("/chauffeures.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        try {
            Chauffeur chauffeur = buildChauffeurFromRequest(req);

            if (chauffeur.getId() == null) {
                chauffeurService.createChauffeur(chauffeur);
            } else {
                chauffeurService.updateChauffeur(chauffeur);
            }

            resp.sendRedirect(req.getContextPath() + "/chauffeures");
        } catch (Exception e) {
            req.setAttribute("error", "Erreur lors de l'enregistrement: " + e.getMessage());
            loadReferenceData(req);
            req.getRequestDispatcher("/chauffeures.jsp").forward(req, resp);
        }
    }

    private void handleEdit(HttpServletRequest req) {
        String idParam = req.getParameter("id");
        if (idParam != null && !idParam.isEmpty()) {
            Long id = Long.valueOf(idParam);
            Chauffeur chauffeur = chauffeurService.getChauffeurById(id);
            req.setAttribute("chauffeur", chauffeur);
        }
    }

    private void handleView(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String idParam = req.getParameter("id");
        if (idParam != null && !idParam.isEmpty()) {
            req.setAttribute("id", idParam);
            req.getRequestDispatcher("/chauffeur-detail.jsp").forward(req, resp);
        } else {
            resp.sendRedirect(req.getContextPath() + "/chauffeures");
        }
    }

    private void loadReferenceData(HttpServletRequest req) {
        List<StatusObjectDto> chauffeurStatuts = statusService.findAllStatuses("Chauffeur");
        req.setAttribute("chauffeurStatuts", chauffeurStatuts);
    }

    private Chauffeur buildChauffeurFromRequest(HttpServletRequest req) {
        String idStr = req.getParameter("id");
        Chauffeur chauffeur;

        if (idStr != null && !idStr.isEmpty()) {
            chauffeur = chauffeurService.getChauffeurById(Long.valueOf(idStr));
        } else {
            chauffeur = new Chauffeur();
        }

        // Set fields
        chauffeur.setNom(req.getParameter("nom"));
        chauffeur.setPrenom(req.getParameter("prenom"));
        chauffeur.setDateNaissance(LocalDate.parse(req.getParameter("dateNaissance")));
        chauffeur.setNumeroPermis(req.getParameter("numeroPermis"));

        return chauffeur;
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.entity.Ligne;
import com.mdgtaxi.entity.Trajet;
import com.mdgtaxi.service.LigneService;
import com.mdgtaxi.service.TrajetService;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.util.List;

@WebServlet("/lignes/detail")
public class LigneDetailServlet extends HttpServlet {

    private final LigneService ligneService = new LigneService();
    private final TrajetService trajetService = new TrajetService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        Long id = Long.valueOf(req.getParameter("id"));
        Ligne ligne = ligneService.getLigneById(id);
        List<Trajet> trajets = trajetService.getTrajetsByLigneId(id);

        req.setAttribute("ligne", ligne);
        req.setAttribute("trajets", trajets);

        req.getRequestDispatcher("/ligne-detail.jsp").forward(req, resp);
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.entity.Ligne;
import com.mdgtaxi.entity.Ville;
import com.mdgtaxi.service.LigneService;
import com.mdgtaxi.service.VilleService;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.math.BigDecimal;
import java.util.List;

@WebServlet("/lignes")
public class LigneServlet extends HttpServlet {

    private final LigneService ligneService = new LigneService();
    private final VilleService villeService = new VilleService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");

        if ("edit".equals(action)) {
            Long id = Long.valueOf(req.getParameter("id"));
            Ligne ligne = ligneService.getLigneById(id);
            req.setAttribute("ligne", ligne);
        }

        List<Ligne> lignes = ligneService.getAllLignes();
        List<Ville> villes = villeService.getAllVilles();

        req.setAttribute("lignes", lignes);
        req.setAttribute("villes", villes);

        req.getRequestDispatcher("/lignes.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String idStr = req.getParameter("id");
        Long idVilleDepart = Long.valueOf(req.getParameter("idVilleDepart"));
        Long idVilleArrivee = Long.valueOf(req.getParameter("idVilleArrivee"));
        BigDecimal distanceKm = new BigDecimal(req.getParameter("distanceKm"));

        Ligne ligne = new Ligne();
        if (idStr != null && !idStr.isEmpty()) {
            ligne = ligneService.getLigneById(Long.valueOf(idStr));
        }

        Ville villeDepart = new Ville();
        villeDepart.setId(idVilleDepart);
        ligne.setVilleDepart(villeDepart);

        Ville villeArrivee = new Ville();
        villeArrivee.setId(idVilleArrivee);
        ligne.setVilleArrivee(villeArrivee);

        ligne.setDistanceKm(distanceKm);

        if (ligne.getId() == null) {
            ligneService.createLigne(ligne);
        } else {
            ligneService.updateLigne(ligne);
        }

        resp.sendRedirect(req.getContextPath() + "/lignes");
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.TypeObjectDTO;
import com.mdgtaxi.entity.*;
import com.mdgtaxi.service.ClientService;
import com.mdgtaxi.service.ReservationService;
import com.mdgtaxi.service.TrajetService;
import com.mdgtaxi.service.TypeObjectService;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.util.List;
import java.util.Map;

@WebServlet("/reservations")
public class ReservationServlet extends HttpServlet {

    private final ReservationService reservationService = new ReservationService();
    private final TrajetService trajetService = new TrajetService();
    private final ClientService clientService = new ClientService();
    private final TypeObjectService typeObjectService = new TypeObjectService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");

        if ("edit".equals(action)) {
            Long id = Long.valueOf(req.getParameter("id"));
            TrajetReservation reservation = reservationService.getReservationById(id);
            req.setAttribute("reservation", reservation);
        }

        List<TrajetReservation> reservations = reservationService.getAllReservations();
        List<Trajet> trajets = trajetService.getAllTrajets();
        List<Client> clients = clientService.getAllClients();
        List<TypeObjectDTO> reservationStatuts = typeObjectService.findAllTypeObject("Reservation_Statut");
        Integer totalPlacesPrises = reservationService.getTotalPlacesPrises();
        Integer totalPlacesRestantes = reservationService.getTotalPlacesRestantes();

        req.setAttribute("reservations", reservations);
        req.setAttribute("trajets", trajets);
        req.setAttribute("clients", clients);
        req.setAttribute("reservationStatuts", reservationStatuts);
        req.setAttribute("totalPlacesPrises", totalPlacesPrises);
        req.setAttribute("totalPlacesRestantes", totalPlacesRestantes);

        req.getRequestDispatcher("/reservations.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String idStr = req.getParameter("id");
        Long idTrajet = Long.valueOf(req.getParameter("idTrajet"));
        Long idClient = Long.valueOf(req.getParameter("idClient"));
        String nomPassager = req.getParameter("nomPassager");
        String numeroSiege = req.getParameter("numeroSiege");
        Long idReservationStatut = Long.valueOf(req.getParameter("idReservationStatut"));
        Integer nombrePlaceReservation = Integer.valueOf(req.getParameter("nombrePlaceReservation"));

        TrajetReservation reservation = new TrajetReservation();
        if (idStr != null && !idStr.isEmpty()) {
            reservation = reservationService.getReservationById(Long.valueOf(idStr));
        }

        Trajet trajet = new Trajet();
        trajet.setId(idTrajet);
        reservation.setTrajet(trajet);

        Client client = new Client();
        client.setId(idClient);
        reservation.setClient(client);

        reservation.setNomPassager(nomPassager);
        reservation.setNumeroSiege(numeroSiege);

        ReservationStatut statut = new ReservationStatut();
        statut.setId(idReservationStatut);
        reservation.setReservationStatut(statut);

        reservation.setNombrePlaceReservation(nombrePlaceReservation);

        try {
            if (reservation.getId() == null) {
                reservationService.createReservation(reservation);
            } else {
                reservationService.updateReservation(reservation);
            }
            resp.sendRedirect(req.getContextPath() + "/reservations");
        } catch (Exception e) {
            req.setAttribute("error", "Erreur lors de l'enregistrement: " + e.getMessage());
            doGet(req, resp);  // Re-forward to show error
        }
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.TypeObjectDTO;
import com.mdgtaxi.entity.Client;
import com.mdgtaxi.entity.Trajet;
import com.mdgtaxi.entity.TrajetReservation;
import com.mdgtaxi.service.ClientService;
import com.mdgtaxi.service.ReservationService;
import com.mdgtaxi.service.TrajetService;
import com.mdgtaxi.service.TypeObjectService;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.util.List;

@WebServlet("/trajets/detail")
public class TrajetDetailServlet extends HttpServlet {

    private final TrajetService trajetService = new TrajetService();
    private final ReservationService reservationService = new ReservationService();
    private final ClientService clientService = new ClientService();
    private final TypeObjectService typeObjectService = new TypeObjectService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        Long id = Long.valueOf(req.getParameter("id"));
        Trajet trajet = trajetService.getTrajetById(id);
        List<TrajetReservation> reservations = reservationService.getReservationsByTrajetId(id);
        int placesPrises = reservationService.getPlacesPrisesForTrajet(id);
        int placesRestantes = trajet.getVehicule().getMaximumPassager() - placesPrises;
        List<Client> clients = clientService.getAllClients();  // If needed for form, etc.
        List<TypeObjectDTO> reservationStatuts = typeObjectService.findAllTypeObject("Reservation_Statut");

        req.setAttribute("trajet", trajet);
        req.setAttribute("placesPrises", placesPrises);
        req.setAttribute("placesRestantes", placesRestantes);
        req.setAttribute("reservations", reservations);
        req.setAttribute("clients", clients);
        req.setAttribute("reservationStatuts", reservationStatuts);

        req.getRequestDispatcher("/trajet-detail.jsp").forward(req, resp);
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.TypeObjectDTO;
import com.mdgtaxi.entity.*;
import com.mdgtaxi.service.*;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;

@WebServlet("/trajets")
public class TrajetServlet extends HttpServlet {

    private final TrajetService trajetService = new TrajetService();
    private final LigneService ligneService = new LigneService();
    private final ChauffeurService chauffeurService = new ChauffeurService();
    private final VehiculeService vehiculeService = new VehiculeService();
    private final TypeObjectService typeObjectService = new TypeObjectService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");

        if ("edit".equals(action)) {
            Long id = Long.valueOf(req.getParameter("id"));
            Trajet trajet = trajetService.getTrajetById(id);
            req.setAttribute("trajet", trajet);
        }

        List<Trajet> trajets = trajetService.getAllTrajets();
        List<Ligne> lignes = ligneService.getAllLignes();
        List<Chauffeur> chauffeurs = chauffeurService.getAllChauffeurs();
        List<Vehicule> vehicules = vehiculeService.getAllVehicules();
        List<TypeObjectDTO> trajetStatuts = typeObjectService.findAllTypeObject("Trajet_Statut");

        req.setAttribute("trajets", trajets);
        req.setAttribute("lignes", lignes);
        req.setAttribute("chauffeurs", chauffeurs);
        req.setAttribute("vehicules", vehicules);
        req.setAttribute("trajetStatuts", trajetStatuts);

        req.getRequestDispatcher("/trajets.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String idStr = req.getParameter("id");
        Long idLigne = Long.valueOf(req.getParameter("idLigne"));
        Long idChauffeur = Long.valueOf(req.getParameter("idChauffeur"));
        Long idVehicule = Long.valueOf(req.getParameter("idVehicule"));
        LocalDateTime datetimeDepart = LocalDateTime.parse(req.getParameter("datetimeDepart"));
        LocalDateTime datetimeArrivee = req.getParameter("datetimeArrivee") != null && !req.getParameter("datetimeArrivee").isEmpty()
                ? LocalDateTime.parse(req.getParameter("datetimeArrivee")) : null;
        Long idTrajetStatut = Long.valueOf(req.getParameter("idTrajetStatut"));
        BigDecimal fraisUnitaire = new BigDecimal(req.getParameter("fraisUnitaire"));

        Trajet trajet = new Trajet();
        if (idStr != null && !idStr.isEmpty()) {
            trajet = trajetService.getTrajetById(Long.valueOf(idStr));
        }

        Ligne ligne = new Ligne();
        ligne.setId(idLigne);
        trajet.setLigne(ligne);

        Chauffeur chauffeur = new Chauffeur();
        chauffeur.setId(idChauffeur);
        trajet.setChauffeur(chauffeur);

        Vehicule vehicule = new Vehicule();
        vehicule.setId(idVehicule);
        trajet.setVehicule(vehicule);

        trajet.setDatetimeDepart(datetimeDepart);
        trajet.setDatetimeArrivee(datetimeArrivee);

        TrajetStatut statut = new TrajetStatut();
        statut.setId(idTrajetStatut);
        trajet.setTrajetStatut(statut);

        trajet.setFraisUnitaire(fraisUnitaire);

        if (trajet.getId() == null) {
            trajetService.createTrajet(trajet);
        } else {
            trajetService.updateTrajet(trajet);
        }

        resp.sendRedirect(req.getContextPath() + "/trajets");
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.MouvementStatusDto;
import com.mdgtaxi.dto.StatusObjectDto;
import com.mdgtaxi.entity.VehiculeEntretien;
import com.mdgtaxi.entity.VehiculeStatut;
import com.mdgtaxi.service.MouvementStatusCreateService;
import com.mdgtaxi.service.MouvementStatusService;
import com.mdgtaxi.service.StatusService;
import com.mdgtaxi.service.VehiculeService;
import com.mdgtaxi.view.VmVehiculeCoutEntretien;
import com.mdgtaxi.view.VmVehiculeDetail;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;

@WebServlet("/vehicules/detail")
public class VehiculeDetailServlet extends HttpServlet {

    private final VehiculeService vehiculeService = new VehiculeService();
    private final MouvementStatusService mouvementStatusService = new MouvementStatusService();
    private final MouvementStatusCreateService mouvementStatusCreateService = new MouvementStatusCreateService();
    private final StatusService statusService = new StatusService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String idParam = req.getParameter("id");

        if (idParam == null || idParam.isEmpty()) {
            resp.sendRedirect(req.getContextPath() + "/vehicules");
            return;
        }

        Long id = Long.parseLong(idParam);
        loadVehiculeDetails(req, id);

        req.getRequestDispatcher("/vehicule-detail.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");
        String idParam = req.getParameter("id");

        if (idParam == null || idParam.isEmpty()) {
            resp.sendRedirect(req.getContextPath() + "/vehicules");
            return;
        }

        Long id = Long.parseLong(idParam);

        try {
            if ("changeStatut".equals(action)) {
                handleChangeStatut(req, id);
            } else if ("addEntretien".equals(action)) {
                handleAddEntretien(req, id);
            }

            resp.sendRedirect(req.getContextPath() + "/vehicules/detail?id=" + id);
        } catch (Exception e) {
            req.setAttribute("error", "Erreur: " + e.getMessage());
            loadVehiculeDetails(req, id);
            req.getRequestDispatcher("/vehicule-detail.jsp").forward(req, resp);
        }
    }

    private void loadVehiculeDetails(HttpServletRequest req, Long id) {
        // Load vehicle detail
        VmVehiculeDetail detail = vehiculeService.getVehiculeDetail(id);
        req.setAttribute("detail", detail);

        // Load maintenance cost
        VmVehiculeCoutEntretien cout = vehiculeService.getCoutEntretien(id);
        req.setAttribute("cout", cout);

        // Load maintenance history
        List<VehiculeEntretien> entretiens = vehiculeService.getEntretiensByVehicule(id);
        req.setAttribute("entretiens", entretiens);

        // Load current status
        MouvementStatusDto currentStatus = mouvementStatusService.getCurrentStatus("Vehicule", id);
        req.setAttribute("currentStatus", currentStatus);

        // Load status history
        List<MouvementStatusDto> statusHistory = mouvementStatusService.getStatusHistory("Vehicule", id);
        req.setAttribute("statusHistory", statusHistory);

        // Load available statuses
        List<StatusObjectDto> availableStatuts = statusService.findAllStatuses("Vehicule");
        req.setAttribute("availableStatuts", availableStatuts);
    }

    private void handleChangeStatut(HttpServletRequest req, Long vehiculeId) {
        Long idStatut = Long.valueOf(req.getParameter("idStatut"));
        String observation = req.getParameter("observation");
        String dateChangementStr = req.getParameter("dateChangement");

        LocalDateTime dateChangement;
        if (dateChangementStr != null && !dateChangementStr.isEmpty()) {
            dateChangement = LocalDateTime.parse(dateChangementStr);
        } else {
            dateChangement = LocalDateTime.now();
        }

        mouvementStatusCreateService.createMouvementStatut(
                "Vehicule",
                vehiculeId,
                idStatut,
                dateChangement,
                observation
        );
    }

    private void handleAddEntretien(HttpServletRequest req, Long vehiculeId) {
        VehiculeEntretien entretien = new VehiculeEntretien();

        com.mdgtaxi.entity.Vehicule vehicule = new com.mdgtaxi.entity.Vehicule();
        vehicule.setId(vehiculeId);
        entretien.setVehicule(vehicule);

        entretien.setMotif(req.getParameter("motif"));
        entretien.setMontantDepense(new BigDecimal(req.getParameter("montantDepense")));

        String dateDebutStr = req.getParameter("dateDebutEntretien");
        if (dateDebutStr != null && !dateDebutStr.isEmpty()) {
            entretien.setDateDebutEntretien(LocalDateTime.parse(dateDebutStr));
        } else {
            entretien.setDateDebutEntretien(LocalDateTime.now());
        }

        String dateFinStr = req.getParameter("dateFinEntretien");
        if (dateFinStr != null && !dateFinStr.isEmpty()) {
            entretien.setDateFinEntretien(LocalDateTime.parse(dateFinStr));
        }

        vehiculeService.addEntretien(entretien);
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.StatusObjectDto;
import com.mdgtaxi.dto.TypeObjectDTO;
import com.mdgtaxi.entity.CarburantType;
import com.mdgtaxi.entity.Vehicule;
import com.mdgtaxi.entity.VehiculeType;
import com.mdgtaxi.service.StatusService;
import com.mdgtaxi.service.TypeObjectService;
import com.mdgtaxi.service.VehiculeService;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.math.BigDecimal;
import java.util.List;

@WebServlet("/vehicules")
public class VehiculeServlet extends HttpServlet {

    private final VehiculeService vehiculeService = new VehiculeService();
    private final TypeObjectService typeObjectService = new TypeObjectService();
    private final StatusService statusService = new StatusService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");

        // Load reference data for dropdowns
        loadReferenceData(req);

        if ("edit".equals(action)) {
            handleEdit(req);
        } else if ("view".equals(action)) {
            handleView(req, resp);
            return;
        }

        // Load all vehicles for the list
        List<Vehicule> vehicules = vehiculeService.getAllVehicules();
        req.setAttribute("vehicules", vehicules);

        req.getRequestDispatcher("/vehicules.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        try {
            Vehicule vehicule = buildVehiculeFromRequest(req);

            if (vehicule.getId() == null) {
                vehiculeService.createVehicule(vehicule);
            } else {
                vehiculeService.updateVehicule(vehicule);
            }

            resp.sendRedirect(req.getContextPath() + "/vehicules");
        } catch (Exception e) {
            req.setAttribute("error", "Erreur lors de l'enregistrement: " + e.getMessage());
            loadReferenceData(req);
            req.getRequestDispatcher("/vehicules.jsp").forward(req, resp);
        }
    }

    private void handleEdit(HttpServletRequest req) {
        String idParam = req.getParameter("id");
        if (idParam != null && !idParam.isEmpty()) {
            Long id = Long.valueOf(idParam);
            Vehicule vehicule = vehiculeService.getVehiculeById(id);
            req.setAttribute("vehicule", vehicule);
        }
    }

    private void handleView(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String idParam = req.getParameter("id");
        if (idParam != null && !idParam.isEmpty()) {
            req.setAttribute("id", idParam);
            req.getRequestDispatcher("/vehicule-detail.jsp").forward(req, resp);
        } else {
            resp.sendRedirect(req.getContextPath() + "/vehicules");
        }
    }

    private void loadReferenceData(HttpServletRequest req) {
        List<TypeObjectDTO> vehiculeTypes = typeObjectService.findAllTypeObject("Vehicule_Type");
        List<TypeObjectDTO> carburantTypes = typeObjectService.findAllTypeObject("Carburant_Type");
        List<StatusObjectDto> vehiculeStatuts = statusService.findAllStatuses("Vehicule");

        req.setAttribute("vehiculeTypes", vehiculeTypes);
        req.setAttribute("carburantTypes", carburantTypes);
        req.setAttribute("vehiculeStatuts", vehiculeStatuts);
    }

    private Vehicule buildVehiculeFromRequest(HttpServletRequest req) {
        String idStr = req.getParameter("id");
        Vehicule vehicule;

        if (idStr != null && !idStr.isEmpty()) {
            vehicule = vehiculeService.getVehiculeById(Long.valueOf(idStr));
        } else {
            vehicule = new Vehicule();
        }

        // Set basic fields
        vehicule.setMarque(req.getParameter("marque"));
        vehicule.setModele(req.getParameter("modele"));
        vehicule.setImmatriculation(req.getParameter("immatriculation"));
        vehicule.setMaximumPassager(Integer.valueOf(req.getParameter("maximumPassager")));

        // Set optional numeric fields
        String capaciteCarburant = req.getParameter("capaciteCarburant");
        if (capaciteCarburant != null && !capaciteCarburant.isEmpty()) {
            vehicule.setCapaciteCarburant(new BigDecimal(capaciteCarburant));
        }

        String depenseCarburant100km = req.getParameter("depenseCarburant100km");
        if (depenseCarburant100km != null && !depenseCarburant100km.isEmpty()) {
            vehicule.setDepenseCarburant100km(new BigDecimal(depenseCarburant100km));
        }

        // Set relationships
        VehiculeType vehiculeType = new VehiculeType();
        vehiculeType.setId(Long.valueOf(req.getParameter("idType")));
        vehicule.setVehiculeType(vehiculeType);

        CarburantType carburantType = new CarburantType();
        carburantType.setId(Long.valueOf(req.getParameter("idTypeCarburant")));
        vehicule.setCarburantType(carburantType);

        return vehicule;
    }
}
