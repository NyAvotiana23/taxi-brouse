package com.mdgtaxi.servlet;

import com.mdgtaxi.service.ChiffreAffaireService;
import com.mdgtaxi.view.VmCAComplet;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.util.List;

@WebServlet("/ca-complet")
public class CACompletServlet extends HttpServlet {

    private final ChiffreAffaireService caService = new ChiffreAffaireService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        // Collecte des filtres
        Integer mois = null;
        Integer annee = null;

        String moisStr = req.getParameter("mois");
        if (moisStr != null && !moisStr.isEmpty()) {
            try {
                mois = Integer.valueOf(moisStr);
            } catch (NumberFormatException e) {
                req.setAttribute("error", "Mois invalide");
            }
        }

        String anneeStr = req.getParameter("annee");
        if (anneeStr != null && !anneeStr.isEmpty()) {
            try {
                annee = Integer.valueOf(anneeStr);
            } catch (NumberFormatException e) {
                req.setAttribute("error", "AnnÃ©e invalide");
            }
        }

        // RÃ©cupÃ©rer les donnÃ©es avec ou sans filtres
        List<VmCAComplet> caComplets = caService.getCAPrevisionTotal(mois, annee);

        req.setAttribute("caComplets", caComplets);
        req.getRequestDispatcher("/ca-complet.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        // Rediriger vers GET avec les paramÃ¨tres de filtre
        StringBuilder redirectUrl = new StringBuilder(req.getContextPath() + "/ca-complet?");
        
        String mois = req.getParameter("mois");
        if (mois != null && !mois.isEmpty()) {
            redirectUrl.append("mois=").append(mois).append("&");
        }
        
        String annee = req.getParameter("annee");
        if (annee != null && !annee.isEmpty()) {
            redirectUrl.append("annee=").append(annee);
        }
        
        resp.sendRedirect(redirectUrl.toString());
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.MouvementStatusDto;
import com.mdgtaxi.dto.StatusObjectDto;
import com.mdgtaxi.entity.ChauffeurMouvementStatut;
import com.mdgtaxi.service.ChauffeurService;
import com.mdgtaxi.service.MouvementStatusCreateService;
import com.mdgtaxi.service.MouvementStatusService;
import com.mdgtaxi.service.StatusService;
import com.mdgtaxi.view.VmChauffeurActivite;
import com.mdgtaxi.view.VmChauffeurDetail;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.List;

@WebServlet("/chauffeures/detail")
public class ChauffeurDetailServlet extends HttpServlet {

    private final ChauffeurService chauffeurService = new ChauffeurService();
    private final MouvementStatusService mouvementStatusService = new MouvementStatusService();
    private final MouvementStatusCreateService mouvementStatusCreateService = new MouvementStatusCreateService();
    private final StatusService statusService = new StatusService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String idParam = req.getParameter("id");

        if (idParam == null || idParam.isEmpty()) {
            resp.sendRedirect(req.getContextPath() + "/chauffeures");
            return;
        }

        Long id = Long.parseLong(idParam);
        loadChauffeurDetails(req, id);

        req.getRequestDispatcher("/chauffeur-detail.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");
        String idParam = req.getParameter("id");

        if (idParam == null || idParam.isEmpty()) {
            resp.sendRedirect(req.getContextPath() + "/chauffeures");
            return;
        }

        Long id = Long.parseLong(idParam);

        try {
            if ("changeStatut".equals(action)) {
                handleChangeStatut(req, id);
            }

            resp.sendRedirect(req.getContextPath() + "/chauffeures/detail?id=" + id);
        } catch (Exception e) {
            req.setAttribute("error", "Erreur: " + e.getMessage());
            loadChauffeurDetails(req, id);
            req.getRequestDispatcher("/chauffeur-detail.jsp").forward(req, resp);
        }
    }

    private void loadChauffeurDetails(HttpServletRequest req, Long id) {
        // Load chauffeur detail view
        VmChauffeurDetail detail = chauffeurService.getChauffeurDetailById(id);
        req.setAttribute("detail", detail);

        // Load chauffeur activity
        VmChauffeurActivite activite = chauffeurService.getChauffeurActivite(id);
        req.setAttribute("activite", activite);

        // Load current status
        MouvementStatusDto currentStatus = mouvementStatusService.getCurrentStatus("Chauffeur", id);
        req.setAttribute("currentStatus", currentStatus);

        // Load status history
        List<MouvementStatusDto> statusHistory = mouvementStatusService.getStatusHistory("Chauffeur", id);
        req.setAttribute("statusHistory", statusHistory);

        // Load available statuses
        List<StatusObjectDto> availableStatuts = statusService.findAllStatuses("Chauffeur");
        req.setAttribute("availableStatuts", availableStatuts);
    }

    private void handleChangeStatut(HttpServletRequest req, Long chauffeurId) {
        Long idStatut = Long.valueOf(req.getParameter("idStatut"));
        String observation = req.getParameter("observation");
        String dateChangementStr = req.getParameter("dateChangement");

        LocalDateTime dateChangement;
        if (dateChangementStr != null && !dateChangementStr.isEmpty()) {
            dateChangement = LocalDateTime.parse(dateChangementStr);
        } else {
            dateChangement = LocalDateTime.now();
        }

        mouvementStatusCreateService.createMouvementStatut(
                "Chauffeur",
                chauffeurId,
                idStatut,
                dateChangement,
                observation
        );
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.StatusObjectDto;
import com.mdgtaxi.entity.Chauffeur;
import com.mdgtaxi.service.ChauffeurService;
import com.mdgtaxi.service.StatusService;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.time.LocalDate;
import java.time.format.DateTimeParseException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@WebServlet("/chauffeures")
public class ChauffeurServlet extends HttpServlet {

    private final ChauffeurService chauffeurService = new ChauffeurService();
    private final StatusService statusService = new StatusService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");

        // Load reference data
        loadReferenceData(req);

        if ("edit".equals(action)) {
            handleEdit(req);
        } else if ("view".equals(action)) {
            handleView(req, resp);
            return;
        }

        // Collect filters
        Map<String, Object> filters = new HashMap<>();

        String nom = req.getParameter("filter_nom");
        if (nom != null && !nom.isEmpty()) {
            filters.put("nom", nom);
        }

        String prenom = req.getParameter("filter_prenom");
        if (prenom != null && !prenom.isEmpty()) {
            filters.put("prenom", prenom);
        }

        String numeroPermis = req.getParameter("filter_numeroPermis");
        if (numeroPermis != null && !numeroPermis.isEmpty()) {
            filters.put("numeroPermis", numeroPermis);
        }

        String dateNaissanceStr = req.getParameter("filter_dateNaissance");
        if (dateNaissanceStr != null && !dateNaissanceStr.isEmpty()) {
            try {
                LocalDate date = LocalDate.parse(dateNaissanceStr);
                filters.put("dateNaissance", date);
            } catch (DateTimeParseException e) {
                // Ignore invalid date
            }
        }

        // Load chauffeurs with filters
        List<Chauffeur> chauffeurs = filters.isEmpty() ? chauffeurService.getAllChauffeurs() : chauffeurService.searchChauffeursWithFilters(filters);
        req.setAttribute("chauffeurs", chauffeurs);

        req.getRequestDispatcher("/chauffeures.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        try {
            Chauffeur chauffeur = buildChauffeurFromRequest(req);

            if (chauffeur.getId() == null) {
                chauffeurService.createChauffeur(chauffeur);
            } else {
                chauffeurService.updateChauffeur(chauffeur);
            }

            resp.sendRedirect(req.getContextPath() + "/chauffeures");
        } catch (Exception e) {
            req.setAttribute("error", "Erreur lors de l'enregistrement: " + e.getMessage());
            loadReferenceData(req);
            req.getRequestDispatcher("/chauffeures.jsp").forward(req, resp);
        }
    }

    private void handleEdit(HttpServletRequest req) {
        String idParam = req.getParameter("id");
        if (idParam != null && !idParam.isEmpty()) {
            Long id = Long.valueOf(idParam);
            Chauffeur chauffeur = chauffeurService.getChauffeurById(id);
            req.setAttribute("chauffeur", chauffeur);
        }
    }

    private void handleView(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String idParam = req.getParameter("id");
        if (idParam != null && !idParam.isEmpty()) {
            req.setAttribute("id", idParam);
            req.getRequestDispatcher("/chauffeur-detail.jsp").forward(req, resp);
        } else {
            resp.sendRedirect(req.getContextPath() + "/chauffeures");
        }
    }

    private void loadReferenceData(HttpServletRequest req) {
        List<StatusObjectDto> chauffeurStatuts = statusService.findAllStatuses("Chauffeur");
        req.setAttribute("chauffeurStatuts", chauffeurStatuts);
    }

    private Chauffeur buildChauffeurFromRequest(HttpServletRequest req) {
        String idStr = req.getParameter("id");
        Chauffeur chauffeur;

        if (idStr != null && !idStr.isEmpty()) {
            chauffeur = chauffeurService.getChauffeurById(Long.valueOf(idStr));
        } else {
            chauffeur = new Chauffeur();
        }

        // Set fields
        chauffeur.setNom(req.getParameter("nom"));
        chauffeur.setPrenom(req.getParameter("prenom"));
        chauffeur.setDateNaissance(LocalDate.parse(req.getParameter("dateNaissance")));
        chauffeur.setNumeroPermis(req.getParameter("numeroPermis"));

        return chauffeur;
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.service.ChiffreAffaireService;
import com.mdgtaxi.service.VilleService;
import com.mdgtaxi.service.VehiculeService;
import com.mdgtaxi.entity.Ville;
import com.mdgtaxi.entity.Vehicule;
import com.mdgtaxi.view.VmTrajetCaComplet;
import com.mdgtaxi.view.VmTrajetCaReel;
import com.mdgtaxi.view.VmTrajetPrevisionCaTotal;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.time.LocalDate;
import java.time.LocalTime;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@WebServlet("/chiffre-affaire")
public class ChiffreAffaireServlet extends HttpServlet {

    private final ChiffreAffaireService caService = new ChiffreAffaireService();
    private final VilleService villeService = new VilleService();
    private final VehiculeService vehiculeService = new VehiculeService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String type = req.getParameter("type"); // prevision, reel, complet
        String action = req.getParameter("action");
        String idTrajetStr = req.getParameter("idTrajet");

        // Charger les donnÃ©es de rÃ©fÃ©rence pour les filtres
        loadReferenceData(req);

        // Si on demande le dÃ©tail d'un trajet spÃ©cifique
        if ("detail".equals(action) && idTrajetStr != null && !idTrajetStr.isEmpty()) {
            Long idTrajet = Long.valueOf(idTrajetStr);
            handleDetail(req, type, idTrajet);
            req.getRequestDispatcher("/chiffre-affaire-detail.jsp").forward(req, resp);
            return;
        }

        // Collecter les filtres
        Map<String, Object> filters = collectFilters(req);

        // SÃ©lectionner la vue Ã  afficher selon le type
        if ("reel".equals(type)) {
            List<VmTrajetCaReel> caReels = filters.isEmpty() 
                ? caService.getAllCaReels() 
                : caService.searchCaReels(filters);
            req.setAttribute("caReels", caReels);
            req.setAttribute("type", "reel");
            req.getRequestDispatcher("/chiffre-affaire-reel.jsp").forward(req, resp);
        } else if ("complet".equals(type)) {
            List<VmTrajetCaComplet> caComplets = filters.isEmpty() 
                ? caService.getAllCaComplets() 
                : caService.searchCaComplets(filters);
            req.setAttribute("caComplets", caComplets);
            req.setAttribute("type", "complet");
            req.getRequestDispatcher("/chiffre-affaire-complet.jsp").forward(req, resp);
        } else {
            // Par dÃ©faut : prÃ©vision
            List<VmTrajetPrevisionCaTotal> previsions = filters.isEmpty() 
                ? caService.getAllPrevisions() 
                : caService.searchPrevisions(filters);
            req.setAttribute("previsions", previsions);
            req.setAttribute("type", "prevision");
            req.getRequestDispatcher("/chiffre-affaire-prevision.jsp").forward(req, resp);
        }
    }

    private void handleDetail(HttpServletRequest req, String type, Long idTrajet) {
        if ("reel".equals(type)) {
            VmTrajetCaReel caReel = caService.getCaReelByTrajetId(idTrajet);
            req.setAttribute("caReel", caReel);
            req.setAttribute("type", "reel");
        } else if ("complet".equals(type)) {
            VmTrajetCaComplet caComplet = caService.getCaCompletByTrajetId(idTrajet);
            req.setAttribute("caComplet", caComplet);
            req.setAttribute("type", "complet");
        } else {
            VmTrajetPrevisionCaTotal prevision = caService.getPrevisionByTrajetId(idTrajet);
            req.setAttribute("prevision", prevision);
            req.setAttribute("type", "prevision");
        }
    }

    private void loadReferenceData(HttpServletRequest req) {
        List<Ville> villes = villeService.getAllVilles();
        List<Vehicule> vehicules = vehiculeService.getAllVehicules();

        req.setAttribute("villes", villes);
        req.setAttribute("vehicules", vehicules);
    }

    private Map<String, Object> collectFilters(HttpServletRequest req) {
        Map<String, Object> filters = new HashMap<>();

        // Filtre par ID trajet
        String idTrajetStr = req.getParameter("idTrajet");
        if (idTrajetStr != null && !idTrajetStr.isEmpty()) {
            filters.put("idTrajet", Long.valueOf(idTrajetStr));
        }

        // Filtre par ville de dÃ©part
        String villeDepart = req.getParameter("villeDepart");
        if (villeDepart != null && !villeDepart.isEmpty()) {
            filters.put("nomVilleDepart", villeDepart);
        }

        // Filtre par ville d'arrivÃ©e
        String villeArrive = req.getParameter("villeArrive");
        if (villeArrive != null && !villeArrive.isEmpty()) {
            filters.put("nomVilleArrive", villeArrive);
        }

        // Filtre par immatriculation vÃ©hicule
        String vehicule = req.getParameter("vehicule");
        if (vehicule != null && !vehicule.isEmpty()) {
            filters.put("immatriculationVehicule", vehicule);
        }

        // Filtre par date de dÃ©part exacte
        String dateDepartStr = req.getParameter("dateDepart");
        if (dateDepartStr != null && !dateDepartStr.isEmpty()) {
            filters.put("dateDepart", LocalDate.parse(dateDepartStr));
        }

        // Filtre par plage de dates
        String dateDebut = req.getParameter("dateDebut");
        if (dateDebut != null && !dateDebut.isEmpty()) {
            filters.put("dateDepart>=", LocalDate.parse(dateDebut));
        }

        String dateFin = req.getParameter("dateFin");
        if (dateFin != null && !dateFin.isEmpty()) {
            filters.put("dateDepart<=", LocalDate.parse(dateFin));
        }

        // Filtre par heure de dÃ©part exacte
        String heureDepartStr = req.getParameter("heureDepart");
        if (heureDepartStr != null && !heureDepartStr.isEmpty()) {
            filters.put("heureDepart", LocalTime.parse(heureDepartStr));
        }

        // Filtre par plage d'heures
        String heureDebut = req.getParameter("heureDebut");
        if (heureDebut != null && !heureDebut.isEmpty()) {
            filters.put("heureDepart>=", LocalTime.parse(heureDebut));
        }

        String heureFin = req.getParameter("heureFin");
        if (heureFin != null && !heureFin.isEmpty()) {
            filters.put("heureDepart<=", LocalTime.parse(heureFin));
        }

        return filters;
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        // Rediriger vers GET avec les paramÃ¨tres de filtre
        String type = req.getParameter("type");
        if (type == null) type = "prevision";
        
        resp.sendRedirect(req.getContextPath() + "/chiffre-affaire?type=" + type + 
            "&" + req.getQueryString());
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.service.DiffusionService;
import com.mdgtaxi.view.VmDiffusionMensuelGlobal;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.util.*;

@WebServlet("/diffusions-global")
public class DiffusionGlobalServlet extends HttpServlet {

    private final DiffusionService diffusionService = new DiffusionService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        // Collecte des filtres
        Map<String, Object> filters = collectFilters(req);
        
        List<VmDiffusionMensuelGlobal> diffusionsGlobal;
        
        if (!filters.isEmpty()) {
            diffusionsGlobal = diffusionService.getDiffusionMensuel(
                (Integer) filters.get("mois"),
                (Integer) filters.get("annee"),
                (Double) filters.get("montantMin"),
                (Double) filters.get("montantMax")
            );
        } else {
            diffusionsGlobal = diffusionService.getAllDiffusionMensuel();
        }
        
        req.setAttribute("diffusionsGlobal", diffusionsGlobal);
        req.getRequestDispatcher("/diffusions-global.jsp").forward(req, resp);
    }

    private Map<String, Object> collectFilters(HttpServletRequest req) {
        Map<String, Object> filters = new HashMap<>();

        String mois = req.getParameter("mois");
        if (mois != null && !mois.isEmpty()) {
            filters.put("mois", Integer.valueOf(mois));
        }

        String annee = req.getParameter("annee");
        if (annee != null && !annee.isEmpty()) {
            filters.put("annee", Integer.valueOf(annee));
        }

        String montantMin = req.getParameter("montantMin");
        if (montantMin != null && !montantMin.isEmpty()) {
            filters.put("montantMin", Double.valueOf(montantMin));
        }

        String montantMax = req.getParameter("montantMax");
        if (montantMax != null && !montantMax.isEmpty()) {
            filters.put("montantMax", Double.valueOf(montantMax));
        }

        return filters;
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.service.*;
import com.mdgtaxi.view.VmDiffusionPaiement;
import com.mdgtaxi.entity.*;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.util.*;

@WebServlet("/paiements-dashboard")
public class DiffusionPaiementDashboardServlet extends HttpServlet {

    private final DiffusionPaiementService paiementService = new DiffusionPaiementService();
    private final SocieteService societeService = new SocieteService();
    private final PubliciteService publiciteService = new PubliciteService();
    private final TrajetService trajetService = new TrajetService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        // Load reference data for filters
        loadReferenceData(req);

        // Collect filters
        Map<String, Object> filters = collectFilters(req);

        List<VmDiffusionPaiement> vmPaiements;

        if (!filters.isEmpty()) {
            vmPaiements = paiementService.getVmPaiements(
                    (Long) filters.get("idPublicite"),
                    (List<Long>) filters.get("idSocietes"),
                    (Long) filters.get("idTrajet"),
                    (Integer) filters.get("mois"),
                    (Integer) filters.get("annee"),
                    (Integer) filters.get("nombreMin"),
                    (Integer) filters.get("nombreMax")
            );
        } else {
            vmPaiements = paiementService.getAllVmPaiements();
        }

        req.setAttribute("vmPaiements", vmPaiements);
        req.getRequestDispatcher("/paiements-dashboard.jsp").forward(req, resp);
    }

    private void loadReferenceData(HttpServletRequest req) {
        List<Societe> societes = societeService.getAllSocietes();
        List<Publicite> publicites = publiciteService.getAllPublicites();
        List<Trajet> trajets = trajetService.getAllTrajets();

        req.setAttribute("societes", societes);
        req.setAttribute("publicites", publicites);
        req.setAttribute("trajets", trajets);
    }

    private Map<String, Object> collectFilters(HttpServletRequest req) {
        Map<String, Object> filters = new HashMap<>();

        String publiciteId = req.getParameter("publiciteId");
        if (publiciteId != null && !publiciteId.isEmpty()) {
            filters.put("idPublicite", Long.valueOf(publiciteId));
        }

        String[] societeIds = req.getParameterValues("societeIds");
        if (societeIds != null && societeIds.length > 0) {
            List<Long> idSocietes = new ArrayList<>();
            for (String id : societeIds) {
                if (!id.isEmpty()) {
                    idSocietes.add(Long.valueOf(id));
                }
            }
            if (!idSocietes.isEmpty()) {
                filters.put("idSocietes", idSocietes);
            }
        }

        String trajetId = req.getParameter("trajetId");
        if (trajetId != null && !trajetId.isEmpty()) {
            filters.put("idTrajet", Long.valueOf(trajetId));
        }

        String mois = req.getParameter("mois");
        if (mois != null && !mois.isEmpty()) {
            filters.put("mois", Integer.valueOf(mois));
        }

        String annee = req.getParameter("annee");
        if (annee != null && !annee.isEmpty()) {
            filters.put("annee", Integer.valueOf(annee));
        }

        String nombreMin = req.getParameter("nombreMin");
        if (nombreMin != null && !nombreMin.isEmpty()) {
            filters.put("nombreMin", Integer.valueOf(nombreMin));
        }

        String nombreMax = req.getParameter("nombreMax");
        if (nombreMax != null && !nombreMax.isEmpty()) {
            filters.put("nombreMax", Integer.valueOf(nombreMax));
        }

        return filters;
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.entity.*;
import com.mdgtaxi.service.*;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

@WebServlet("/paiements")
public class DiffusionPaiementServlet extends HttpServlet {

    private final DiffusionPaiementService paiementService = new DiffusionPaiementService();
    private final DiffusionService diffusionService = new DiffusionService();
    private final SocieteService societeService = new SocieteService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");
        String idStr = req.getParameter("id");
        Long id = idStr != null && !idStr.isEmpty() ? Long.valueOf(idStr) : null;

        loadReferenceData(req);

        if ("edit".equals(action)) {
            if (id != null) {
                DiffusionPaiement paiement = paiementService.getPaiementById(id);
                req.setAttribute("paiement", paiement);
            }
        } else if ("detail".equals(action)) {
            if (id != null) {
                handleDetail(req, id);
                req.getRequestDispatcher("/paiement-detail.jsp").forward(req, resp);
                return;
            }
        } else if ("delete".equals(action)) {
            if (id != null) {
                paiementService.deletePaiement(id);
                resp.sendRedirect(req.getContextPath() + "/paiements");
                return;
            }
        }

        List<DiffusionPaiement> paiements = paiementService.getAllPaiements();
        req.setAttribute("paiements", paiements);
        req.getRequestDispatcher("/paiements.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");
        String idStr = req.getParameter("id");
        Long id = idStr != null && !idStr.isEmpty() ? Long.valueOf(idStr) : null;

        try {
            if ("delete".equals(action) && id != null) {
                paiementService.deletePaiement(id);
                resp.sendRedirect(req.getContextPath() + "/paiements");
            } else if ("update".equals(action) && id != null) {
                DiffusionPaiement paiement = buildPaiementFromRequest(req);
                paiement.setId(id);
                paiementService.updatePaiement(paiement);
                resp.sendRedirect(req.getContextPath() + "/paiements?action=detail&id=" + id);
            } else {
                // Create
                DiffusionPaiement paiement = buildPaiementFromRequest(req);
                paiement = paiementService.createPaiement(paiement);
                resp.sendRedirect(req.getContextPath() + "/paiements");
            }
        } catch (Exception e) {
            req.setAttribute("error", "Erreur: " + e.getMessage());
            loadReferenceData(req);
            if (id != null) {
                handleDetail(req, id);
                req.getRequestDispatcher("/paiement-detail.jsp").forward(req, resp);
            } else {
                req.getRequestDispatcher("/paiements.jsp").forward(req, resp);
            }
        }
    }

    private void loadReferenceData(HttpServletRequest req) {
        List<Diffusion> diffusions = diffusionService.getAllDiffusions();
        List<Societe> societes = societeService.getAllSocietes();

        req.setAttribute("diffusions", diffusions);
        req.setAttribute("societes", societes);
    }

    private void handleDetail(HttpServletRequest req, Long id) {
        DiffusionPaiement paiement = paiementService.getPaiementById(id);
        req.setAttribute("paiement", paiement);
    }

    private DiffusionPaiement buildPaiementFromRequest(HttpServletRequest req) {
        DiffusionPaiement paiement = new DiffusionPaiement();

        Diffusion diffusion = new Diffusion();
        diffusion.setId(Long.valueOf(req.getParameter("idDiffusion")));
        paiement.setDiffusion(diffusion);

        Societe societe = new Societe();
        societe.setId(Long.valueOf(req.getParameter("idSociete")));
        paiement.setSociete(societe);

        String datePaiementStr = req.getParameter("datePaiement");
        if (datePaiementStr != null && !datePaiementStr.isEmpty()) {
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm");
            paiement.setDatePaiement(LocalDateTime.parse(datePaiementStr, formatter));
        } else {
            paiement.setDatePaiement(LocalDateTime.now());
        }

        paiement.setMontantPaye(new BigDecimal(req.getParameter("montant")));

        return paiement;
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.entity.*;
import com.mdgtaxi.service.*;
import com.mdgtaxi.view.VmDiffusionPaiement;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

@WebServlet("/diffusions")
public class DiffusionServlet extends HttpServlet {

    private final DiffusionService diffusionService = new DiffusionService();
    private final DiffusionDetailService diffusionDetailService = new DiffusionDetailService();
    private final DiffusionPaiementService paiementService = new DiffusionPaiementService();
    private final SocieteService societeService = new SocieteService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");
        String idStr = req.getParameter("id");
        Long id = idStr != null && !idStr.isEmpty() ? Long.valueOf(idStr) : null;

        loadReferenceData(req);

        if ("detail".equals(action)) {
            if (id != null) {
                handleDetail(req, id);
                req.getRequestDispatcher("/diffusion-detail.jsp").forward(req, resp);
                return;
            }
        } else if ("delete".equals(action)) {
            if (id != null) {
                diffusionService.deleteDiffusion(id);
                resp.sendRedirect(req.getContextPath() + "/diffusions");
                return;
            }
        }

        // Liste des diffusions avec leurs montants
        List<VmDiffusionPaiement> vmDiffusions = paiementService.getAllVmPaiements();
        req.setAttribute("vmDiffusions", vmDiffusions);
        req.getRequestDispatcher("/diffusions.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");
        String idStr = req.getParameter("id");
        Long id = idStr != null && !idStr.isEmpty() ? Long.valueOf(idStr) : null;

        try {
            if ("createPaiement".equals(action) && id != null) {
                // CrÃ©er un paiement pour une diffusion
                DiffusionPaiement paiement = buildPaiementFromRequest(req, id);
                paiementService.createPaiementAvecRepartition(paiement);
                resp.sendRedirect(req.getContextPath() + "/diffusions?action=detail&id=" + id);
            } else if ("delete".equals(action) && id != null) {
                diffusionService.deleteDiffusion(id);
                resp.sendRedirect(req.getContextPath() + "/diffusions");
            } else {
                resp.sendRedirect(req.getContextPath() + "/diffusions");
            }
        } catch (Exception e) {
            req.setAttribute("error", "Erreur: " + e.getMessage());
            loadReferenceData(req);
            if (id != null) {
                handleDetail(req, id);
                req.getRequestDispatcher("/diffusion-detail.jsp").forward(req, resp);
            } else {
                req.getRequestDispatcher("/diffusions.jsp").forward(req, resp);
            }
        }
    }

    private void loadReferenceData(HttpServletRequest req) {
        List<Societe> societes = societeService.getAllSocietes();
        req.setAttribute("societes", societes);
    }

    private void handleDetail(HttpServletRequest req, Long id) {
        Diffusion diffusion = diffusionService.getDiffusionById(id);
        List<DiffusionDetail> details = diffusionDetailService.getDetailsByDiffusionId(id);
        List<DiffusionPaiement> paiements = paiementService.getPaiementsByDiffusionId(id);

        // Calculer le total Ã  payer
        BigDecimal montantTotal = BigDecimal.ZERO;
        for (DiffusionDetail detail : details) {
            BigDecimal montantDetail = detail.getMontantUnitaire()
                    .multiply(new BigDecimal(detail.getNombreRepetition()));
            montantTotal = montantTotal.add(montantDetail);
        }

        // Calculer le total payÃ©
        BigDecimal montantPaye = BigDecimal.ZERO;
        for (DiffusionPaiement paiement : paiements) {
            montantPaye = montantPaye.add(paiement.getMontantPaye());
        }

        // Calculer le reste
        BigDecimal montantReste = montantTotal.subtract(montantPaye);

        req.setAttribute("diffusion", diffusion);
        req.setAttribute("details", details);
        req.setAttribute("paiements", paiements);
        req.setAttribute("montantTotal", montantTotal);
        req.setAttribute("montantPaye", montantPaye);
        req.setAttribute("montantReste", montantReste);
    }

    private DiffusionPaiement buildPaiementFromRequest(HttpServletRequest req, Long diffusionId) {
        DiffusionPaiement paiement = new DiffusionPaiement();

        Diffusion diffusion = new Diffusion();
        diffusion.setId(diffusionId);
        paiement.setDiffusion(diffusion);

        Societe societe = new Societe();
        societe.setId(Long.valueOf(req.getParameter("idSociete")));
        paiement.setSociete(societe);

        String datePaiementStr = req.getParameter("datePaiement");
        if (datePaiementStr != null && !datePaiementStr.isEmpty()) {
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm");
            paiement.setDatePaiement(LocalDateTime.parse(datePaiementStr, formatter));
        } else {
            paiement.setDatePaiement(LocalDateTime.now());
        }

        paiement.setMontantPaye(new BigDecimal(req.getParameter("montantPaye")));

        return paiement;
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.entity.Ligne;
import com.mdgtaxi.entity.LigneDetail;
import com.mdgtaxi.entity.Trajet;
import com.mdgtaxi.service.LigneService;
import com.mdgtaxi.service.TrajetService;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.util.List;

@WebServlet("/lignes/detail")
public class LigneDetailServlet extends HttpServlet {

    private final LigneService ligneService = new LigneService();
    private final TrajetService trajetService = new TrajetService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        Long id = Long.valueOf(req.getParameter("id"));
        Ligne ligne = ligneService.getLigneById(id);
        List<Trajet> trajets = trajetService.getTrajetsByLigneId(id);
        List<LigneDetail> ligneDetails = ligneService.getLigneDetailList(id);

        req.setAttribute("ligne", ligne);
        req.setAttribute("trajets", trajets);
        req.setAttribute("ligneDetails", ligneDetails);


        req.getRequestDispatcher("/ligne-detail.jsp").forward(req, resp);
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.entity.Ligne;
import com.mdgtaxi.entity.Ville;
import com.mdgtaxi.service.LigneService;
import com.mdgtaxi.service.VilleService;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.math.BigDecimal;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@WebServlet("/lignes")
public class LigneServlet extends HttpServlet {

    private final LigneService ligneService = new LigneService();
    private final VilleService villeService = new VilleService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");

        if ("edit".equals(action)) {
            Long id = Long.valueOf(req.getParameter("id"));
            Ligne ligne = ligneService.getLigneById(id);
            req.setAttribute("ligne", ligne);
        }

        // Build filters map from request parameters
        Map<String, Object> filters = new HashMap<>();

        String idVilleDepart = req.getParameter("idVilleDepart");
        if (idVilleDepart != null && !idVilleDepart.isEmpty()) {
            filters.put("villeDepart.id", Long.valueOf(idVilleDepart));
        }

        String idVilleArrivee = req.getParameter("idVilleArrivee");
        if (idVilleArrivee != null && !idVilleArrivee.isEmpty()) {
            filters.put("villeArrivee.id", Long.valueOf(idVilleArrivee));
        }

        String distanceKm = req.getParameter("distanceKm");
        if (distanceKm != null && !distanceKm.isEmpty()) {
            filters.put("distanceKm", new BigDecimal(distanceKm));
        }

        String minDistance = req.getParameter("minDistance");
        if (minDistance != null && !minDistance.isEmpty()) {
            filters.put("distanceKm>=", new BigDecimal(minDistance));
        }

        String maxDistance = req.getParameter("maxDistance");
        if (maxDistance != null && !maxDistance.isEmpty()) {
            filters.put("distanceKm<=", new BigDecimal(maxDistance));
        }

        // Get filtered or all lignes
        List<Ligne> lignes;
        if (!filters.isEmpty()) {
            lignes = ligneService.searchLignesWithFilters(filters);
        } else {
            lignes = ligneService.getAllLignes();
        }

        List<Ville> villes = villeService.getAllVilles();

        req.setAttribute("lignes", lignes);
        req.setAttribute("villes", villes);

        req.getRequestDispatcher("/lignes.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String idStr = req.getParameter("id");
        Long idVilleDepart = Long.valueOf(req.getParameter("idVilleDepart"));
        Long idVilleArrivee = Long.valueOf(req.getParameter("idVilleArrivee"));
        BigDecimal distanceKm = new BigDecimal(req.getParameter("distanceKm"));

        Ligne ligne = new Ligne();
        if (idStr != null && !idStr.isEmpty()) {
            ligne = ligneService.getLigneById(Long.valueOf(idStr));
        }

        Ville villeDepart = new Ville();
        villeDepart.setId(idVilleDepart);
        ligne.setVilleDepart(villeDepart);

        Ville villeArrivee = new Ville();
        villeArrivee.setId(idVilleArrivee);
        ligne.setVilleArrivee(villeArrivee);

        ligne.setDistanceKm(distanceKm);

        if (ligne.getId() == null) {
            ligneService.createLigne(ligne);
        } else {
            ligneService.updateLigne(ligne);
        }

        resp.sendRedirect(req.getContextPath() + "/lignes");
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.entity.Client;
import com.mdgtaxi.entity.ProduitCategorie;
import com.mdgtaxi.entity.ProduitExtra;
import com.mdgtaxi.entity.ProduitExtraVente;
import com.mdgtaxi.entity.ProduitExtraVentePayement;
import com.mdgtaxi.service.ProduitExtraVenteService;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@WebServlet("/produit-extra-ventes")
public class ProduitExtraVenteServlet extends HttpServlet {

    private final ProduitExtraVenteService venteService = new ProduitExtraVenteService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");

        // Charger les donnÃ©es de rÃ©fÃ©rence
        loadReferenceData(req);

        if ("detail".equals(action)) {
            handleDetail(req, resp);
        } else if ("add".equals(action)) {
            req.getRequestDispatcher("/produit-extra-vente-form.jsp").forward(req, resp);
        } else if ("edit".equals(action)) {
            handleEdit(req, resp);
        } else if ("delete".equals(action)) {
            handleDelete(req, resp);
        } else if ("addPayement".equals(action)) {
            handleAddPayementForm(req, resp);
        } else {
            handleList(req, resp);
        }
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");

        if ("save".equals(action)) {
            handleSave(req, resp);
        } else if ("savePayement".equals(action)) {
            handleSavePayement(req, resp);
        } else if ("deletePayement".equals(action)) {
            handleDeletePayement(req, resp);
        } else {
            resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes");
        }
    }

    private void loadReferenceData(HttpServletRequest req) {
        List<ProduitCategorie> categories = venteService.getAllCategories();
        List<ProduitExtra> produits = venteService.getAllProduits();
        List<Client> clients = venteService.getAllClients();

        req.setAttribute("categories", categories);
        req.setAttribute("produits", produits);
        req.setAttribute("clients", clients);
    }

    private void handleList(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        Map<String, Object> filters = collectFilters(req);

        List<ProduitExtraVente> ventes;
        if (filters.isEmpty()) {
            ventes = venteService.getAllVentes();
        } else {
            ventes = venteService.searchVentes(filters);
        }

        // Calculer les montants pour chaque vente
        Map<Long, BigDecimal> montantsTotaux = new HashMap<>();
        Map<Long, BigDecimal> montantsPayes = new HashMap<>();
        Map<Long, BigDecimal> montantsRestes = new HashMap<>();

        for (ProduitExtraVente vente : ventes) {
            BigDecimal montantTotal = venteService.getMontantTotalVente(vente);
            BigDecimal montantPaye = venteService.getMontantPayeVente(vente.getId());
            BigDecimal montantReste = montantTotal.subtract(montantPaye);

            montantsTotaux.put(vente.getId(), montantTotal);
            montantsPayes.put(vente.getId(), montantPaye);
            montantsRestes.put(vente.getId(), montantReste);
        }

        req.setAttribute("ventes", ventes);
        req.setAttribute("montantsTotaux", montantsTotaux);
        req.setAttribute("montantsPayes", montantsPayes);
        req.setAttribute("montantsRestes", montantsRestes);

        req.getRequestDispatcher("/produit-extra-ventes.jsp").forward(req, resp);
    }

    private void handleDetail(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String idStr = req.getParameter("id");
        if (idStr == null || idStr.isEmpty()) {
            resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes");
            return;
        }

        Long id = Long.valueOf(idStr);
        ProduitExtraVente vente = venteService.getVenteById(id);

        if (vente == null) {
            req.setAttribute("error", "Vente non trouvÃ©e");
            resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes");
            return;
        }

        List<ProduitExtraVentePayement> payements = venteService.getPayementsByVente(id);
        BigDecimal montantTotal = venteService.getMontantTotalVente(vente);
        BigDecimal montantPaye = venteService.getMontantPayeVente(id);
        BigDecimal montantReste = montantTotal.subtract(montantPaye);

        req.setAttribute("vente", vente);
        req.setAttribute("payements", payements);
        req.setAttribute("montantTotal", montantTotal);
        req.setAttribute("montantPaye", montantPaye);
        req.setAttribute("montantReste", montantReste);

        req.getRequestDispatcher("/produit-extra-vente-detail.jsp").forward(req, resp);
    }

    private void handleEdit(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String idStr = req.getParameter("id");
        if (idStr == null || idStr.isEmpty()) {
            resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes");
            return;
        }

        Long id = Long.valueOf(idStr);
        ProduitExtraVente vente = venteService.getVenteById(id);

        if (vente == null) {
            req.setAttribute("error", "Vente non trouvÃ©e");
            resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes");
            return;
        }

        req.setAttribute("vente", vente);
        req.getRequestDispatcher("/produit-extra-vente-form.jsp").forward(req, resp);
    }

    private void handleSave(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        try {
            ProduitExtraVente vente;
            String idStr = req.getParameter("id");

            if (idStr != null && !idStr.isEmpty()) {
                vente = venteService.getVenteById(Long.valueOf(idStr));
                if (vente == null) {
                    req.setAttribute("error", "Vente non trouvÃ©e");
                    resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes");
                    return;
                }
            } else {
                vente = new ProduitExtraVente();
            }

            // RÃ©cupÃ©rer le produit
            String produitIdStr = req.getParameter("produitId");
            if (produitIdStr != null && !produitIdStr.isEmpty()) {
                ProduitExtra produit = venteService.getProduitById(Long.valueOf(produitIdStr));
                vente.setProduitExtra(produit);
                // DÃ©finir le prix unitaire depuis le produit si non spÃ©cifiÃ©
                String prixStr = req.getParameter("prixUnitaire");
                if (prixStr != null && !prixStr.isEmpty()) {
                    vente.setPrixUnitaire(new BigDecimal(prixStr));
                } else if (produit != null) {
                    vente.setPrixUnitaire(produit.getPrixUnitaire());
                }
            }

            // RÃ©cupÃ©rer le client
            String clientIdStr = req.getParameter("clientId");
            if (clientIdStr != null && !clientIdStr.isEmpty()) {
                Client client = venteService.getClientById(Long.valueOf(clientIdStr));
                vente.setClient(client);
            }

            // QuantitÃ©
            String quantiteStr = req.getParameter("quantite");
            if (quantiteStr != null && !quantiteStr.isEmpty()) {
                vente.setQuantite(Integer.valueOf(quantiteStr));
            }

            // Remise
            String remiseStr = req.getParameter("remise");
            if (remiseStr != null && !remiseStr.isEmpty()) {
                vente.setRemise(Double.valueOf(remiseStr));
            } else {
                vente.setRemise(0.0);
            }

            // Date
            String dateStr = req.getParameter("date");
            if (dateStr != null && !dateStr.isEmpty()) {
                vente.setDate(LocalDate.parse(dateStr).atStartOfDay());
            } else {
                vente.setDate(LocalDateTime.now());
            }

            venteService.saveVente(vente);
            resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes?success=Vente enregistrÃ©e avec succÃ¨s");

        } catch (Exception e) {
            req.setAttribute("error", "Erreur lors de l'enregistrement: " + e.getMessage());
            loadReferenceData(req);
            req.getRequestDispatcher("/produit-extra-vente-form.jsp").forward(req, resp);
        }
    }

    private void handleDelete(HttpServletRequest req, HttpServletResponse resp) throws IOException {
        String idStr = req.getParameter("id");
        if (idStr != null && !idStr.isEmpty()) {
            try {
                venteService.deleteVente(Long.valueOf(idStr));
                resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes?success=Vente supprimÃ©e avec succÃ¨s");
            } catch (Exception e) {
                resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes?error=Erreur lors de la suppression");
            }
        } else {
            resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes");
        }
    }

    private void handleAddPayementForm(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String venteIdStr = req.getParameter("venteId");
        if (venteIdStr == null || venteIdStr.isEmpty()) {
            resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes");
            return;
        }

        Long venteId = Long.valueOf(venteIdStr);
        ProduitExtraVente vente = venteService.getVenteById(venteId);

        if (vente == null) {
            resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes");
            return;
        }

        BigDecimal montantTotal = venteService.getMontantTotalVente(vente);
        BigDecimal montantPaye = venteService.getMontantPayeVente(venteId);
        BigDecimal montantReste = montantTotal.subtract(montantPaye);

        req.setAttribute("vente", vente);
        req.setAttribute("montantTotal", montantTotal);
        req.setAttribute("montantPaye", montantPaye);
        req.setAttribute("montantReste", montantReste);

        req.getRequestDispatcher("/produit-extra-vente-payement-form.jsp").forward(req, resp);
    }

    private void handleSavePayement(HttpServletRequest req, HttpServletResponse resp) throws IOException {
        try {
            String venteIdStr = req.getParameter("venteId");
            String montantStr = req.getParameter("montant");
            String dateStr = req.getParameter("datePayement");

            if (venteIdStr == null || venteIdStr.isEmpty() || montantStr == null || montantStr.isEmpty()) {
                resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes?error=DonnÃ©es manquantes");
                return;
            }

            ProduitExtraVente vente = venteService.getVenteById(Long.valueOf(venteIdStr));
            if (vente == null) {
                resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes?error=Vente non trouvÃ©e");
                return;
            }

            ProduitExtraVentePayement payement = new ProduitExtraVentePayement();
            payement.setProduitExtraVente(vente);
            payement.setMontant(new BigDecimal(montantStr));

            if (dateStr != null && !dateStr.isEmpty()) {
                payement.setDatePayement(LocalDate.parse(dateStr).atStartOfDay());
            } else {
                payement.setDatePayement(LocalDateTime.now());
            }

            venteService.savePayement(payement);
            resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes?action=detail&id=" + venteIdStr + "&success=Paiement enregistrÃ©");

        } catch (Exception e) {
            resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes?error=Erreur lors de l'enregistrement du paiement");
        }
    }

    private void handleDeletePayement(HttpServletRequest req, HttpServletResponse resp) throws IOException {
        String payementIdStr = req.getParameter("payementId");
        String venteIdStr = req.getParameter("venteId");

        if (payementIdStr != null && !payementIdStr.isEmpty()) {
            try {
                venteService.deletePayement(Long.valueOf(payementIdStr));
                resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes?action=detail&id=" + venteIdStr + "&success=Paiement supprimÃ©");
            } catch (Exception e) {
                resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes?action=detail&id=" + venteIdStr + "&error=Erreur lors de la suppression");
            }
        } else {
            resp.sendRedirect(req.getContextPath() + "/produit-extra-ventes");
        }
    }

    private Map<String, Object> collectFilters(HttpServletRequest req) {
        Map<String, Object> filters = new HashMap<>();

        String produitIdStr = req.getParameter("produitId");
        if (produitIdStr != null && !produitIdStr.isEmpty()) {
            filters.put("produitId", Long.valueOf(produitIdStr));
        }

        String categorieIdStr = req.getParameter("categorieId");
        if (categorieIdStr != null && !categorieIdStr.isEmpty()) {
            filters.put("categorieId", Long.valueOf(categorieIdStr));
        }

        String clientIdStr = req.getParameter("clientId");
        if (clientIdStr != null && !clientIdStr.isEmpty()) {
            filters.put("clientId", Long.valueOf(clientIdStr));
        }

        String dateDebut = req.getParameter("dateDebut");
        if (dateDebut != null && !dateDebut.isEmpty()) {
            filters.put("dateDebut", LocalDate.parse(dateDebut).atStartOfDay());
        }

        String dateFin = req.getParameter("dateFin");
        if (dateFin != null && !dateFin.isEmpty()) {
            filters.put("dateFin", LocalDate.parse(dateFin).atTime(23, 59, 59));
        }

        return filters;
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.StatusObjectDto;
import com.mdgtaxi.dto.TypeObjectDTO;
import com.mdgtaxi.entity.*;
import com.mdgtaxi.service.*;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;
import java.util.HashMap;

@WebServlet("/reservations/detail")
public class ReservationDetailServlet extends HttpServlet {

    private final ReservationService reservationService = new ReservationService();
    private final ClientService clientService = new ClientService();
    private final TrajetService trajetService = new TrajetService();
    private final StatusService statusService = new StatusService();
    private final TypeObjectService typeObjectService = new TypeObjectService();
    private final VehiculeService vehiculeService = new VehiculeService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String idParam = req.getParameter("id");

        if (idParam == null || idParam.isEmpty()) {
            resp.sendRedirect(req.getContextPath() + "/reservations");
            return;
        }

        Long id = Long.parseLong(idParam);
        String action = req.getParameter("action");

        // Handle edit detail
        if ("editDetail".equals(action)) {
            String detailIdStr = req.getParameter("detailId");
            if (detailIdStr != null && !detailIdStr.isEmpty()) {
                TrajetReservationDetails detail = reservationService.getReservationDetailById(Long.valueOf(detailIdStr));
                req.setAttribute("editingDetail", detail);
            }
        }

        loadReservationDetails(req, id);
        req.getRequestDispatcher("/reservation-detail.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");
        String idParam = req.getParameter("id");

        if (idParam == null || idParam.isEmpty()) {
            resp.sendRedirect(req.getContextPath() + "/reservations");
            return;
        }

        Long id = Long.parseLong(idParam);

        try {
            switch (action != null ? action : "") {
                case "changeStatut":
                    handleChangeStatut(req, id);
                    break;
                case "addPayment":
                    handleAddPayment(req, id);
                    break;
                case "addDetail":
                    handleAddDetail(req, id);
                    break;
                case "updateDetail":
                    handleUpdateDetail(req, id);
                    break;
                case "deleteDetail":
                    handleDeleteDetail(req, id);
                    break;
                default:
                    break;
            }

            resp.sendRedirect(req.getContextPath() + "/reservations/detail?id=" + id);
        } catch (Exception e) {
            e.printStackTrace();
            req.setAttribute("error", "Erreur: " + e.getMessage());
            loadReservationDetails(req, id);
            req.getRequestDispatcher("/reservation-detail.jsp").forward(req, resp);
        }
    }

    private void loadReservationDetails(HttpServletRequest req, Long id) {
        TrajetReservation reservation = reservationService.getReservationById(id);
        req.setAttribute("reservation", reservation);

        // Load reservation details (types de places)
        List<TrajetReservationDetails> reservationDetails = reservationService.getReservationDetailsByReservationId(id);
        req.setAttribute("reservationDetails", reservationDetails);

        // Load payments
        List<TrajetReservationPaiement> payments = reservationService.getPaymentsByReservation(id);
        req.setAttribute("payments", payments);

        // Load status history
        List<TrajetReservationMouvementStatut> statusHistory = reservationService.getStatusHistoryByReservation(id);
        req.setAttribute("statusHistory", statusHistory);

        // Calculate amounts
        BigDecimal montantTotal = reservationService.getMontantTotalReservation(id);
        BigDecimal montantPaye = reservationService.getTotalPaiementRecu(id);
        BigDecimal soldeRestant = reservationService.getSoldeRestant(id);

        req.setAttribute("montantTotal", montantTotal);
        req.setAttribute("montantPaye", montantPaye);
        req.setAttribute("soldeRestant", soldeRestant);

        // Load reference data
        List<Client> clients = clientService.getAllClients();
        req.setAttribute("clients", clients);

        List<Trajet> trajets = trajetService.getAllTrajets();
        req.setAttribute("trajets", trajets);

        List<StatusObjectDto> reservationStatuts = statusService.findAllStatuses("Trajet_Reservation");
        req.setAttribute("reservationStatuts", reservationStatuts);

        List<TypeObjectDTO> modePaiements = typeObjectService.findAllTypeObject("Mode_Paiement");
        req.setAttribute("modePaiements", modePaiements);

        // Load available type places for this vehicle
        List<VehiculeTarifTypePlace> tarifPlaces = vehiculeService.getTarifTypePlacesByVehicule(
                reservation.getTrajet().getVehicule().getId()
        );
        req.setAttribute("tarifPlaces", tarifPlaces);

        // Calculate sold per type for availability
        Map<Long, Double> soldPerType = trajetService.getSoldPlacesPerType(reservation.getTrajet().getId());
        req.setAttribute("soldPerType", soldPerType);

        // Load categories for remise
        List<TypeObjectDTO> categories = typeObjectService.findAllTypeObject("Categorie_Personne");
        req.setAttribute("categories", categories);
    }

    private void handleChangeStatut(HttpServletRequest req, Long reservationId) {
        Long idStatut = Long.valueOf(req.getParameter("idStatut"));
        String observation = req.getParameter("observation");
        LocalDateTime dateChangement = LocalDateTime.now();

        TrajetReservationMouvementStatut mouvement = new TrajetReservationMouvementStatut();
        TrajetReservation reservation = new TrajetReservation();
        reservation.setId(reservationId);
        mouvement.setTrajetReservation(reservation);

        ReservationStatut statut = new ReservationStatut();
        statut.setId(idStatut);
        mouvement.setNouveauStatut(statut);
        mouvement.setDateMouvement(dateChangement);
        mouvement.setObservation(observation);

        reservationService.changeStatus(mouvement);
    }

    private void handleAddPayment(HttpServletRequest req, Long reservationId) {
        BigDecimal montant = new BigDecimal(req.getParameter("montant"));
        Long idModePaiement = Long.valueOf(req.getParameter("idModePaiement"));
        Long idClient = Long.valueOf(req.getParameter("idClient"));
        String idCaisseStr = req.getParameter("idCaisse");
        Long idCaisse = (idCaisseStr != null && !idCaisseStr.isEmpty()) ? Long.valueOf(idCaisseStr) : null;
        LocalDateTime datePaiement = LocalDateTime.now();

        TrajetReservationPaiement paiement = new TrajetReservationPaiement();
        Client client = new Client();
        client.setId(idClient);
        paiement.setClient(client);

        TrajetReservation reservation = new TrajetReservation();
        reservation.setId(reservationId);
        paiement.setTrajetReservation(reservation);

        if (idCaisse != null) {
            Caisse caisse = new Caisse();
            caisse.setId(idCaisse);
            paiement.setCaisse(caisse);
        }

        paiement.setMontant(montant);
        ModePaiement mode = new ModePaiement();
        mode.setId(idModePaiement);
        paiement.setModePaiement(mode);
        paiement.setDatePaiement(datePaiement);

        reservationService.createPayment(paiement);
    }

    private void handleAddDetail(HttpServletRequest req, Long reservationId) throws Exception {
        Long idTypePlace = Long.valueOf(req.getParameter("idTypePlace"));
        Long idCategoriePersonne = Long.valueOf(req.getParameter("idCategoriePersonne"));


        double nombrePlaces = Double.parseDouble(req.getParameter("nombrePlaces"));

        TrajetReservation reservation = reservationService.getReservationById(reservationId);
        VehiculeTarifTypePlace tp = vehiculeService.getTarifTypePlaceById(idTypePlace);



//        Map<Long, Double> soldPerType = trajetService.getSoldPlacesPerType(reservation.getTrajet().getId());
//
//        System.out.println( " \n " + soldPerType);
//        double soldTypePlace = soldPerType.getOrDefault(idTypePlace, 0.0);;
//
//        double remaining = tp.getNombrePlace() - soldTypePlace;
//        System.out.println("Solde restante : " + remaining + " Id type place : " + idTypePlace + " \n");
//
//
//        if (nombrePlaces > remaining) {
//            throw new Exception("Erreur nombre de place exeder par rapport Ã  celle restante : reste " + remaining + " Prise : " + nombrePlaces);
//        }


        // Get tarif with remise
        double tarifUnitaire = reservationService.getTarifAvecRemise(
                reservation.getTrajet().getId(),
                idTypePlace,
                idCategoriePersonne
        );

        TrajetReservationDetails detail = new TrajetReservationDetails();
        detail.setTrajetReservation(reservation);

        TypePlace typePlace = new TypePlace();
        typePlace.setId(idTypePlace);
        detail.setTypePlace(typePlace);

        CategoriePersonne categorie = new CategoriePersonne();
        categorie.setId(idCategoriePersonne);
        detail.setCategoriePersonne(categorie);

        detail.setNombrePlaces(nombrePlaces);
        detail.setTarifUnitaire(tarifUnitaire);

        reservationService.createReservationDetail(detail);
    }

    private void handleUpdateDetail(HttpServletRequest req, Long reservationId) throws Exception {
        Long detailId = Long.valueOf(req.getParameter("detailId"));
        Long idTypePlace = Long.valueOf(req.getParameter("idTypePlace"));
        Long idCategoriePersonne = Long.valueOf(req.getParameter("idCategoriePersonne"));
        double nombrePlaces = Double.parseDouble(req.getParameter("nombrePlaces"));

        TrajetReservation reservation = reservationService.getReservationById(reservationId);
        TrajetReservationDetails detail = reservationService.getReservationDetailById(detailId);

        if (detail == null || !detail.getTrajetReservation().getId().equals(reservationId)) {
            throw new IllegalArgumentException("Invalid detail ID");
        }

        // Get tarif with remise
        double tarifUnitaire = reservationService.getTarifAvecRemise(
                reservation.getTrajet().getId(),
                idTypePlace,
                idCategoriePersonne
        );

        TypePlace typePlace = new TypePlace();
        typePlace.setId(idTypePlace);
        detail.setTypePlace(typePlace);

        CategoriePersonne categorie = new CategoriePersonne();
        categorie.setId(idCategoriePersonne);
        detail.setCategoriePersonne(categorie);

        detail.setNombrePlaces(nombrePlaces);
        detail.setTarifUnitaire(tarifUnitaire);

        reservationService.updateReservationDetail(detail);
    }

    private void handleDeleteDetail(HttpServletRequest req, Long reservationId) {
        Long detailId = Long.valueOf(req.getParameter("detailId"));
        TrajetReservationDetails detail = reservationService.getReservationDetailById(detailId);

        if (detail == null || !detail.getTrajetReservation().getId().equals(reservationId)) {
            throw new IllegalArgumentException("Invalid detail ID");
        }

        reservationService.deleteReservationDetail(detailId);
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.StatusObjectDto;
import com.mdgtaxi.dto.TypeObjectDTO;
import com.mdgtaxi.entity.*;
import com.mdgtaxi.service.*;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@WebServlet("/reservations")
public class ReservationServlet extends HttpServlet {

    private final ReservationService reservationService = new ReservationService();
    private final TrajetService trajetService = new TrajetService();
    private final ClientService clientService = new ClientService();
    private final StatusService statusService = new StatusService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");

        if ("edit".equals(action)) {
            String idStr = req.getParameter("id");
            if (idStr != null && !idStr.isEmpty()) {
                Long id = Long.valueOf(idStr);
                TrajetReservation reservation = reservationService.getReservationById(id);
                req.setAttribute("reservation", reservation);
            }
        }

        // Load data
        List<TrajetReservation> reservations = reservationService.getAllReservations();
        List<Trajet> trajets = trajetService.getAllTrajets();
        List<Client> clients = clientService.getAllClients();
        List<StatusObjectDto> reservationStatuts = statusService.findAllStatuses("Trajet_Reservation");

        // Statistics
        Map<String, Long> statsByStatus = reservationService.getReservationStatsByStatus();
        Double totalPlacesPrises = reservationService.getTotalPlacesPrises();
        Double totalPlacesRestantes = reservationService.getTotalPlacesRestantes();

        req.setAttribute("reservations", reservations);
        req.setAttribute("trajets", trajets);
        req.setAttribute("clients", clients);
        req.setAttribute("reservationStatuts", reservationStatuts);
        req.setAttribute("statsByStatus", statsByStatus);
        req.setAttribute("totalPlacesPrises", totalPlacesPrises);
        req.setAttribute("totalPlacesRestantes", totalPlacesRestantes);

        req.getRequestDispatcher("/reservations.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        try {
            String idStr = req.getParameter("id");
            Long idTrajet = Long.valueOf(req.getParameter("idTrajet"));
            Long idClient = Long.valueOf(req.getParameter("idClient"));
            String nomPassager = req.getParameter("nomPassager");
            Long idReservationStatut = Long.valueOf(req.getParameter("idReservationStatut"));

            // Create or update reservation (no details here)
            TrajetReservation reservation;
            if (idStr != null && !idStr.isEmpty()) {
                reservation = reservationService.getReservationById(Long.valueOf(idStr));
            } else {
                reservation = new TrajetReservation();
            }

            Trajet trajet = new Trajet();
            trajet.setId(idTrajet);
            reservation.setTrajet(trajet);

            Client client = new Client();
            client.setId(idClient);
            reservation.setClient(client);

            reservation.setDateReservation(LocalDateTime.now());
            reservation.setNomPassager(nomPassager);

            ReservationStatut statut = new ReservationStatut();
            statut.setId(idReservationStatut);
            reservation.setReservationStatut(statut);

            // Save reservation
            if (reservation.getId() == null) {
                reservation = reservationService.createReservation(reservation);
            } else {
                reservation = reservationService.updateReservation(reservation);
            }

            resp.sendRedirect(req.getContextPath() + "/reservations");
        } catch (Exception e) {
            req.setAttribute("error", "Erreur lors de l'enregistrement: " + e.getMessage());
            doGet(req, resp);
        }
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.entity.CategoriePersonne;
import com.mdgtaxi.entity.TrajetRemisePourcentage;
import com.mdgtaxi.service.TarifRemiseService;
import com.mdgtaxi.service.TypeObjectService;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import java.io.IOException;

@WebServlet("/tarif-remises-pourcent")
public class TarifRemisePourcentServlet extends HttpServlet {

    private final TarifRemiseService tarifRemiseService = new TarifRemiseService();
    private final TypeObjectService typeObjectService = new TypeObjectService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");

        if ("edit".equals(action)) {
            // Store the edit action in session so the main servlet can handle it
            String idStr = req.getParameter("id");
            if (idStr != null && !idStr.isEmpty()) {
                req.getSession().setAttribute("editRemisePourcentId", idStr);
            }
        }

        resp.sendRedirect(req.getContextPath() + "/tarif-remises");
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");

        try {
            if ("appliquer".equals(action)) {
                handleAppliquer(req);
                req.getSession().setAttribute("success", "Remise appliquÃ©e avec succÃ¨s!");
            } else if ("delete".equals(action)) {
                handleDelete(req);
                req.getSession().setAttribute("success", "Remise en pourcentage supprimÃ©e avec succÃ¨s!");
            } else {
                handleSave(req);
                req.getSession().setAttribute("success", "Remise en pourcentage enregistrÃ©e avec succÃ¨s!");
            }

            resp.sendRedirect(req.getContextPath() + "/tarif-remises");
        } catch (Exception e) {
            req.getSession().setAttribute("error", "Erreur: " + e.getMessage());
            resp.sendRedirect(req.getContextPath() + "/tarif-remises");
        }
    }

    private void handleSave(HttpServletRequest req) throws Exception {
        TrajetRemisePourcentage trajetRemisePourcentage = buildRemisePourcentageFromRequest(req);

        // Validate that application and reference categories are different
        if (trajetRemisePourcentage.getCategorieApplication().getId()
                .equals(trajetRemisePourcentage.getCategorieParRapport().getId())) {
            throw new Exception("La catÃ©gorie d'application ne peut pas Ãªtre la mÃªme que la catÃ©gorie de rÃ©fÃ©rence");
        }

        if (trajetRemisePourcentage.getId() == null) {
            createRemisePourcentage(trajetRemisePourcentage);
        } else {
            updateRemisePourcentage(trajetRemisePourcentage);
        }
    }

    private void handleDelete(HttpServletRequest req) {
        String idStr = req.getParameter("id");
        if (idStr != null && !idStr.isEmpty()) {
            deleteRemisePourcentage(Long.valueOf(idStr));
        }
    }

    private void handleAppliquer(HttpServletRequest req) throws Exception{
        String idStr = req.getParameter("id");
        if (idStr != null && !idStr.isEmpty()) {
            Long id = Long.valueOf(idStr);
            tarifRemiseService.appliquerRemisePourcent(id);
        }
    }

    private TrajetRemisePourcentage buildRemisePourcentageFromRequest(HttpServletRequest req) {
        String idStr = req.getParameter("id");
        TrajetRemisePourcentage trajetRemisePourcentage;

        if (idStr != null && !idStr.isEmpty()) {
            trajetRemisePourcentage = tarifRemiseService.getRemisePourcentById(Long.valueOf(idStr));
        } else {
            trajetRemisePourcentage = new TrajetRemisePourcentage();
        }

        // Set Categorie Application
        CategoriePersonne categorieApplication = new CategoriePersonne();
        categorieApplication.setId(Long.valueOf(req.getParameter("idCategorieApplication")));
        trajetRemisePourcentage.setCategorieApplication(categorieApplication);

        // Set Categorie Par Rapport
        CategoriePersonne categorieParRapport = new CategoriePersonne();
        categorieParRapport.setId(Long.valueOf(req.getParameter("idCategorieParRapport")));
        trajetRemisePourcentage.setCategorieParRapport(categorieParRapport);

        // Set Remise Pourcent
        double remisePourcent = Double.parseDouble(req.getParameter("remisePourcent"));
        trajetRemisePourcentage.setRemisePourcent(remisePourcent);

        return trajetRemisePourcentage;
    }

    // CRUD Methods using HibernateUtil pattern
    private void createRemisePourcentage(TrajetRemisePourcentage trajetRemisePourcentage) {
        EntityManagerFactory emf = com.mdgtaxi.util.HibernateUtil.getEntityManagerFactory();
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(trajetRemisePourcentage);
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    private void updateRemisePourcentage(TrajetRemisePourcentage trajetRemisePourcentage) {
        EntityManagerFactory emf = com.mdgtaxi.util.HibernateUtil.getEntityManagerFactory();
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.merge(trajetRemisePourcentage);
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    private void deleteRemisePourcentage(Long id) {
        EntityManagerFactory emf = com.mdgtaxi.util.HibernateUtil.getEntityManagerFactory();
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            TrajetRemisePourcentage trajetRemisePourcentage = em.find(TrajetRemisePourcentage.class, id);
            if (trajetRemisePourcentage != null) {
                em.remove(trajetRemisePourcentage);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.TypeObjectDTO;
import com.mdgtaxi.entity.*;
import com.mdgtaxi.service.TarifRemiseService;
import com.mdgtaxi.service.TypeObjectService;
import com.mdgtaxi.service.VehiculeService;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@WebServlet("/tarif-remises")
public class TarifRemiseServlet extends HttpServlet {

    private final TarifRemiseService tarifRemiseService = new TarifRemiseService();
    private final VehiculeService vehiculeService = new VehiculeService();
    private final TypeObjectService typeObjectService = new TypeObjectService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");

        String editRemisePourcentId = (String) req.getSession().getAttribute("editRemisePourcentId");
        if (editRemisePourcentId != null) {
            TrajetRemisePourcentage editTrajetRemisePourcentage = tarifRemiseService.getRemisePourcentById(Long.valueOf(editRemisePourcentId));
            req.setAttribute("remisePourcentage", editTrajetRemisePourcentage);
            req.getSession().removeAttribute("editRemisePourcentId");
        }

// Check for success/error messages from session
        String success = (String) req.getSession().getAttribute("success");
        if (success != null) {
            req.setAttribute("success", success);
            req.getSession().removeAttribute("success");
        }


        // Load reference data
        loadReferenceData(req);

        if ("edit".equals(action)) {
            handleEdit(req);
        }

        // Collect filters
        Map<String, Object> filters = collectFilters(req);

        // Load tarif remises with filters
        List<TrajetTarifTypePlaceCategorieRemise> tarifRemises = filters.isEmpty()
                ? tarifRemiseService.getAllTarifRemises()
                : tarifRemiseService.searchTarifRemisesWithFilters(filters);

        List<TrajetRemisePourcentage> trajetRemisePourcentages = tarifRemiseService.getAllTarifPourcentagesRemises();
        req.setAttribute("remisePourcentages", trajetRemisePourcentages);
        req.setAttribute("tarifRemises", tarifRemises);


        req.getRequestDispatcher("/tarif-remises.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");
        String trajetIdStr = req.getParameter("trajetId");
        Long trajetId = trajetIdStr != null && !trajetIdStr.isEmpty() ? Long.valueOf(trajetIdStr) : null;

        try {
            if ("delete".equals(action)) {
                handleDelete(req);
            } else if ("deletePourcent".equals(action)) {
                handleDeletePourcent(req);
            } else if ("appliquerPourcent".equals(action)) {
                handleAppliquerPourcent(req, trajetId);
            } else if ("savePourcent".equals(action)) {
                handleSavePourcent(req, trajetId);
            } else {
                handleSave(req, trajetId);
            }

            // Redirect based on context
            if (trajetId != null) {
                resp.sendRedirect(req.getContextPath() + "/trajets/detail?id=" + trajetId);
            } else {
                resp.sendRedirect(req.getContextPath() + "/tarif-remises");
            }
        } catch (Exception e) {
            req.getSession().setAttribute("error", "Erreur: " + e.getMessage());
            if (trajetId != null) {
                resp.sendRedirect(req.getContextPath() + "/trajets/detail?id=" + trajetId);
            } else {
                resp.sendRedirect(req.getContextPath() + "/tarif-remises");
            }
        }
    }

    private void handleSave(HttpServletRequest req, Long trajetId) throws Exception {
        TrajetTarifTypePlaceCategorieRemise tarifRemise = buildTarifRemiseFromRequest(req, trajetId);

        boolean exists = tarifRemiseService.existsTarifRemise(
                tarifRemise.getTrajet().getId(),
                tarifRemise.getTypePlace().getId(),
                tarifRemise.getCategoriePersonne().getId(),
                tarifRemise.getId()
        );

        if (exists) {
            throw new Exception("Un tarif avec remise existe dÃ©jÃ  pour cette combinaison");
        }

        if (tarifRemise.getId() == null) {
            tarifRemiseService.createTarifRemise(tarifRemise);
        } else {
            tarifRemiseService.updateTarifRemise(tarifRemise);
        }
    }

    private void handleSavePourcent(HttpServletRequest req, Long trajetId) throws Exception {
        TrajetRemisePourcentage remisePourcent = buildRemisePourcentFromRequest(req, trajetId);

        if (remisePourcent.getCategorieApplication().getId()
                .equals(remisePourcent.getCategorieParRapport().getId())) {
            throw new Exception("Les catÃ©gories doivent Ãªtre diffÃ©rentes");
        }

        if (remisePourcent.getId() == null) {
            createRemisePourcentage(remisePourcent);
        } else {
            updateRemisePourcentage(remisePourcent);
        }
    }

    private void handleAppliquerPourcent(HttpServletRequest req, Long trajetId) throws Exception {
        String idStr = req.getParameter("id");
        if (idStr != null && !idStr.isEmpty()) {
            Long id = Long.valueOf(idStr);
            if (trajetId != null) {
                tarifRemiseService.appliquerRemisePourcentTrajet(id, trajetId);
            } else {
                tarifRemiseService.appliquerRemisePourcent(id);
            }
        }
    }

    private void createRemisePourcentage(TrajetRemisePourcentage trajetRemisePourcentage) {
        EntityManagerFactory emf = com.mdgtaxi.util.HibernateUtil.getEntityManagerFactory();
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.persist(trajetRemisePourcentage);
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    private void updateRemisePourcentage(TrajetRemisePourcentage trajetRemisePourcentage) {
        EntityManagerFactory emf = com.mdgtaxi.util.HibernateUtil.getEntityManagerFactory();
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            em.merge(trajetRemisePourcentage);
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    private void deleteRemisePourcentage(Long id) {
        EntityManagerFactory emf = com.mdgtaxi.util.HibernateUtil.getEntityManagerFactory();
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        try {
            tx.begin();
            TrajetRemisePourcentage trajetRemisePourcentage = em.find(TrajetRemisePourcentage.class, id);
            if (trajetRemisePourcentage != null) {
                em.remove(trajetRemisePourcentage);
            }
            tx.commit();
        } catch (Exception e) {
            if (tx.isActive()) tx.rollback();
            throw e;
        } finally {
            em.close();
        }
    }

    private void handleDeletePourcent(HttpServletRequest req) {
        String idStr = req.getParameter("id");
        if (idStr != null && !idStr.isEmpty()) {
            deleteRemisePourcentage(Long.valueOf(idStr));
        }
    }

    private TrajetTarifTypePlaceCategorieRemise buildTarifRemiseFromRequest(HttpServletRequest req, Long trajetId) {
        String idStr = req.getParameter("id");
        TrajetTarifTypePlaceCategorieRemise tarifRemise;

        if (idStr != null && !idStr.isEmpty()) {
            tarifRemise = tarifRemiseService.getTarifRemiseById(Long.valueOf(idStr));
        } else {
            tarifRemise = new TrajetTarifTypePlaceCategorieRemise();
        }

        // Set Trajet
        Trajet trajet = new Trajet();
        trajet.setId(trajetId != null ? trajetId : Long.valueOf(req.getParameter("trajetId")));
        tarifRemise.setTrajet(trajet);

        // Set Type Place
        TypePlace typePlace = new TypePlace();
        typePlace.setId(Long.valueOf(req.getParameter("idTypePlace")));
        tarifRemise.setTypePlace(typePlace);

        // Set Categorie Personne
        CategoriePersonne categoriePersonne = new CategoriePersonne();
        categoriePersonne.setId(Long.valueOf(req.getParameter("idCategoriePersonne")));
        tarifRemise.setCategoriePersonne(categoriePersonne);

        // Set Tarif
        double tarifAvecRemise = Double.parseDouble(req.getParameter("tarifUnitaireAvecRemise"));
        tarifRemise.setTarifUnitaireAvecRemise(tarifAvecRemise);

        return tarifRemise;
    }

    private TrajetRemisePourcentage buildRemisePourcentFromRequest(HttpServletRequest req, Long trajetId) {
        String idStr = req.getParameter("id");
        TrajetRemisePourcentage remisePourcent;

        if (idStr != null && !idStr.isEmpty()) {
            remisePourcent = tarifRemiseService.getRemisePourcentById(Long.valueOf(idStr));
        } else {
            remisePourcent = new TrajetRemisePourcentage();
        }

        // Set Trajet
        Trajet trajet = new Trajet();
        trajet.setId(trajetId != null ? trajetId : Long.valueOf(req.getParameter("trajetId")));
        remisePourcent.setTrajet(trajet);

        // Set Categorie Application
        CategoriePersonne categorieApplication = new CategoriePersonne();
        categorieApplication.setId(Long.valueOf(req.getParameter("idCategorieApplication")));
        remisePourcent.setCategorieApplication(categorieApplication);

        // Set Categorie Par Rapport
        CategoriePersonne categorieParRapport = new CategoriePersonne();
        categorieParRapport.setId(Long.valueOf(req.getParameter("idCategorieParRapport")));
        remisePourcent.setCategorieParRapport(categorieParRapport);

        // Set Remise Pourcent
        double remise = Double.parseDouble(req.getParameter("remisePourcent"));
        remisePourcent.setRemisePourcent(remise);

        return remisePourcent;
    }

    private void loadReferenceData(HttpServletRequest req) {
        List<TypePlace> typePlaces = vehiculeService.getAllTypePlaces();
        List<TypeObjectDTO> categories = typeObjectService.findAllTypeObject("Categorie_Personne");

        req.setAttribute("typePlaces", typePlaces);
        req.setAttribute("categories", categories);
    }

    private Map<String, Object> collectFilters(HttpServletRequest req) {
        Map<String, Object> filters = new HashMap<>();

        String idTypePlace = req.getParameter("filter_idTypePlace");
        if (idTypePlace != null && !idTypePlace.isEmpty()) {
            filters.put("typePlace.id", Long.valueOf(idTypePlace));
        }

        String idCategorie = req.getParameter("filter_idCategorie");
        if (idCategorie != null && !idCategorie.isEmpty()) {
            filters.put("categoriePersonne.id", Long.valueOf(idCategorie));
        }

        String minTarif = req.getParameter("filter_minTarif");
        if (minTarif != null && !minTarif.isEmpty()) {
            filters.put("tarifUnitaireAvecRemise>=", Double.valueOf(minTarif));
        }

        String maxTarif = req.getParameter("filter_maxTarif");
        if (maxTarif != null && !maxTarif.isEmpty()) {
            filters.put("tarifUnitaireAvecRemise<=", Double.valueOf(maxTarif));
        }

        return filters;
    }

    private void handleEdit(HttpServletRequest req) {
        String idStr = req.getParameter("id");
        if (idStr != null && !idStr.isEmpty()) {
            Long id = Long.valueOf(idStr);
            TrajetTarifTypePlaceCategorieRemise tarifRemise = tarifRemiseService.getTarifRemiseById(id);
            req.setAttribute("tarifRemise", tarifRemise);
        }
    }

    private void handleSave(HttpServletRequest req) throws Exception {
        TrajetTarifTypePlaceCategorieRemise tarifRemise = buildTarifRemiseFromRequest(req);

        // Check if combination already exists
        Long excludeId = tarifRemise.getId();
        boolean exists = tarifRemiseService.existsTarifRemise(
                tarifRemise.getTrajet().getId(),
                tarifRemise.getTypePlace().getId(),
                tarifRemise.getCategoriePersonne().getId(),
                excludeId
        );

        if (exists) {
            throw new Exception("Un tarif avec remise existe dÃ©jÃ  pour cette combinaison Type de Place / CatÃ©gorie Personne");
        }

        if (tarifRemise.getId() == null) {
            tarifRemiseService.createTarifRemise(tarifRemise);
        } else {
            tarifRemiseService.updateTarifRemise(tarifRemise);
        }
    }

    private void handleDelete(HttpServletRequest req) {
        String idStr = req.getParameter("id");
        if (idStr != null && !idStr.isEmpty()) {
            tarifRemiseService.deleteTarifRemise(Long.valueOf(idStr));
        }
    }

    private TrajetTarifTypePlaceCategorieRemise buildTarifRemiseFromRequest(HttpServletRequest req) {
        String idStr = req.getParameter("id");
        TrajetTarifTypePlaceCategorieRemise tarifRemise;

        if (idStr != null && !idStr.isEmpty()) {
            tarifRemise = tarifRemiseService.getTarifRemiseById(Long.valueOf(idStr));
        } else {
            tarifRemise = new TrajetTarifTypePlaceCategorieRemise();
        }

        Trajet trajet = new Trajet();
        trajet.setId(Long.valueOf(req.getParameter("idTrajet")));

        // Set Type Place
        TypePlace typePlace = new TypePlace();
        typePlace.setId(Long.valueOf(req.getParameter("idTypePlace")));
        tarifRemise.setTypePlace(typePlace);

        // Set Categorie Personne
        CategoriePersonne categoriePersonne = new CategoriePersonne();
        categoriePersonne.setId(Long.valueOf(req.getParameter("idCategoriePersonne")));
        tarifRemise.setCategoriePersonne(categoriePersonne);

        // Set Tarif with discount
        double tarifAvecRemise = Double.parseDouble(req.getParameter("tarifUnitaireAvecRemise"));
        tarifRemise.setTarifUnitaireAvecRemise(tarifAvecRemise);

        return tarifRemise;
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.entity.Ligne;
import com.mdgtaxi.entity.Trajet;
import com.mdgtaxi.service.LigneService;
import com.mdgtaxi.service.TrajetService;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeParseException;
import java.util.List;

@WebServlet("/trajets-a-venir")
public class TrajetAVenirServlet extends HttpServlet {
    private final TrajetService trajetService = new TrajetService();
    private final LigneService ligneService = new LigneService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        LocalDateTime now = LocalDateTime.now();
        List<Ligne> lignes = ligneService.getAllLignes();
        req.setAttribute("lignes", lignes);

        String ligneIdStr = req.getParameter("idLigne");
        String dateStr = req.getParameter("date");

        Long selectedLigneId = null;
        LocalDate selectedDate = null;
        List<Trajet> trajets;
        List<LocalDate> dates = null;

        if (ligneIdStr != null && !ligneIdStr.isEmpty()) {
            try {
                selectedLigneId = Long.parseLong(ligneIdStr);
                req.setAttribute("selectedLigneId", selectedLigneId);
                dates = trajetService.getDistinctUpcomingDatesByLigne(now, selectedLigneId);
                req.setAttribute("dates", dates);

                if (dateStr != null && !dateStr.isEmpty()) {
                    try {
                        selectedDate = LocalDate.parse(dateStr);
                        req.setAttribute("selectedDate", selectedDate);
                        trajets = trajetService.getUpcomingTrajetsByLigneAndDate(now, selectedLigneId, selectedDate);
                    } catch (DateTimeParseException e) {
                        trajets = trajetService.getUpcomingTrajetsByLigne(now, selectedLigneId);
                    }
                } else {
                    trajets = trajetService.getUpcomingTrajetsByLigne(now, selectedLigneId);
                }
            } catch (NumberFormatException e) {
                trajets = trajetService.getAllUpcomingTrajets(now);
            }
        } else {
            trajets = trajetService.getAllUpcomingTrajets(now);
        }

        req.setAttribute("trajets", trajets);
        req.getRequestDispatcher("/trajets-a-venir.jsp").forward(req, resp);
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.TypeObjectDTO;
import com.mdgtaxi.entity.*;
import com.mdgtaxi.service.*;
import com.mdgtaxi.util.ExceptionUtil;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.List;

@WebServlet("/trajets/detail")
public class TrajetDetailServlet extends HttpServlet {

    private final TrajetService trajetService = new TrajetService();
    private final ReservationService reservationService = new ReservationService();
    private final ClientService clientService = new ClientService();
    private final TypeObjectService typeObjectService = new TypeObjectService();
    private final LigneService ligneService = new LigneService();


    @Override

    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        Long idClient = Long.valueOf(req.getParameter("idClient"));
        Long trajetId = Long.valueOf(req.getParameter("trajetId"));
        String nomPassager = req.getParameter("nomPassager");
        String datestr = req.getParameter("datereservation");
        LocalDateTime date = LocalDateTime.parse(datestr);
        Long idReservationStatut = Long.valueOf(req.getParameter("idReservationStatut"));

        Trajet trajet = new Trajet();
        trajet.setId(trajetId);

        ReservationStatut reservationStatut = new ReservationStatut();
        reservationStatut.setId(idReservationStatut);

        Client c =  new Client();
        c.setId(idClient);

        TrajetReservation trajetReservation = new TrajetReservation();
        trajetReservation.setTrajet(trajet);
        trajetReservation.setDateReservation(date);
        trajetReservation.setReservationStatut(reservationStatut);
        trajetReservation.setNomPassager(nomPassager);
        trajetReservation.setClient(c);

        trajetReservation = reservationService.createReservation(trajetReservation);

        resp.sendRedirect(req.getContextPath() + "/reservations/detail?id=" + trajetReservation.getId());

    }

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        Long id = Long.valueOf(req.getParameter("id"));
        String action = req.getParameter("action");

        Trajet trajet = trajetService.getTrajetById(id);
        ExceptionUtil.throwExceptionOnObjectNull(trajet);

        // Existing code...
        List<LigneDetail> ligneDetails = ligneService.getLigneDetailList(trajet.getLigne().getId());
        List<TrajetReservation> reservations = reservationService.getReservationsByTrajetId(id);
        double placesPrises = reservationService.getPlacesPrisesForTrajet(id);
        double placesRestantes = trajet.getVehicule().getMaximumPassager() - placesPrises;
        double caPrevisionnel = reservationService.getCAprevisionnel(id);
        List<Client> clients = clientService.getAllClients();
        List<TypeObjectDTO> reservationStatuts = typeObjectService.findAllTypeObject("Reservation_Statut");

        // NEW: Load tarif remises for this trajet
        TarifRemiseService tarifRemiseService = new TarifRemiseService();
        List<TrajetTarifTypePlaceCategorieRemise> tarifRemises = tarifRemiseService.getTarifRemisesByTrajet(id);
        List<TrajetRemisePourcentage> remisePourcentages = tarifRemiseService.getRemisePourcentagesByTrajet(id);

        // NEW: Load reference data for remise forms
        VehiculeService vehiculeService = new VehiculeService();
        List<VehiculeTarifTypePlace> vehiculeTarifs = vehiculeService.getTarifTypePlacesByVehicule(trajet.getVehicule().getId());
        List<TypeObjectDTO> categories = typeObjectService.findAllTypeObject("Categorie_Personne");

        // NEW: Handle edit actions
        if ("editTarifRemise".equals(action)) {
            String remiseIdStr = req.getParameter("remiseId");
            if (remiseIdStr != null && !remiseIdStr.isEmpty()) {
                TrajetTarifTypePlaceCategorieRemise editRemise = tarifRemiseService.getTarifRemiseById(Long.valueOf(remiseIdStr));
                req.setAttribute("editTarifRemise", editRemise);
            }
        } else if ("editRemisePourcent".equals(action)) {
            String pourcentIdStr = req.getParameter("pourcentId");
            if (pourcentIdStr != null && !pourcentIdStr.isEmpty()) {
                TrajetRemisePourcentage editPourcent = tarifRemiseService.getRemisePourcentById(Long.valueOf(pourcentIdStr));
                req.setAttribute("editRemisePourcent", editPourcent);
            }
        }

        // Set all attributes
        req.setAttribute("trajet", trajet);
        req.setAttribute("placesPrises", placesPrises);
        req.setAttribute("placesRestantes", placesRestantes);
        req.setAttribute("reservations", reservations);
        req.setAttribute("clients", clients);
        req.setAttribute("reservationStatuts", reservationStatuts);
        req.setAttribute("ligneDetails", ligneDetails);
        req.setAttribute("caPrevisionnel", caPrevisionnel);

        // NEW attributes
        req.setAttribute("tarifRemises", tarifRemises);
        req.setAttribute("remisePourcentages", remisePourcentages);
        req.setAttribute("vehiculeTarifs", vehiculeTarifs);
        req.setAttribute("categories", categories);

        req.getRequestDispatcher("/trajet-detail.jsp").forward(req, resp);
    }
}
// Add this TrajetServlet to servlets.txt

package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.TypeObjectDTO;
import com.mdgtaxi.entity.*;
import com.mdgtaxi.service.*;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.*;

@WebServlet("/trajets")
public class TrajetServlet extends HttpServlet {

    private final TrajetService trajetService = new TrajetService();
    private final LigneService ligneService = new LigneService(); // Assume exists
    private final ChauffeurService chauffeurService = new ChauffeurService();
    private final VehiculeService vehiculeService = new VehiculeService();
    private final TypeObjectService typeObjectService = new TypeObjectService();
    private final ClientService clientService = new ClientService(); // Assume exists

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");
        String idStr = req.getParameter("id");
        Long id = idStr != null && !idStr.isEmpty() ? Long.valueOf(idStr) : null;

        loadReferenceData(req);

        if ("edit".equals(action)) {
            if (id != null) {
                Trajet trajet = trajetService.getTrajetById(id);
                req.setAttribute("trajet", trajet);
            }
        } else if ("detail".equals(action)) {
            if (id != null) {
                handleDetail(req, id);
                req.getRequestDispatcher("/trajet-detail.jsp").forward(req, resp);
                return;
            }
        }

        // Filters
        Map<String, Object> filters = collectFilters(req);

        List<Trajet> trajets = filters.isEmpty() ? trajetService.getAllTrajets() : trajetService.searchTrajetsWithFilters(filters); // Assume method
        req.setAttribute("trajets", trajets);

        req.getRequestDispatcher("/trajets.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");
        String idStr = req.getParameter("id");
        Long id = idStr != null && !idStr.isEmpty() ? Long.valueOf(idStr) : null;

        try {
            if (action == null || "save".equals(action)) {
                Trajet trajet = buildTrajetFromRequest(req);
                trajet = trajetService.createTrajet(trajet); // Assume method
                resp.sendRedirect(req.getContextPath() + "/trajets");
            } else {
                resp.sendRedirect(req.getContextPath() + "/trajets");
            }
        } catch (Exception e) {
            req.setAttribute("error", "Erreur: " + e.getMessage());
            if (id != null) {
                handleDetail(req, id);
                req.getRequestDispatcher("/trajet-detail.jsp").forward(req, resp);
            } else {
                req.getRequestDispatcher("/trajets.jsp").forward(req, resp);
            }
        }
    }

    private void loadReferenceData(HttpServletRequest req) {
        List<Ligne> lignes = ligneService.getAllLignes(); // Assume method
        List<Chauffeur> chauffeurs = chauffeurService.getAllChauffeurs();
        List<Vehicule> vehicules = vehiculeService.getAllVehicules();
        List<TypeObjectDTO> trajetStatuts = typeObjectService.findAllTypeObject("Trajet_Statut");
        List<Client> clients = clientService.getAllClients(); // For new reservation
        List<TypeObjectDTO> reservationStatuts = typeObjectService.findAllTypeObject("Reservation_Statut");

        req.setAttribute("lignes", lignes);
        req.setAttribute("chauffeurs", chauffeurs);
        req.setAttribute("vehicules", vehicules);
        req.setAttribute("trajetStatuts", trajetStatuts);
        req.setAttribute("clients", clients);
        req.setAttribute("reservationStatuts", reservationStatuts);
    }

    private Map<String, Object> collectFilters(HttpServletRequest req) {
        Map<String, Object> filters = new HashMap<>();

        String ligneId = req.getParameter("ligneId");
        if (ligneId != null && !ligneId.isEmpty()) filters.put("ligne.id", Long.valueOf(ligneId));

        String chauffeurId = req.getParameter("chauffeurId");
        if (chauffeurId != null && !chauffeurId.isEmpty()) filters.put("chauffeur.id", Long.valueOf(chauffeurId));

        String vehiculeId = req.getParameter("vehiculeId");
        if (vehiculeId != null && !vehiculeId.isEmpty()) filters.put("vehicule.id", Long.valueOf(vehiculeId));

        String statutId = req.getParameter("statutId");
        if (statutId != null && !statutId.isEmpty()) filters.put("trajetStatut.id", Long.valueOf(statutId));

        String startDateStr = req.getParameter("startDate");
        if (startDateStr != null && !startDateStr.isEmpty()) filters.put("datetimeDepart >= ", LocalDate.parse(startDateStr).atStartOfDay());

        String endDateStr = req.getParameter("endDate");
        if (endDateStr != null && !endDateStr.isEmpty()) filters.put("datetimeDepart <= ", LocalDate.parse(endDateStr).atTime(23, 59, 59));

        return filters;
    }

    private void handleDetail(HttpServletRequest req, Long id) {
        Trajet trajet = trajetService.getTrajetById(id);
        req.setAttribute("trajet", trajet);

        Vehicule vehicule = trajet.getVehicule();
        List<VehiculeTarifTypePlace> tarifPlaces = vehiculeService.getTarifTypePlacesByVehicule(vehicule.getId());
        req.setAttribute("tarifPlaces", tarifPlaces);


        List<TrajetTarifTypePlaceCategorieRemise> trajetTarifTypePlaceCategorieRemises = trajetService.getTarifTypePlaceCategorieRemisesByTrajetId(id);
        req.setAttribute("tarifTypePlaceCategorieRemises", trajetTarifTypePlaceCategorieRemises);


        Map<Long, Double> soldPerType = trajetService.getSoldPlacesPerType(id);
        req.setAttribute("soldPerType", soldPerType);

        List<TrajetReservation> reservations = trajetService.getReservationsByTrajet(id);
        req.setAttribute("reservations", reservations);

        // Other data like clients, reservationStatuts already loaded in loadReferenceData
    }

    private Trajet buildTrajetFromRequest(HttpServletRequest req) {
        String idStr = req.getParameter("id");
        Trajet trajet = (idStr != null && !idStr.isEmpty()) ? trajetService.getTrajetById(Long.valueOf(idStr)) : new Trajet();

        Ligne ligne = new Ligne();
        ligne.setId(Long.valueOf(req.getParameter("idLigne")));
        trajet.setLigne(ligne);

        Chauffeur chauffeur = new Chauffeur();
        chauffeur.setId(Long.valueOf(req.getParameter("idChauffeur")));
        trajet.setChauffeur(chauffeur);

        Vehicule vehicule = new Vehicule();
        vehicule.setId(Long.valueOf(req.getParameter("idVehicule")));
        trajet.setVehicule(vehicule);

        trajet.setDatetimeDepart(LocalDateTime.parse(req.getParameter("datetimeDepart")));

        String datetimeArriveeStr = req.getParameter("datetimeArrivee");
        if (datetimeArriveeStr != null && !datetimeArriveeStr.isEmpty()) {
            trajet.setDatetimeArrivee(LocalDateTime.parse(datetimeArriveeStr));
        }

        TrajetStatut statut = new TrajetStatut();
        statut.setId(Long.valueOf(req.getParameter("idTrajetStatut")));
        trajet.setTrajetStatut(statut);

        return trajet;
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.MouvementStatusDto;
import com.mdgtaxi.dto.StatusObjectDto;
import com.mdgtaxi.entity.*;
import com.mdgtaxi.service.MouvementStatusCreateService;
import com.mdgtaxi.service.MouvementStatusService;
import com.mdgtaxi.service.StatusService;
import com.mdgtaxi.service.VehiculeService;
import com.mdgtaxi.view.VmVehiculeCoutEntretien;
import com.mdgtaxi.view.VmVehiculeDetail;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;

@WebServlet("/vehicules/detail")
public class VehiculeDetailServlet extends HttpServlet {

    private final VehiculeService vehiculeService = new VehiculeService();
    private final MouvementStatusService mouvementStatusService = new MouvementStatusService();
    private final MouvementStatusCreateService mouvementStatusCreateService = new MouvementStatusCreateService();
    private final StatusService statusService = new StatusService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String idParam = req.getParameter("id");

        if (idParam == null || idParam.isEmpty()) {
            resp.sendRedirect(req.getContextPath() + "/vehicules");
            return;
        }

        Long id = Long.parseLong(idParam);
        loadVehiculeDetails(req, id);

        req.getRequestDispatcher("/vehicule-detail.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");
        String idParam = req.getParameter("id");

        if (idParam == null || idParam.isEmpty()) {
            resp.sendRedirect(req.getContextPath() + "/vehicules");
            return;
        }

        Long id = Long.parseLong(idParam);

        try {
            if ("changeStatut".equals(action)) {
                handleChangeStatut(req, id);
            } else if ("addEntretien".equals(action)) {
                handleAddEntretien(req, id);
            } else if ("addTarifPlace".equals(action)) {  // NEW: Handle add
                handleAddTarifPlace(req, id);
            } else if ("updateTarifPlace".equals(action)) {  // NEW: Handle update
                handleUpdateTarifPlace(req, id);
            } else if ("deleteTarifPlace".equals(action)) {  // NEW: Handle delete
                handleDeleteTarifPlace(req, id);
            }

            resp.sendRedirect(req.getContextPath() + "/vehicules/detail?id=" + id);
        } catch (Exception e) {
            e.printStackTrace();
            req.setAttribute("error", "Erreur: " + e.getMessage());
            loadVehiculeDetails(req, id);
            req.getRequestDispatcher("/vehicule-detail.jsp").forward(req, resp);
        }
    }


    private void handleAddTarifPlace(HttpServletRequest req, Long vehiculeId) throws Exception {
        VehiculeTarifTypePlace vttp = new VehiculeTarifTypePlace();
        Vehicule vehicule = new Vehicule();
        vehicule.setId(vehiculeId);
        vttp.setVehicule(vehicule);

        Long typePlaceId = Long.parseLong(req.getParameter("typePlaceId"));
        TypePlace typePlace = new TypePlace();
        typePlace.setId(typePlaceId);
        vttp.setTypePlace(typePlace);

        vttp.setNombrePlace(Double.parseDouble(req.getParameter("nombrePlace")));
        vttp.setTarifUnitaire(Double.parseDouble(req.getParameter("tarifUnitaire")));

        vehiculeService.createOrUpdateTarifTypePlace(vttp);
    }

    private void handleUpdateTarifPlace(HttpServletRequest req, Long vehiculeId) throws Exception  {
        Long vttpId = Long.parseLong(req.getParameter("vttpId"));
        VehiculeTarifTypePlace vttp = vehiculeService.getTarifTypePlaceById(vttpId);  // Assume you add this method to VehiculeService
        if (vttp == null || !vttp.getVehicule().getId().equals(vehiculeId)) {
            throw new IllegalArgumentException("Invalid TarifTypePlace ID");
        }

        Long typePlaceId = Long.parseLong(req.getParameter("typePlaceId"));
        TypePlace typePlace = new TypePlace();
        typePlace.setId(typePlaceId);
        vttp.setTypePlace(typePlace);

        vttp.setNombrePlace(Double.parseDouble(req.getParameter("nombrePlace")));
        vttp.setTarifUnitaire(Double.parseDouble(req.getParameter("tarifUnitaire")));

        vehiculeService.createOrUpdateTarifTypePlace(vttp);
    }

    private void handleDeleteTarifPlace(HttpServletRequest req, Long vehiculeId) {
        Long vttpId = Long.parseLong(req.getParameter("vttpId"));
        VehiculeTarifTypePlace vttp = vehiculeService.getTarifTypePlaceById(vttpId);
        if (vttp == null || !vttp.getVehicule().getId().equals(vehiculeId)) {
            throw new IllegalArgumentException("Invalid TarifTypePlace ID");
        }
        vehiculeService.deleteTarifTypePlace(vttpId);  // Assume you add this method to VehiculeService
    }

    private void loadVehiculeDetails(HttpServletRequest req, Long id) {
        // Load vehicle detail
        VmVehiculeDetail detail = vehiculeService.getVehiculeDetail(id);
        req.setAttribute("detail", detail);

        // Load maintenance cost
        VmVehiculeCoutEntretien cout = vehiculeService.getCoutEntretien(id);
        req.setAttribute("cout", cout);

        // Load maintenance history
        List<VehiculeEntretien> entretiens = vehiculeService.getEntretiensByVehicule(id);
        req.setAttribute("entretiens", entretiens);

        // Load current status
        MouvementStatusDto currentStatus = mouvementStatusService.getCurrentStatus("Vehicule", id);
        req.setAttribute("currentStatus", currentStatus);

        // Load status history
        List<MouvementStatusDto> statusHistory = mouvementStatusService.getStatusHistory("Vehicule", id);
        req.setAttribute("statusHistory", statusHistory);

        // Load available statuses
        List<StatusObjectDto> availableStatuts = statusService.findAllStatuses("Vehicule");
        req.setAttribute("availableStatuts", availableStatuts);

        List<VehiculeTarifTypePlace> tarifPlaces = vehiculeService.getTarifTypePlacesByVehicule(id);
        req.setAttribute("tarifPlaces", tarifPlaces);

        double maxCA = vehiculeService.getTotalMaxChiffreAffairePossible(id);
        req.setAttribute("maxCA", maxCA);

        List<TypePlace> typePlaces = vehiculeService.getAllTypePlaces();
        req.setAttribute("typePlaces", typePlaces);
    }

    private void handleChangeStatut(HttpServletRequest req, Long vehiculeId) {
        Long idStatut = Long.valueOf(req.getParameter("idStatut"));
        String observation = req.getParameter("observation");
        String dateChangementStr = req.getParameter("dateChangement");

        LocalDateTime dateChangement;
        if (dateChangementStr != null && !dateChangementStr.isEmpty()) {
            dateChangement = LocalDateTime.parse(dateChangementStr);
        } else {
            dateChangement = LocalDateTime.now();
        }

        mouvementStatusCreateService.createMouvementStatut(
                "Vehicule",
                vehiculeId,
                idStatut,
                dateChangement,
                observation
        );
    }

    private void handleAddEntretien(HttpServletRequest req, Long vehiculeId) {
        VehiculeEntretien entretien = new VehiculeEntretien();

        com.mdgtaxi.entity.Vehicule vehicule = new com.mdgtaxi.entity.Vehicule();
        vehicule.setId(vehiculeId);
        entretien.setVehicule(vehicule);

        entretien.setMotif(req.getParameter("motif"));
        entretien.setMontantDepense(new BigDecimal(req.getParameter("montantDepense")));

        String dateDebutStr = req.getParameter("dateDebutEntretien");
        if (dateDebutStr != null && !dateDebutStr.isEmpty()) {
            entretien.setDateDebutEntretien(LocalDateTime.parse(dateDebutStr));
        } else {
            entretien.setDateDebutEntretien(LocalDateTime.now());
        }

        String dateFinStr = req.getParameter("dateFinEntretien");
        if (dateFinStr != null && !dateFinStr.isEmpty()) {
            entretien.setDateFinEntretien(LocalDateTime.parse(dateFinStr));
        }

        vehiculeService.addEntretien(entretien);
    }
}
package com.mdgtaxi.servlet;

import com.mdgtaxi.dto.MouvementStatusDto;
import com.mdgtaxi.dto.StatusObjectDto;
import com.mdgtaxi.dto.TypeObjectDTO;
import com.mdgtaxi.entity.CarburantType;
import com.mdgtaxi.entity.TypePlace;
import com.mdgtaxi.entity.Vehicule;
import com.mdgtaxi.entity.VehiculeEntretien;
import com.mdgtaxi.entity.VehiculeTarifTypePlace;
import com.mdgtaxi.entity.VehiculeType;
import com.mdgtaxi.service.MouvementStatusCreateService;
import com.mdgtaxi.service.MouvementStatusService;
import com.mdgtaxi.service.StatusService;
import com.mdgtaxi.service.TypeObjectService;
import com.mdgtaxi.service.VehiculeService;
import com.mdgtaxi.view.VmVehiculeCoutEntretien;
import com.mdgtaxi.view.VmVehiculeDetail;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import java.io.IOException;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@WebServlet("/vehicules")
public class VehiculeServlet extends HttpServlet {

    private final VehiculeService vehiculeService = new VehiculeService();
    private final TypeObjectService typeObjectService = new TypeObjectService();
    private final MouvementStatusService mouvementStatusService = new MouvementStatusService();
    private final MouvementStatusCreateService mouvementStatusCreateService = new MouvementStatusCreateService();
    private final StatusService statusService = new StatusService();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");

        // Load reference data
        loadReferenceData(req);

        if ("edit".equals(action)) {
            handleEdit(req);
            // Load tarif map for pre-filling
            String idStr = req.getParameter("id");
            if (idStr != null && !idStr.isEmpty()) {
                Long id = Long.valueOf(idStr);
                List<VehiculeTarifTypePlace> tarifPlaces = vehiculeService.getTarifTypePlacesByVehicule(id);
                Map<Long, VehiculeTarifTypePlace> tarifMap = new HashMap<>();
                for (VehiculeTarifTypePlace vttp : tarifPlaces) {
                    tarifMap.put(vttp.getTypePlace().getId(), vttp);
                }
                req.setAttribute("tarifMap", tarifMap);
            }
        } else if ("detail".equals(action)) {
            handleDetail(req, req.getParameter("id"));
            req.getRequestDispatcher("/vehicule-detail.jsp").forward(req, resp);
            return;
        }

        // Collect filters
        Map<String, Object> filters = collectFilters(req);

        // Load vehicules with filters
        List<Vehicule> vehicules = filters.isEmpty() ? vehiculeService.getAllVehicules() : vehiculeService.searchVehiculesWithFilters(filters);
        req.setAttribute("vehicules", vehicules);

        req.getRequestDispatcher("/vehicules.jsp").forward(req, resp);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String action = req.getParameter("action");
        String idStr = req.getParameter("id");
        Long id = idStr != null && !idStr.isEmpty() ? Long.valueOf(idStr) : null;

        try {
            if ("save".equals(action)) {
                Vehicule vehicule = buildVehiculeFromRequest(req);
                vehicule = vehiculeService.createVehicule(vehicule);

                // Handle dynamic tarif type places
                List<TypeObjectDTO> typePlaces = typeObjectService.findAllTypeObject("Type_Place");
                for (TypeObjectDTO type : typePlaces) {
                    Long typeId = type.getId();
                    String placesStr = req.getParameter("places_" + typeId);
                    String tarifStr = req.getParameter("tarif_" + typeId);

                    if (placesStr != null && !placesStr.trim().isEmpty()) {
                        try {
                            double nombrePlaces = Double.parseDouble(placesStr);
                            if (nombrePlaces > 0) {
                                double tarif = (tarifStr != null && !tarifStr.trim().isEmpty())
                                        ? Double.parseDouble(tarifStr)
                                        : 0.0;  // Default to 0 if not provided

                                VehiculeTarifTypePlace vttp = vehiculeService.getTarifTypePlaceByVehiculeAndType(vehicule.getId(), typeId);
                                if (vttp == null) {
                                    vttp = new VehiculeTarifTypePlace();
                                    vttp.setVehicule(vehicule);
                                    TypePlace typePlace = new TypePlace();
                                    typePlace.setId(typeId);
                                    vttp.setTypePlace(typePlace);
                                }
                                vttp.setNombrePlace(nombrePlaces);
                                vttp.setTarifUnitaire(tarif);
                                vehiculeService.createOrUpdateTarifTypePlace(vttp);
                            }
                        } catch (NumberFormatException e) {
                            // Optional: log or handle invalid input
                        }
                    }
                }

                resp.sendRedirect(req.getContextPath() + "/vehicules");
            } else if ("changeStatut".equals(action)) {
                handleChangeStatut(req, id);
                resp.sendRedirect(req.getContextPath() + "/vehicules/detail?id=" + id);
            } else if ("addEntretien".equals(action)) {
                handleAddEntretien(req, id);
                resp.sendRedirect(req.getContextPath() + "/vehicules/detail?id=" + id);
            } else {
                resp.sendRedirect(req.getContextPath() + "/vehicules");
            }
        } catch (Exception e) {
            req.setAttribute("error", "Erreur: " + e.getMessage());
            if (id != null) {
                handleDetail(req, idStr);
                req.getRequestDispatcher("/vehicule-detail.jsp").forward(req, resp);
            } else {
                loadReferenceData(req);
                req.setAttribute("vehicule", buildVehiculeFromRequest(req)); // To repopulate form
                req.getRequestDispatcher("/vehicules.jsp").forward(req, resp);
            }
        }
    }

    private void loadReferenceData(HttpServletRequest req) {
        List<TypeObjectDTO> vehiculeTypes = typeObjectService.findAllTypeObject("Vehicule_Type");
        List<TypeObjectDTO> carburantTypes = typeObjectService.findAllTypeObject("Carburant_Type");
        List<StatusObjectDto> vehiculeStatuts = statusService.findAllStatuses("Vehicule");


        List<TypePlace> typePlaces = vehiculeService.getAllTypePlaces();

        req.setAttribute("vehiculeTypes", vehiculeTypes);
        req.setAttribute("carburantTypes", carburantTypes);
        req.setAttribute("vehiculeStatuts", vehiculeStatuts);
        req.setAttribute("typePlaces", typePlaces);
    }

    private Map<String, Object> collectFilters(HttpServletRequest req) {
        Map<String, Object> filters = new HashMap<>();

        String marque = req.getParameter("filter_marque");
        if (marque != null && !marque.isEmpty()) filters.put("marque", marque);

        String modele = req.getParameter("filter_modele");
        if (modele != null && !modele.isEmpty()) filters.put("modele", modele);

        String immatriculation = req.getParameter("filter_immatriculation");
        if (immatriculation != null && !immatriculation.isEmpty()) filters.put("immatriculation", immatriculation);

        String maxPassagerStr = req.getParameter("filter_maximumPassager");
        if (maxPassagerStr != null && !maxPassagerStr.isEmpty()) {
            try {
                filters.put("maximumPassager", Integer.parseInt(maxPassagerStr));
            } catch (NumberFormatException ignored) {}
        }

        String capaciteStr = req.getParameter("filter_capaciteCarburant");
        if (capaciteStr != null && !capaciteStr.isEmpty()) {
            try {
                filters.put("capaciteCarburant", new BigDecimal(capaciteStr));
            } catch (NumberFormatException ignored) {}
        }

        String depenseStr = req.getParameter("filter_depenseCarburant100km");
        if (depenseStr != null && !depenseStr.isEmpty()) {
            try {
                filters.put("depenseCarburant100km", new BigDecimal(depenseStr));
            } catch (NumberFormatException ignored) {}
        }

        String vehType = req.getParameter("filter_vehiculeType");
        if (vehType != null && !vehType.isEmpty()) filters.put("vehiculeType.libelle", vehType);

        String carbType = req.getParameter("filter_carburantType");
        if (carbType != null && !carbType.isEmpty()) filters.put("carburantType.libelle", carbType);

        return filters;
    }

    private void handleEdit(HttpServletRequest req) {
        String idStr = req.getParameter("id");
        if (idStr != null && !idStr.isEmpty()) {
            Long id = Long.valueOf(idStr);
            Vehicule vehicule = vehiculeService.getVehiculeById(id);
            req.setAttribute("vehicule", vehicule);
        }
    }

    private void handleDetail(HttpServletRequest req, String idStr) {
        if (idStr == null || idStr.isEmpty()) return;
        Long id = Long.valueOf(idStr);

        VmVehiculeDetail detail = vehiculeService.getVehiculeDetail(id);
        req.setAttribute("detail", detail);

        VmVehiculeCoutEntretien cout = vehiculeService.getCoutEntretien(id);
        req.setAttribute("cout", cout);

        List<VehiculeEntretien> entretiens = vehiculeService.getEntretiensByVehicule(id);
        req.setAttribute("entretiens", entretiens);

        MouvementStatusDto currentStatus = mouvementStatusService.getCurrentStatus("Vehicule", id);
        req.setAttribute("currentStatus", currentStatus);

        List<MouvementStatusDto> statusHistory = mouvementStatusService.getStatusHistory("Vehicule", id);
        req.setAttribute("statusHistory", statusHistory);

        List<StatusObjectDto> availableStatuts = statusService.findAllStatuses("Vehicule");
        req.setAttribute("availableStatuts", availableStatuts);

        List<VehiculeTarifTypePlace> tarifPlaces = vehiculeService.getTarifTypePlacesByVehicule(id);
        req.setAttribute("tarifPlaces", tarifPlaces);

        double maxCA = vehiculeService.getTotalMaxChiffreAffairePossible(id);
        req.setAttribute("maxCA", maxCA);
    }

    private Vehicule buildVehiculeFromRequest(HttpServletRequest req) {
        String idStr = req.getParameter("id");
        Vehicule vehicule = (idStr != null && !idStr.isEmpty()) ? vehiculeService.getVehiculeById(Long.valueOf(idStr)) : new Vehicule();

        vehicule.setMarque(req.getParameter("marque"));
        vehicule.setModele(req.getParameter("modele"));
        vehicule.setImmatriculation(req.getParameter("immatriculation"));
        vehicule.setMaximumPassager(Integer.valueOf(req.getParameter("maximumPassager")));

        String capaciteCarburant = req.getParameter("capaciteCarburant");
        if (capaciteCarburant != null && !capaciteCarburant.isEmpty()) {
            vehicule.setCapaciteCarburant(new BigDecimal(capaciteCarburant));
        }

        String depenseCarburant100km = req.getParameter("depenseCarburant100km");
        if (depenseCarburant100km != null && !depenseCarburant100km.isEmpty()) {
            vehicule.setDepenseCarburant100km(new BigDecimal(depenseCarburant100km));
        }

        VehiculeType vehiculeType = new VehiculeType();
        vehiculeType.setId(Long.valueOf(req.getParameter("idType")));
        vehicule.setVehiculeType(vehiculeType);

        CarburantType carburantType = new CarburantType();
        carburantType.setId(Long.valueOf(req.getParameter("idTypeCarburant")));
        vehicule.setCarburantType(carburantType);

        return vehicule;
    }

    private void handleChangeStatut(HttpServletRequest req, Long vehiculeId) {
        Long idStatut = Long.valueOf(req.getParameter("idStatut"));
        String observation = req.getParameter("observation");
        String dateChangementStr = req.getParameter("dateChangement");

        LocalDateTime dateChangement = (dateChangementStr != null && !dateChangementStr.isEmpty())
                ? LocalDateTime.parse(dateChangementStr)
                : LocalDateTime.now();

        mouvementStatusCreateService.createMouvementStatut("Vehicule", vehiculeId, idStatut, dateChangement, observation);
    }

    private void handleAddEntretien(HttpServletRequest req, Long vehiculeId) {
        String motif = req.getParameter("motif");
        String montantStr = req.getParameter("montantDepense");
        String dateDebutStr = req.getParameter("dateDebutEntretien");
        String dateFinStr = req.getParameter("dateFinEntretien");

        VehiculeEntretien entretien = new VehiculeEntretien();
        Vehicule vehicule = new Vehicule();
        vehicule.setId(vehiculeId);
        entretien.setVehicule(vehicule);
        entretien.setMotif(motif);
        entretien.setMontantDepense(new BigDecimal(montantStr));

        entretien.setDateDebutEntretien((dateDebutStr != null && !dateDebutStr.isEmpty())
                ? LocalDateTime.parse(dateDebutStr)
                : LocalDateTime.now());

        if (dateFinStr != null && !dateFinStr.isEmpty()) {
            entretien.setDateFinEntretien(LocalDateTime.parse(dateFinStr));
        }

        vehiculeService.addEntretien(entretien);
    }
}
